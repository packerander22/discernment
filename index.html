<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Discernment: A Decision-Making Guide</title>

<!-- üîπ Preload the first-screen logo to avoid pop-in -->
<link rel="preload" as="image" href="./favicon_256_transparent.png">

<link rel="manifest" href="./site.webmanifest?v=4">
<meta name="theme-color" content="#ffffff">

<!-- Icons -->
<link rel="icon" type="image/svg+xml" href="./favicon_transparent.svg">
<link rel="icon" type="image/png" sizes="16x16" href="./favicon_16_transparent.png">
<link rel="icon" type="image/png" sizes="32x32" href="./favicon_32_transparent.png">
<link rel="icon" type="image/png" sizes="48x48" href="./favicon_48_transparent.png">
<link rel="icon" type="image/png" sizes="64x64" href="./favicon_64_transparent.png">
<link rel="icon" type="image/png" sizes="192x192" href="./favicon_192_transparent.png">
<link rel="icon" type="image/png" sizes="256x256" href="./favicon_256_transparent.png">
<link rel="icon" type="image/png" sizes="384x384" href="./favicon_384_transparent.png">
<link rel="icon" type="image/png" sizes="512x512" href="./favicon_512_transparent.png">
<link rel="shortcut icon" href="./favicon_transparent.ico">

<!-- iOS homescreen -->
<link rel="apple-touch-icon" sizes="180x180" href="./favicon_180_transparent.png">

<style>
  :root {
    --btn-pad-y:10px; --btn-pad-x:12px;

    /* slider custom props */
    --track-height: 8px;
    --thumb-size: 28px;
    --thumb-shadow: 0 1px 3px rgba(0,0,0,.25);
    --track-bg: #e0e0e0;
    --fill: #2d6cdf;
    --pct: 0%;
    --tick-color: rgba(0,0,0,.35);
    --tick-thickness: 2px;
    --tick-length: 6px;
  }

  body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:0; }
  .container { max-width: 650px; margin:auto; padding:20px; }
  .top-bar { display:flex; justify-content:space-between; margin-bottom:10px; }
  .card {
    background:#fff; padding:20px; border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1); min-height:280px;
    display:flex; flex-direction:column; justify-content:space-between;
  }

  /* Header */
  .segment-heading {
    display:flex; align-items:center; justify-content:space-between;
    font-size:1.8em; font-weight:bold; margin-bottom:15px; padding:8px;
    border-bottom:2px solid #ddd; gap:12px; transition: color .5s ease;
  }
  .segment-title { display:inline-flex; align-items:center; gap:8px; }
  .segment-title img.logo {
    height:1.2em; width:auto; vertical-align:middle; margin-right:6px;
    /* Reserve space immediately to avoid layout shift */
    aspect-ratio: 1 / 1;
  }
  .flash-gold { color: goldenrod !important; }
  .flash-green { color: #2e7d32 !important; }
  .flash-purple { color: #9C27B0 !important; }

  /* Buttons */
  button { flex:1; padding:var(--btn-pad-y) var(--btn-pad-x); font-size:1em; border:none; border-radius:5px; cursor:pointer; }
  button.yes { background:#4CAF50; color:#fff; }
  button.no { background:#F44336; color:#fff; }
  button.same { background:#1E88E5; color:#fff; }
  button.next { background:#2196F3; color:#fff; }
  button.back { background:#555; color:#fff; flex:0 0 auto; }
  button.restart { background:#9C27B0; color:#fff; flex:0 0 auto; }
  button.examples-btn, button.viz-btn, button.reasoning-btn { background:#9E9E9E; color:#fff; }
  .ctrl-btn { flex:1; }
  button.active { outline:2px solid #000; }

  .segment-heading .skip-btn {
    display:inline-flex; align-items:center; justify-content:center;
    flex:0 0 auto; padding:var(--btn-pad-y) var(--btn-pad-x);
    font-size:1rem; line-height:1; border:none; border-radius:5px; cursor:pointer;
    background:#e9e9e9; color:#333;
  }
  .segment-heading .skip-btn:hover { background:#dedede; }

  .text { font-size:1.3em; margin-bottom:12px; white-space:pre-wrap; }

  .controls-row { display:flex; gap:10px; margin:6px 0 18px 0; }
  .left-controls, .right-controls { flex:1; display:flex; gap:10px; }

  .panel {
    display:none; border:1px solid #eee; border-radius:6px; padding:10px; background:#fafafa;
    margin-bottom:18px;
  }
  .panel p { margin:6px 0; }
  .panel img { width:100%; height:auto; display:block; }

  .buttons { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start; }
  .buttons.center { justify-content:center; }

  /* Slider container */
  .risk-inline { display:none; border:1px solid #eee; border-radius:6px; padding:12px; background:#fafafa; margin:8px 0 18px 0; }
  .sev-display { text-align:center; font-size:1.8em; font-weight:bold; margin-bottom:8px; }
  .risk-row { display:flex; align-items:center; gap:10px; margin:0; }
  .risk-row input[type="range"] { width:100%; }
  .risk-ticks { display:block; width:100%; }

  .error { color:#B00020; font-size:0.95em; }

  /* === Slider visual customization === */
  .slider-wrap {
    position: relative;
    width: 100%;
    height: calc(var(--thumb-size) + var(--tick-length) * 2 + 8px);
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
    touch-action: pan-x;
  }

  .heat-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: var(--thumb-size);
    background: transparent;
    position: relative;
    z-index: 1;
  }

  .heat-slider::-webkit-slider-runnable-track {
    height: var(--track-height);
    border-radius: calc(var(--track-height) / 2);
    background:
      linear-gradient(to right,
        var(--fill) 0%,
        var(--fill) var(--pct),
        var(--track-bg) var(--pct),
        var(--track-bg) 100%);
  }
  .heat-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: var(--thumb-size);
    height: var(--thumb-size);
    border-radius: 50%;
    background: #fff;
    border: 2px solid #999;
    box-shadow: var(--thumb-shadow);
    margin-top: calc((var(--thumb-size) - var(--track-height)) / -2);
    cursor: pointer;
  }

  .tick-row {
    position: absolute;
    left: calc(var(--thumb-size) / 2);
    right: calc(var(--thumb-size) / 2);
    height: var(--tick-length);
    pointer-events: none;
    z-index: 0;
  }
  .tick-row.top { top: 50%; transform: translateY(calc(-50% - var(--track-height)/2 - 2px)); }
  .tick-row.bottom { top: 50%; transform: translateY(calc(-50% + var(--track-height)/2 + 2px)); }
  .tick { position: absolute; width: var(--tick-thickness); height: 100%; background: var(--tick-color); transform: translateX(-50%); }

  .heat-slider::-moz-range-track { height: var(--track-height); border-radius: calc(var(--track-height) / 2); background: var(--track-bg); }
  .heat-slider::-moz-range-progress { height: var(--track-height); border-radius: calc(var(--track-height) / 2); background: var(--fill); }
  .heat-slider::-moz-range-thumb { width: var(--thumb-size); height: var(--thumb-size); border-radius: 50%; background: #fff; border: 2px solid #999; box-shadow: var(--thumb-shadow); cursor: pointer; }

  .heat-slider::-ms-track { height: var(--track-height); border-color: transparent; color: transparent; background: transparent; }
  .heat-slider::-ms-fill-lower { background: var(--fill); border-radius: calc(var(--track-height)/2); }
  .heat-slider::-ms-fill-upper { background: var(--track-bg); border-radius: calc(var(--track-height)/2); }
  .heat-slider::-ms-thumb { width: var(--thumb-size); height: var(--thumb-size); border-radius: 50%; background: #fff; border:2px solid #999; box-shadow: var(--thumb-shadow); }
</style>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VJSYRKHSRM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-VJSYRKHSRM');
</script>
</head>
<body>
<div class="container">
  <div class="top-bar">
    <button class="back" id="backBtn" onclick="goBack()" type="button">Back</button>
    <button class="restart" id="restartTop" onclick="restart()" type="button">Restart</button>
  </div>

  <div class="card">
    <div id="segmentHeading" class="segment-heading">
      <!-- üîπ Render the logo in the initial HTML so it appears on first paint -->
      <span id="segmentTitle" class="segment-title">
        <img
          src="./favicon_256_transparent.png"
          alt="Discernment Logo"
          class="logo"
          width="256"
          height="256"
          loading="eager"
          fetchpriority="high"
          decoding="sync"
        >
        Discernment: A Decision-Making Guide
      </span>
      <button id="skipBtn" class="skip-btn" style="display:none;" title="Skip to when you should act" type="button">Skip ‚è≠</button>
    </div>

    <div>
      <div id="text" class="text"></div>

      <div class="controls-row">
        <div id="leftControlsWrapper" class="left-controls"></div>
        <div id="rightControlsWrapper" class="right-controls"></div>
      </div>

      <!-- Single shared panel for everything -->
      <div id="sharedPanel" class="panel" aria-hidden="true" role="region" aria-live="polite"></div>

      <!-- Slider area -->
      <div id="riskInline" class="risk-inline" aria-hidden="true"></div>

      <div id="errorBox" class="error" role="alert" aria-live="assertive"></div>
    </div>

    <div id="buttons" class="buttons"></div>
  </div>
</div>

<script>
/* ======= FLOW (Q0‚ÄìQ47) ======= */
var flowchart = [
  { "id": "Q0",  "type": "info",     "text": "Welcome! This flow chart guide helps you determine both <i>IF</i> and <i>WHEN</i> you should act on an issue. This will help to avoid wasting resources and time, and getting stuck in <i>analysis paralysis</i>.\nYou‚Äôll answer simple Yes/No questions (and a slider later). Answer everything to the best of your knowledge, and if you don't know something, do what you can to find out (once there aren't any other more important things to do).\nTap Next to begin.", "next": "Q1" },

  /* ===== IF YOU SHOULD ACT ===== */
  { "id": "Q1",  "type": "question", "text": "Are there any other more important things to do or think about right now?", "yes": "R1",  "no": "Q2" },
  { "id": "Q2",  "type": "question", "text": "Is there a current <i>real problem</i> or desired functional QoL (quality of life) improvement, rather than just a <i>‚Äúproblem‚Äù</i> or preference that doesn‚Äôt affect performance or outcomes?", "yes": "Q10",  "no": "Q3" },
  { "id": "Q3",  "type": "question", "text": "Is there cause for a potential <i>real problem</i>, rather than just a <i>‚Äúproblem‚Äù</i> that doesn‚Äôt affect performance or outcomes?", "yes": "Q5",  "no": "Q4" },
  { "id": "Q4",  "type": "question", "text": "Is there cause for a POTENTIAL cause for a POTENTIAL <i>real problem</i>, rather than just a <i>‚Äúproblem‚Äù</i> that doesn‚Äôt affect performance or outcomes?", "yes": "Q5",  "no": "R2" },

  { "id": "Q5",  "type": "question", "text": "Is the potential problem inevitable if left unaddressed?", "yes": "Q10",  "no": "Q6" },

  /* ==== Q6 split into trio (cost-before, cost-after, total) ==== */
  { "id": "Q6",  "type": "question", "text": "Would the expected downsides of NOT addressing this issue outweigh the expected <i>upfront</i> costs/efforts OF addressing it (for just this instance)?", "yes": "Q7", "no": "Q20" },
  { "id": "Q7",  "type": "question", "text": "Would the expected downsides of NOT addressing this issue outweigh any negative consequences that would likely arise <i>as a result</i> OF addressing it (for just this instance)?", "yes": "Q8", "no": "Q20" },
  { "id": "Q8",  "type": "question", "text": "Would the overall downsides of NOT addressing this issue outweigh the <i>combined total</i> of both the upfront costs and any resulting downsides (for just this instance)?", "yes": "Q10", "no": "Q20", "same": "Q9" },

  /* (old Q7) */
  { "id": "Q9",  "type": "question", "text": "Is the problem more likely to occur than not if left unaddressed?", "yes": "Q10",  "no": "Q20" },

  /* continue with renumbered chain */
  { "id": "Q10", "type": "question", "text": "Is there a solution (or at least partial solution) to the problem/potential problem even if it‚Äôs currently unavailable (or a means of bringing about the QoL improvement)?", "yes": "Q11",  "no": "R4" },
  { "id": "Q11", "type": "question", "text": "Can this solution or QoL improvement be <i>guaranteed</i> to be fully brought about as a result of <i>your</i> influence?", "yes": "Q14", "no": "Q12" },
  { "id": "Q12", "type": "question", "text": "Do everything in your power first to achieve the desired result, but know that past that it‚Äôs out of your hands, and <i>worrying and obsessing won‚Äôt change anything and is unhealthy</i>. Is there anything further you can do?", "yes": "Q14", "no": "Q13" },
  { "id": "Q13", "type": "question", "text": "Is there an <i>alternative solution</i> that would solve the problem (or improve QoL) in a way that‚Äôs within your control or perhaps even in a <i>better overall way</i>?", "yes": "R5",  "no": "R2" },

  { "id": "Q14", "type": "question", "text": "Does this solution or QoL improvement involve gaining information that would be <i>valuable in the future</i>?", "yes": "Q15", "no": "Q16" },
  { "id": "Q15", "type": "question", "text": "Would the <i>information alone</i> gained from doing this outweigh the downsides it would likely cause to make this happen?", "yes": "Q31", "no": "Q16" },

  /* ==== Q14 split into trio (cost-before, cost-after, total) ==== */
  { "id": "Q16", "type": "question", "text": "Would the expected benefits of addressing this issue outweigh the expected <i>upfront</i> costs/efforts of addressing it (for just this instance)?", "yes": "Q17", "no": "Q20" },
  { "id": "Q17", "type": "question", "text": "Would the expected benefits of addressing this issue outweigh any negative consequences that would likely arise <i>as a result</i> of addressing it (for just this instance)?", "yes": "Q18", "no": "Q20" },
  { "id": "Q18", "type": "question", "text": "Would the overall benefits of addressing this issue outweigh the <i>combined total</i> of both the upfront costs and any resulting downsides (for just this instance)?", "yes": "Q22", "no": "Q20", "same": "Q19" },

  { "id": "Q19", "type": "question", "text": "All things considered, would you <i>rather</i> address it than not?", "yes": "Q22", "no": "Q20" },
  { "id": "Q20", "type": "question", "text": "Is there a time further down the road that the answer to the <i>previous question</i> could be yes?", "yes": "R3", "no": "Q21" },
  { "id": "Q21", "type": "question", "text": "Is there an <i>alternative solution</i> that would solve the problem (or improve QoL) in a way that‚Äôs worth it or perhaps even in a <i>better overall way</i>?", "yes": "R5",  "no": "R2" },

  { "id": "Q22", "type": "question", "text": "Does addressing this issue involve a <i>diminishing returns</i> curve for effort applied?", "yes": "Q23", "no": "Q24" },
  { "id": "Q23", "type": "info",     "text": "Find the <i>point of diminishing returns</i> and stop there. If you tend to get absorbed in an activity, find an alternative approach that solves the problem or improves QoL <i>without the addictive pull</i> and possibly even in a <i>better overall way</i>. Treat this approach as a \"better\", more effective overall solution, and <i>ALWAYS</i> use this approach over the original if it's available; if not, you may use the original approach if needed‚Äîbut <i>only</i> with a pre-set time limit and timer, after which you must stop and re-evaluate.", "next": "Q24" },
  { "id": "Q24", "type": "question", "text": "Does addressing this issue directly involve an <i>inverted-U curve</i> for specific effort applied with an <i>objective sweet spot</i> where clear information is available to you?", "yes": "Q25", "no": "Q26" },
  { "id": "Q25", "type": "info",     "text": "Wait until there aren‚Äôt any other more important things to do, then if it‚Äôs worth it to you, find that <i>sweet spot</i>. If not, put in as much effort as you deem worth it.", "next": "Q31" },

  { "id": "Q26", "type": "question", "text": "In practice and given time, would a <i>functional difference</i>‚Äîlike in a blind test compared side by side‚Äîlikely be noticed if the issue was solved/addressed (assuming any potential future problems would occur)?", "yes": "Q27", "no": "R2" },
  { "id": "Q27", "type": "question", "text": "Would solving/addressing it help get rid of/prevent the problem (or improve QoL) in the <i>long term</i>?", "yes": "Q31", "no": "Q28" },
  { "id": "Q28", "type": "question", "text": "Would solving/addressing it help get rid of/prevent the problem (or improve QoL) in the <i>short term</i>?", "yes": "Q29", "no": "R2" },
  { "id": "Q29", "type": "question", "text": "Is it logically worth solving/addressing <i>EVERY time this situation arises</i>? (Or at least this time knowing it‚Äôs <i>temporary</i>?)", "yes": "Q31", "no": "Q30" },
  { "id": "Q30", "type": "question", "text": "Is there an <i>alternative solution</i> that would solve the problem (or improve QoL), in the long term or perhaps even in a <i>better overall way</i>?", "yes": "R5",  "no": "R2" },

  /* ===== WHEN YOU SHOULD ACT ===== */
  { "id": "Q31", "type": "question", "text": "Does this address a potential <i>future</i> problem?", "yes": "Q32", "no": "Q35" },
  { "id": "Q32", "type": "question", "text": "Does addressing this issue involve <i>preventative maintenance</i>?", "yes": "Q37", "no": "Q35" },

  /* Severity selection */
  { "id": "Q33", "type": "info",     "text": "Set the estimated catastrophic severity if you waited too long to act. (1-10)", "next": "Q34" },
  { "id": "Q34", "type": "question", "text": "Would there be <i>guaranteed clear telltale signs</i> of future functional failure before it actually happened, with a big enough window of time to address it properly in advance?", "yes": "Q46", "no": "Q47" },

  /* Availability / timing */
  { "id": "Q35", "type": "question", "text": "Is this the <i>most effective solution</i> you know of (that meets the previous criteria), assuming you could do it whenever you wanted?", "yes": "Q39", "no": "Q36" },
  { "id": "Q36", "type": "question", "text": "Have you considered <i>all better solutions</i> you know of?", "yes": "Q39", "no": "R5" },

  { "id": "Q37", "type": "question", "text": "Is this the <i>most effective solution</i> you know of (that meets the previous criteria)?", "yes": "Q33", "no": "Q38" },
  { "id": "Q38", "type": "question", "text": "Have you considered <i>all better solutions</i> you know of?", "yes": "Q33", "no": "R5" },

  { "id": "Q39", "type": "question", "text": "Is this solution <i>currently</i> available?", "yes": "Q40", "no": "Q41" },
  { "id": "Q40", "type": "question", "text": "Is there a <i>better time</i> down the road to solve/address this to <i>maximize value</i>?", "yes": "Q41", "no": "R7" },

  { "id": "Q41", "type": "question", "text": "Assuming you waited until it was available, would the expected <i>overall benefits</i> of using this solution outweigh the expected <i>overall downsides</i> of having to wait?", "yes": "Q44", "no": "Q43", "same": "Q42" },
  { "id": "Q42", "type": "question", "text": "All things considered, would you <i>rather</i> use this solution?", "yes": "Q44", "no": "Q43" },

  { "id": "Q43", "type": "question", "text": "Is there a <i>next best</i> solution you know of?", "yes": "R5",  "no": "R4" },
  { "id": "Q44", "type": "question", "text": "Is there a <i>better time</i> further down the road than when this solution is available to solve/address this to <i>maximize value</i>?", "yes": "R8",  "no": "R6" },
  { "id": "Q45", "type": "question", "text": "Is there a <i>better time</i> further down the road than at that time to solve/address this to <i>maximize value</i>?", "yes": "R8",  "no": "R6" },

  /* WHEN thresholds */
  { "id": "Q46", "type": "question", "text": "Normally you should solve/address it as soon as both of the following are true: <ul><li><i>Those telltale signs</i> indicate that failure is approaching.</li><li>The <i>estimated chance of failure</i> is nearing or greater than 50%.</li></ul>\nHowever, is there a <i>better time</i> before or after that time to solve/address this to <i>maximize value</i>?", "yes": "R8", "no": "R9" },
  { "id": "Q47", "type": "question", "text": "Normally you should solve/address it as soon as the <i>estimated chance of failure</i> is nearing or greater than 50%.\nHowever, is there a <i>better time</i> before or after that time to solve/address this to <i>maximize value</i>?", "yes": "R8", "no": "R9" },

  /* RESULTS */
  { "id": "R1",  "type": "result",   "text": "Worry about this <i>once those things are addressed</i> and the time is right." },
  { "id": "R2",  "type": "result",   "text": "<i>Don‚Äôt worry about it:)</i>" },
  { "id": "R3",  "type": "result",   "text": "If that time ever does come, re-evaluate the issue. Until then, (once there aren't any other more important things to do), consider any other solutions that could work and be worth it, or perhaps even be <i>better overall<i/>." },
  { "id": "R4",  "type": "result",   "text": "Wait until there aren‚Äôt any other more important things to do, then if it‚Äôs worth it to you, <i>find a solution or solutions</i>. If not, put in as much effort as you deem worth it." },
  { "id": "R5",  "type": "result",   "text": "Consider any other solutions, from best to worst, if you haven‚Äôt already. Run them through the chart." },
  { "id": "R6",  "type": "result",   "text": "Wait until this solution is available, then solve it once there aren‚Äôt any other more important things to do. Until then, (once there aren't any other more important things to do, and if you'd like), consider any other solutions that could also work and be worth it." },
  { "id": "R7",  "type": "result",   "text": "Address it <i>sooner than later</i>, once there aren‚Äôt any other more important things to do." },
  { "id": "R8",  "type": "result",   "text": "Wait until that better time, then solve/address it once there aren't any other more important things to do. Until then, (once there aren't any other more important things to do, and if  you'd like), consider any other solutions that could either also work and be worth it, or‚Äîin the case of preventative maintenance‚Äîmitigate consequences if failure did occur." },
  { "id": "R9",  "type": "result",   "text": "Solve/address it as soon as the criteria from the <i>previous slide</i> (before the question) are met, once there aren‚Äôt any other more important things to do. Until then, (once there aren't any other more important things to do, and if you'd like), consider any solutions that would mitigate consequences if failure did occur." }
];

/* ===== EXAMPLES (exactly two per question; no info or results) ===== */
var examples = {/* ... unchanged (your examples object) ... */};

/* ======= STATE ======= */
var currentThresholdPct = 90;
var q6TrioTotalYes = false; /* track if Q8 (third of Q6 trio) was YES */
var q9WasYes = false;       /* NEW: track if Q9 (old Q7) was YES */
var hasFlashedIf = false;
var hasFlashedWhen = false;
/* NEW: track if the previous screen shown was a result, so we can re-flash when returning */
var lastWasResult = false;
/* Cache the original header HTML so we can restore it later */
var originalTitleHTML = null;

/* ======= APP LOGIC ======= */
var historyStack = [];
var currentNode = flowchart.find(function(n){ return n.id === "Q0"; });
var currentSegment = "If You Should Act";

function getSegmentForNodeId(id) {
  if (!id || id.charAt(0) !== 'Q') return currentSegment;
  var m = /^Q(\d+)$/.exec(id);
  if (!m) return currentSegment;
  var num = parseInt(m[1], 10);
  return num >= 31 ? "When You Should Act" : "If You Should Act";
}

/* Verdict heading for results */
function setHeadingText(node) {
  var title = document.getElementById('segmentTitle');
  var skipBtn = document.getElementById('skipBtn');

  if (node.id === 'Q0') {
    // Restore the original header (logo + full title)
    if (originalTitleHTML) title.innerHTML = originalTitleHTML;
    skipBtn.style.display = 'none';
    return;
  }

  if (node.type === 'result') {
    title.textContent = "üëçüëé Verdict";
    skipBtn.style.display = 'none';
    return;
  }

  var segText = (currentSegment === "If You Should Act")
    ? "‚öñÔ∏è If You Should Act"
    : "‚è≥ When You Should Act";

  // Segment labels don‚Äôt need HTML; use textContent to avoid accidental markup
  title.textContent = segText;
  skipBtn.style.display = (currentSegment === "If You Should Act" && node.type !== 'result')
    ? 'inline-block'
    : 'none';
}

/* Flash: purple for results; green for IF, gold for WHEN */
function flashHeadingColor(targetSegment, node) {
  if (currentNode && currentNode.id === 'Q0') return;
  var headingDiv = document.getElementById('segmentHeading');

  if (node && node.type === 'result') {
    headingDiv.classList.add('flash-purple');
    setTimeout(function(){ headingDiv.classList.remove('flash-purple'); }, 1500);
    return;
  }
  var cls = (targetSegment === "If You Should Act") ? 'flash-green' : 'flash-gold';
  headingDiv.classList.add(cls);
  setTimeout(function(){ headingDiv.classList.remove(cls); }, 1500);
}

/* Close panel when changing screens */
function closeAllPanels() {
  collapseSharedPanel();
  var risk = document.getElementById('riskInline');
  if (risk) {
    risk.style.display = 'none';
    risk.setAttribute('aria-hidden','true');
  }
}

/* --- Q16 trio auto-skip hook if Q8 (Q6 total) OR Q9 (inevitability) was YES --- */
function beforeEnterNode(nextId) {
  if (nextId === 'Q16' && (q6TrioTotalYes || q9WasYes)) {
    /* Skip entire Q16‚ÄìQ18 trio straight to Q18's YES destination: Q22 */
    return 'Q22';
  }
  return nextId;
}

/* ---------- Threshold transformers for Q46/Q47 ---------- */
function transformQ46(html) {
  if (currentThresholdPct <= 0) {
    var listBlockRe = /:\s*<ul>[\s\S]*?<\/ul>/i;
    return html.replace(listBlockRe, ' there is even a <i>SMALL</i> chance of failure.');
  }
  return html.replace(/(?:nearing\s+or\s+greater\s*than\s*)?50%/gi, 'nearing or greater than ' + String(currentThresholdPct) + '%');
}
function transformQ47(html) {
  if (currentThresholdPct <= 0) {
    var probClauseRe = /the\s*<i>estimated\s+chance\s+of\s+failure<\/i>\s+is\s+nearing\s+or\s+greater\s+than\s*50%/i;
    return html.replace(probClauseRe, 'there is even a <i>SMALL</i> chance of failure');
  }
  return html.replace(/(?:nearing\s+or\s+greater\s*than\s*)?50%/gi, 'nearing or greater than ' + String(currentThresholdPct) + '%');
}

/* ---------- Slider color helpers ---------- */
function heatColorForSeverity(sev) {
  var ratio = Math.pow((sev - 1) / 9, 0.4);
  var hue = 220 * (1 - ratio);
  return 'hsl(' + Math.round(hue) + ', 100%, 50%)';
}
function updateSliderFill(slider, sev) {
  var pct = ((sev - 1) / 9) * 100;
  slider.style.setProperty('--pct', pct + '%');
  slider.style.setProperty('--fill', heatColorForSeverity(sev));
}

/* ---------- Shared panel ---------- */
function collapseSharedPanel() {
  var panel = document.getElementById('sharedPanel');
  if (panel) {
    panel.style.display = 'none';
    panel.setAttribute('aria-hidden','true');
    panel.dataset.mode = '';
    panel.innerHTML = '';
  }
  var leftWrap  = document.getElementById('leftControlsWrapper');
  var rightWrap = document.getElementById('rightControlsWrapper');

  if (leftWrap) {
    var exBtns = leftWrap.querySelectorAll('.examples-btn');
    for (var i=0;i<exBtns.length;i++) {
      exBtns[i].textContent = 'Show examples';
      exBtns[i].setAttribute('aria-expanded','false');
      exBtns[i].classList.remove('active');
    }
  }
  if (rightWrap) {
    var rBtns = rightWrap.querySelectorAll('.viz-btn, .reasoning-btn');
    for (var j=0;j<rBtns.length;j++) {
      var btn = rBtns[j];
      if (btn.classList.contains('viz-btn')) btn.textContent = 'Show visualization';
      if (btn.classList.contains('reasoning-btn')) btn.textContent = 'Show percentage reasoning';
      btn.setAttribute('aria-expanded','false');
      btn.classList.remove('active');
    }
  }
}

function openSharedPanel(panel, mode) {
  if (!panel) return;
  panel.style.display = 'block';
  panel.setAttribute('aria-hidden','false');
  panel.dataset.mode = mode;

  var leftWrap  = document.getElementById('leftControlsWrapper');
  var rightWrap = document.getElementById('rightControlsWrapper');
  var exBtn = leftWrap ? leftWrap.querySelector('.examples-btn') : null;
  var vzBtn = rightWrap ? rightWrap.querySelector('.viz-btn') : null;
  var rsBtn = rightWrap ? rightWrap.querySelector('.reasoning-btn') : null;

  if (mode === 'examples') {
    if (exBtn) exBtn.textContent = 'Hide examples';
    if (vzBtn) vzBtn.textContent = 'Show visualization';
    if (rsBtn) rsBtn.textContent = 'Show percentage reasoning';
  } else if (mode === 'viz') {
    if (vzBtn) vzBtn.textContent = 'Hide visualization';
    if (exBtn) exBtn.textContent = 'Show examples';
  } else if (mode === 'reason') {
    if (rsBtn) rsBtn.textContent = 'Hide percentage reasoning';
    if (exBtn) exBtn.textContent = 'Show examples';
  }
}

/* ---------- Controls under the text ---------- */
function setupAuxToggles(node) {
  var leftWrap = document.getElementById('leftControlsWrapper');
  var rightWrap = document.getElementById('rightControlsWrapper');
  var panel = document.getElementById('sharedPanel');

  leftWrap.innerHTML = '';
  rightWrap.innerHTML = '';
  collapseSharedPanel();

  // Only show controls for questions
  if (node.type !== 'question') return;

  // LEFT: Examples (always for questions)
  var examplesBtn = document.createElement('button');
  examplesBtn.type = 'button';
  examplesBtn.textContent = 'Show examples';
  examplesBtn.className = 'examples-btn ctrl-btn';
  examplesBtn.setAttribute('aria-expanded', 'false');
  leftWrap.appendChild(examplesBtn);

  examplesBtn.onclick = function() {
    var isOpenExamples = panel.style.display === 'block' && panel.dataset.mode === 'examples';
    if (isOpenExamples) {
      collapseSharedPanel();
    } else {
      panel.innerHTML = '';
      renderExamples(panel, node.id);
      openSharedPanel(panel, 'examples');
      examplesBtn.setAttribute('aria-expanded','true');
      examplesBtn.classList.add('active');
    }
  };

  // RIGHT: Only one graph/logic button per applicable slide
  if (node.id === 'Q22' || node.id === 'Q24') {
    var vizBtn = document.createElement('button');
    vizBtn.type = 'button';
    vizBtn.textContent = 'Show visualization';
    vizBtn.className = 'viz-btn ctrl-btn';
    vizBtn.setAttribute('aria-expanded', 'false');
    rightWrap.appendChild(vizBtn);

    vizBtn.onclick = function() {
      var isOpenViz = panel.style.display === 'block' && panel.dataset.mode === 'viz';
      var src = node.id === 'Q22' ? './diminishing_returns_curve.png' : './inverted_u_curve.png';
      var alt = node.id === 'Q22'
        ? 'Diminishing Returns Curve: Effort/Resources vs Functional Results'
        : 'Inverted-U Curve: Effort/Resources vs Functional Results';
      if (isOpenViz) {
        collapseSharedPanel();
      } else {
        panel.innerHTML = '';
        renderViz(panel, src, alt);
        openSharedPanel(panel, 'viz');
        vizBtn.setAttribute('aria-expanded','true');
        vizBtn.classList.add('active');
      }
    };
  } else if (node.id === 'Q46' || node.id === 'Q47') {
    var reasonBtn = document.createElement('button');
    reasonBtn.type = 'button';
    reasonBtn.textContent = 'Show percentage reasoning';
    reasonBtn.className = 'reasoning-btn ctrl-btn';
    reasonBtn.setAttribute('aria-expanded','false');
    rightWrap.appendChild(reasonBtn);

    reasonBtn.onclick = function() {
      var isOpenReason = panel.style.display === 'block' && panel.dataset.mode === 'reason';
      if (isOpenReason) {
        collapseSharedPanel();
      } else {
        panel.innerHTML = '';
        var p = document.createElement('p');
        p.textContent = 'Your current threshold is ' + currentThresholdPct + '%.';
        panel.appendChild(p);
        var img = document.createElement('img');
        img.src = './linear_threshold_chart.png';
        img.alt = 'Linear Severity to Action Threshold: Threshold = 100% ‚àí (Severity √ó 10%)';
        panel.appendChild(img);

        openSharedPanel(panel, 'reason');
        reasonBtn.setAttribute('aria-expanded','true');
        reasonBtn.classList.add('active');
      }
    };
  }
}

function renderExamples(panel, nodeId) {
  panel.innerHTML = '';
  var lines = (window.examples && window.examples[nodeId]) || ["Example 1: [edit me]", "Example 2: [edit me]"];
  for (var i=0;i<lines.length;i++) {
    var p = document.createElement('p');
    p.textContent = lines[i];
    panel.appendChild(p);
  }
}
function renderViz(panel, src, alt) {
  panel.innerHTML = '';
  var img = document.createElement('img'); img.src = src; img.alt = alt;
  panel.appendChild(img);
}

/* ---------- Q33 slider with haptics, heat fill, and OUTSIDE ticks ---------- */
var lastVibeTs = 0;
function hapticBump() {
  if (!('vibrate' in navigator)) return;
  var mq = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)');
  if (mq && mq.matches) return;

  var now = Date.now();
  if (now - lastVibeTs < 80) return;
  navigator.vibrate(10);
  lastVibeTs = now;
}

function createTickRow(className, parent) {
  var row = document.createElement('div');
  row.className = 'tick-row ' + className;
  for (var i=1;i<=10;i++){
    var tick = document.createElement('div');
    tick.className = 'tick';
    var pct = ((i - 1) / 9) * 100;
    tick.style.left = pct + '%';
    row.appendChild(tick);
  }
  parent.appendChild(row);
  return row;
}

function showOrHideRiskInline(node) {
  var container = document.getElementById('riskInline');
  container.innerHTML = '';
  if (!node || node.id !== 'Q33') {
    container.style.display = 'none';
    container.setAttribute('aria-hidden','true');
    return;
  }
  container.style.display = 'block';
  container.setAttribute('aria-hidden','false');

  var sevDisplay = document.createElement('div');
  sevDisplay.className = 'sev-display';
  sevDisplay.id = 'sevDisplay';
  sevDisplay.textContent = '1';
  container.appendChild(sevDisplay);

  var row = document.createElement('div'); row.className = 'risk-row';

  var wrap = document.createElement('div');
  wrap.className = 'slider-wrap';

  var slider = document.createElement('input');
  slider.type = 'range'; slider.min = '1'; slider.max = '10'; slider.step = '1';
  slider.className = 'heat-slider';
  slider.setAttribute('list','riskTicks');
  slider.value = '1';

  createTickRow('top', wrap);
  wrap.appendChild(slider);
  createTickRow('bottom', wrap);

  row.appendChild(wrap);
  container.appendChild(row);

  var ticks = document.createElement('datalist');
  ticks.id = 'riskTicks';
  for (var i=1;i<=10;i++){ var opt=document.createElement('option'); opt.value=String(i); ticks.appendChild(opt); }
  container.appendChild(ticks);

  function applyFromSeverity(sev) {
    var thr = 100 - sev * 10;
    currentThresholdPct = thr;
    sevDisplay.textContent = String(sev);
    updateSliderFill(slider, sev);

    if (currentNode && (currentNode.id === 'Q46' || currentNode.id === 'Q47')) {
      var textDiv = document.getElementById('text');
      var html = currentNode.text || '';
      html = currentNode.id === 'Q46' ? transformQ46(html) : transformQ47(html);
      textDiv.innerHTML = '<div class="result-text">' + html + '</div>';
    }
  }

  applyFromSeverity(1);

  slider.oninput = function() {
    var sev = parseInt(slider.value, 10);
    applyFromSeverity(sev);
    hapticBump();
  };
}

/* ---------- Nav ---------- */
function makeButton(label, cls, action) {
  var btn = document.createElement('button');
  btn.type = 'button';
  btn.textContent = label; btn.className = cls; btn.onclick = action; return btn;
}
function goToNode(id) {
  closeAllPanels();

  /* track Q8 (third of Q6 trio) YES */
  if (currentNode && currentNode.id === 'Q8' && id === currentNode.yes) {
    q6TrioTotalYes = true;
  }
  /* track Q9 YES (old Q7 inevitability) */
  if (currentNode && currentNode.id === 'Q9' && id === currentNode.yes) {
    q9WasYes = true;
  }

  var adjustedId = beforeEnterNode(id);
  var next = flowchart.find(function(n){ return n.id === adjustedId; });
  historyStack.push(currentNode ? currentNode.id : '');
  currentNode = next; renderNode(currentNode);
}
function goBack() {
  closeAllPanels();
  var prevId = historyStack.pop();
  var prev = flowchart.find(function(n){ return n.id === prevId; });
  currentNode = prev || currentNode; renderNode(currentNode);
}
function restart() {
  closeAllPanels();
  historyStack = [];
  currentSegment = "If You Should Act";
  currentNode = flowchart.find(function(n){ return n.id === "Q0"; });
  q6TrioTotalYes = false;
  q9WasYes = false;
  hasFlashedIf = false;
  hasFlashedWhen = false;
  lastWasResult = false;

  // Restore header before render, in case anything reads it early
  if (originalTitleHTML) {
    document.getElementById('segmentTitle').innerHTML = originalTitleHTML;
    document.getElementById('skipBtn').style.display = 'none';
  }

  renderNode(currentNode);
}

/* Skip to first WHEN screen (Q31) */
document.getElementById('skipBtn').addEventListener('click', function() {
  closeAllPanels();
  goToNode('Q31');
});

/* ---------- Render ---------- */
/* Initial render */
if (!originalTitleHTML) {
  originalTitleHTML = document.getElementById('segmentTitle').innerHTML;
}
renderNode(currentNode);
function renderNode(node) {
  closeAllPanels();

  var errorBox = document.getElementById('errorBox');
  errorBox.textContent = '';

  if (!node) {
    errorBox.textContent = "Error: Could not render this step (missing node). Check JSON IDs and links.";
    document.getElementById('text').textContent = '';
    document.getElementById('buttons').innerHTML = '';
    setHeadingText('');
    document.getElementById('backBtn').style.visibility = historyStack.length > 0 ? 'visible' : 'hidden';
    document.getElementById('restartTop').style.display = 'inline-block';
    return;
  }

  if (node.id === 'Q0') {
    hasFlashedIf = false;
  }

  var previousSegment = currentSegment;
  var thisSegment = getSegmentForNodeId(node.id);

  /* Force a re-flash of IF/WHEN after any result screen */
  var comingFromResult = lastWasResult && node.type !== 'result';

  var shouldFlash =
    node.id !== 'Q0' && (
      node.type === 'result' ||
      comingFromResult ||
      thisSegment !== previousSegment ||
      (thisSegment === "If You Should Act" && !hasFlashedIf) ||
      (thisSegment === "When You Should Act" && !hasFlashedWhen)
    );

  if (shouldFlash) {
    flashHeadingColor(thisSegment, node);
    if (thisSegment === "If You Should Act") hasFlashedIf = true;
    if (thisSegment === "When You Should Act") hasFlashedWhen = true;
  }

  /* Update segment and heading */
  currentSegment = thisSegment;
  setHeadingText(node);

  /* Track whether this node is a result to drive next flash behavior */
  lastWasResult = (node.type === 'result');

  var textDiv = document.getElementById('text');
  var displayHTML = node.text || '';
  if (node.id === 'Q46') {
    displayHTML = transformQ46(displayHTML);
    textDiv.innerHTML = '<div class="result-text">' + displayHTML + '</div>';
  } else if (node.id === 'Q47') {
    displayHTML = transformQ47(displayHTML);
    textDiv.innerHTML = '<div class="result-text">' + displayHTML + '</div>';
  } else {
    textDiv.innerHTML = displayHTML;
  }

  document.getElementById('backBtn').style.visibility = historyStack.length > 0 ? 'visible' : 'hidden';

  setupAuxToggles(node);
  showOrHideRiskInline(node);

  var btns = document.getElementById('buttons');
  btns.innerHTML = '';

  const restartTop = document.getElementById('restartTop');

  if (node.type === 'result') {
    restartTop.style.display = 'none';
    btns.classList.add('center');
    const restartCentered = makeButton('Restart', 'restart', () => restart());
    restartCentered.style.flex = '0 0 auto';
    btns.appendChild(restartCentered);
  } else {
    restartTop.style.display = (node.id === 'Q0') ? 'none' : 'inline-block';
    btns.classList.remove('center');

    if (node.type === 'question') {
      const yesBtn = makeButton('Yes', 'yes', () => goToNode(node.yes));
      const noBtn  = makeButton('No',  'no',  () => goToNode(node.no));
      btns.appendChild(yesBtn);
      btns.appendChild(noBtn);
      if (node.same) btns.appendChild(makeButton('Roughly the same', 'same', () => goToNode(node.same)));
    } else if (node.type === 'info') {
      btns.appendChild(makeButton('Next', 'next', () => goToNode(node.next)));
    }
  }
}

/* Initial render */
renderNode(currentNode);
</script>
</body>
</html>