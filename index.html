<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Decision Helper</title>
<style>
  :root{--bg:#0f172a;--panel:#111827;--ink:#e5e7eb;--muted:#9ca3af;--accent:#60a5fa;--ok:#22c55e;--no:#ef4444;--line:#374151;}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  .container{max-width:1000px;margin:28px auto;padding:0 16px;}
  .tabbar{display:flex;gap:10px;margin-bottom:16px}
  .tab{padding:8px 12px;border-radius:10px;border:1px solid #2b3443;background:#1f2937;cursor:pointer}
  .tab.active{background:#2563eb;border-color:#2563eb}
  .card{background:var(--panel);border-radius:12px;padding:16px;border:1px solid #1f2937;box-shadow:0 2px 16px rgba(0,0,0,.25);}
  h2{margin:0 0 10px 0}
  .mini-fields{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
  .mini-field{display:flex;flex-direction:column;gap:6px}
  label{font-size:.95rem}
  .muted{opacity:.55}
  .hidden{display:none}
  .hint{color:var(--muted);font-size:.9rem}
  input[type="number"], select{background:#0b1220;border:1px solid #1f2937;color:var(--ink);padding:10px;border-radius:10px;outline:none}
  input[type="checkbox"]{transform:translateY(1px)}
  .center{display:flex;justify-content:center}
  .ctrl-btn{cursor:pointer;background:#1f2937;border:1px solid #2b3443;color:var(--ink);padding:8px 12px;border-radius:10px}
  .btn.next{background:#2563eb;border-color:#2563eb}
  .btn.back{background:#374151;border-color:#374151}
  .btn.small{padding:6px 10px;font-size:.9rem}
  .foot{margin-top:12px;display:flex;gap:10px;justify-content:flex-end}
  svg{width:100%;height:420px;background:#0b1220;border-radius:10px;border:1px solid #1f2937}
  .verdict{margin-top:8px;font-weight:600}
  .verdict.ok{color:var(--ok)} .verdict.no{color:var(--no)}
  @media (max-width:640px){.mini-fields{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="tabbar">
    <div class="tab active" data-page="q6">Q6 • Decide</div>
    <div class="tab" data-page="q7">Q7 • Explore</div>
    <div class="tab" data-page="ab2">AB2 • How it works</div>
  </div>

  <!-- Q6 -->
  <section id="q6" class="panel">
    <h2>Should I act?</h2>
    <div class="center" style="margin-bottom:10px">
      <div class="mini-field" style="min-width:240px; width:100%">
        <label>Total instances (N)</label>
        <input id="N" type="number" min="1" step="1" value="1">
      </div>
    </div>

    <div class="mini-fields" id="q6Fields">
      <!-- Severity -->
      <div class="mini-field">
        <label>Severity (S) — up to 10 <span class="hint">| avg per instance</span></label>
        <div class="hint" id="sevRow"><input id="tgSev" type="checkbox"> varies across instances</div>
        <input id="S" type="number" min="0" max="10" step="0.01" placeholder="e.g. 5">
        <div id="sevExtra" class="mini-field hidden">
          <div class="hint">Total extra severity across outliers (sum)</div>
          <input id="Sextra" type="number" step="any" placeholder="e.g. 3 (sum of outliers)">
        </div>
      </div>

      <!-- Cost -->
      <div class="mini-field">
        <label>Cost (C) — up to 10 <span class="hint">| per instance</span></label>
        <div class="hint" id="costRow"><input id="tgCost" type="checkbox"> varies across instances</div>
        <input id="C" type="number" min="0" max="10" step="0.01" placeholder="e.g. 1">
        <div id="costExtra" class="mini-field hidden">
          <div class="hint">Total extra cost across outliers (sum)</div>
          <input id="Cextra" type="number" step="any" placeholder="e.g. 2 (sum of outliers)">
        </div>
      </div>

      <!-- Probability -->
      <div class="mini-field">
        <label>Probability unit</label>
        <select id="mode">
          <option value="oneInX">1 in X</option>
          <option value="percent">Percentage (%)</option>
          <option value="micromort">Micromorts</option>
        </select>
        <div class="mini-field">
          <label id="probLabel">Enter X (for “1 in X”)</label>
          <input id="pVal" type="number" min="0" step="any" placeholder="e.g. 1,000,000">
        </div>
        <div class="hint" id="probRow"><input id="tgProb" type="checkbox"> probability varies across instances</div>

        <!-- Groups -->
        <div id="groupsWrap" class="mini-field hidden">
          <div id="groups"></div>
          <div class="center"><button id="addGroup" class="btn back small" type="button">Add probability group</button></div>
          <div id="countMsg" class="hint" style="text-align:center;color:#f59e0b"></div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <svg id="plot" viewBox="0 0 900 420"></svg>
      <div id="verdict" class="verdict"></div>
    </div>

    <div class="foot">
      <button class="back" id="reset" type="button" class="restart">Restart</button>
      <button class="back" id="continue" type="button">Continue</button>
    </div>
  </section>

  <!-- Q7 -->
  <section id="q7" class="card hidden">
    <h2>Try different points (does not change Q6)</h2>
    <div class="mini-fields muted">
      <div class="mini-field"><label>Severity (S)</label><input disabled placeholder="Q6 value"></div>
      <div class="mini-field"><label>Cost (C)</label><input disabled placeholder="Q6 value"></div>
      <div class="mini-field"><label>Probability unit</label><input disabled placeholder="Q6 value"></div>
      <div class="mini-field"><label>Instances (N)</label><input disabled placeholder="Q6 value"></div>
    </div>
    <div style="margin-top:12px">
      <svg id="plotQ7" viewBox="0 0 900 420"></svg>
      <div id="verdictQ7" class="verdict"></div>
    </div>
    <div class="foot">
      <button class="back" data-page="q6">Back to Q6</button>
    </div>
  </section>

  <!-- AB2 -->
  <section id="ab2" class="card hidden">
    <h2>How the math works</h2>
    <div id="ab2Body"></div>
  </section>
</div>

<script>
// ---------- Utilities
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const toProb=(mode,val)=>{
  if(val==null||isNaN(val)) return null;
  if(mode==='oneInX') return (val<=0)?null:1/val;
  if(mode==='percent') return val/100;
  if(mode==='micromort') return val/1_000_000;
  return null;
};
const fmt1 = x => x>=1 ? Number(x.toFixed(3)).toString() : Number(x.toPrecision(3)).toString();
const fmtProb = (p)=>{
  if(p<=0) return '0';
  if(p<1e-4) return '1 in '+fmt1(1/p);
  if(p<0.01) return (p*100).toFixed(3)+'%';
  return (p*100).toFixed(2)+'%';
};

// ---------- DOM + State
const $ = s => document.querySelector(s);
const el = {
  N:$('#N'), S:$('#S'), C:$('#C'), mode:$('#mode'), pVal:$('#pVal'),
  tgSev:$('#tgSev'), tgCost:$('#tgCost'), tgProb:$('#tgProb'),
  sevRow:$('#sevRow'), costRow:$('#costRow'), probRow:$('#probRow'),
  sevExtra:$('#sevExtra'), Sextra:$('#Sextra'),
  costExtra:$('#costExtra'), Cextra:$('#Cextra'),
  groupsWrap:$('#groupsWrap'), groups:$('#groups'), addGroup:$('#addGroup'),
  countMsg:$('#countMsg'),
  plot:$('#plot'), verdict:$('#verdict'),
  cont:$('#continue'), reset:$('#reset'),
  plotQ7:$('#plotQ7'), verdictQ7:$('#verdictQ7'),
  ab2Body:$('#ab2Body')
};
const state = {N:1,S:null,C:null,mode:'oneInX',pVal:null,sevVar:false,costVar:false,probVar:false,Sextra:null,Cextra:null,groups:[]};

// ---------- AB2 content
el.ab2Body.innerHTML = `
<h3>Inputs & Units</h3>
<ul>
  <li><b>Severity S</b> (0–10): average per instance.</li>
  <li><b>Cost C</b> (0–10): cost per instance.</li>
  <li><b>Probability</b> per instance in one unit: <code>1 in X</code>, <code>%</code>, or <code>micromorts</code>.</li>
  <li><b>N</b>: how many instances.</li>
  <li><b>Varies across instances</b>: add outlier groups and optional extra totals for S and C.</li>
</ul>
<h3>Exact multi‑instance probability</h3>
<pre>n_base = N − Σ_g n_g
P(any) = 1 − (1 − p_base)^{n_base} × ∏_g (1 − p_g)^{n_g}
Σ p_i  = n_base·p_base + Σ_g n_g·p_g</pre>
<h3>Severity & cost across N</h3>
<pre>C_total = N·C_usual + C_extra
S_avg   = (N·S_usual + S_extra)/N</pre>
<h3>Decision rule</h3>
<pre>EV_downside = S_avg × (Σ p_i)</pre>
<p>Act iff <code>EV_downside &gt; C_total</code>.</p>`;

// ---------- Groups UI
function drawGroups(){
  el.groups.innerHTML = '';
  state.groups.forEach((g,i)=>{
    const row = document.createElement('div');
    row.className = 'mini-fields';
    row.innerHTML = `
      <div class="mini-field"><label>Group ${i+1} count</label><input data-i="${i}" data-k="count" type="number" min="0" step="1" value="${g.count||0}"></div>
      <div class="mini-field"><label>Unit</label>
        <select data-i="${i}" data-k="mode">
          <option value="oneInX" ${g.mode==='oneInX'?'selected':''}>1 in X</option>
          <option value="percent" ${g.mode==='percent'?'selected':''}>Percentage (%)</option>
          <option value="micromort" ${g.mode==='micromort'?'selected':''}>Micromorts</option>
        </select>
      </div>
      <div class="mini-field"><label>Value</label><input data-i="${i}" data-k="val" type="number" step="any" value="${g.val??''}" placeholder="e.g. 100,000"></div>
      <div class="mini-field"><label>&nbsp;</label><button class="btn back small" data-remove="${i}" type="button">Remove</button></div>`;
    el.groups.appendChild(row);
  });
  el.countMsg.textContent = '';
}

// ---------- Visibility
function refreshVisibility(){
  const N = Number(el.N.value||1);
  const dis = (N===1);
  function setRow(cb,row){
    cb.disabled = dis;
    row.classList.toggle('muted', dis);
    if(dis) cb.checked = false;
  }
  setRow(el.tgSev, el.sevRow);
  setRow(el.tgCost, el.costRow);
  setRow(el.tgProb, el.probRow);

  const hideSev  = dis || !el.tgSev.checked;
  const hideCost = dis || !el.tgCost.checked;
  const hideProb = dis || !el.tgProb.checked;

  el.sevExtra.classList.toggle('hidden', hideSev);
  el.costExtra.classList.toggle('hidden', hideCost);
  el.groupsWrap.classList.toggle('hidden', hideProb);

  if(hideSev) el.Sextra.value = '';
  if(hideCost) el.Cextra.value = '';
  if(hideProb){
    state.groups = [];
    el.groups.innerHTML = '';
    el.countMsg.textContent = '';
  }
}

// ---------- Math
function computeAll(st){
  const N = Math.max(1, st.N|0);
  const pBase = toProb(st.mode, st.pVal);
  if(pBase==null) return {ok:false, reason:'Enter a valid probability.'};

  let used=0, prodNone=1, sumP=0;
  if(st.probVar){
    for(const g of st.groups){
      const cnt = Math.max(0, g.count|0);
      const pg = toProb(g.mode, g.val);
      if(pg==null) return {ok:false, reason:'Check group probabilities.'};
      used += cnt;
      prodNone *= Math.pow(1-pg, cnt);
      sumP += cnt*pg;
    }
    if(used>N) return {ok:false, reason:'Group counts exceed N.'};
  }
  const nBase = N - used;
  prodNone *= Math.pow(1-pBase, nBase);
  sumP += nBase*pBase;

  const S = Number(st.S ?? NaN);
  const C = Number(st.C ?? NaN);
  if(!isFinite(S) || !isFinite(C)) return {ok:false, reason:'Enter S and C.'};
  if(S<0 || S>10 || C<0 || C>10) return {ok:false, reason:'S and C must be 0–10.'};

  const Sextra = st.sevVar ? Number(st.Sextra ?? 0) : 0;
  const Cextra = st.costVar ? Number(st.Cextra ?? 0) : 0;

  const Ctotal = N*C + Cextra;
  const Savg = (N*S + Sextra)/N;
  const EVdown = Savg * sumP;

  const act = EVdown > Ctotal;
  return {ok:true, act, sumP, Savg, Ctotal, EVdown, Pany: 1 - prodNone};
}

// ---------- Plot
function setupPlot(svg){
  const NS='http://www.w3.org/2000/svg';
  svg.innerHTML='';
  const w=900,h=420,pad={l:60,r:16,t:14,b:44};
  const W=w-pad.l-pad.r,H=h-pad.t-pad.b;

  // x: log from 1e-6..1e-1
  const xTicks=[1e-6,1e-5,1e-4,1e-3,1e-2,1e-1];
  const xTo = p => pad.l + (Math.log10(p)-(-6)) / (-1-(-6)) * W;
  const yTo = y => pad.t + (1-y) * H;

  xTicks.forEach(p=>{
    const x=xTo(p);
    const l=document.createElementNS(NS,'line');
    l.setAttribute('x1',x); l.setAttribute('x2',x);
    l.setAttribute('y1',pad.t); l.setAttribute('y2',pad.t+H);
    l.setAttribute('stroke','#1f2937'); svg.appendChild(l);
    const t=document.createElementNS(NS,'text');
    t.setAttribute('x',x); t.setAttribute('y',h-18);
    t.setAttribute('fill','#9ca3af'); t.setAttribute('font-size','12');
    t.setAttribute('text-anchor','middle');
    t.textContent = fmtProb(p);
    svg.appendChild(t);
  });
  [0.2,0.4,0.6,0.8,1].forEach(y=>{
    const yy=yTo(y);
    const l=document.createElementNS(NS,'line');
    l.setAttribute('x1',pad.l); l.setAttribute('x2',pad.l+W);
    l.setAttribute('y1',yy); l.setAttribute('y2',yy);
    l.setAttribute('stroke','#1f2937'); svg.appendChild(l);
    const t=document.createElementNS(NS,'text');
    t.setAttribute('x',12); t.setAttribute('y',yy+4);
    t.setAttribute('fill','#9ca3af'); t.setAttribute('font-size','12');
    t.textContent = 'S_avg/C_total = '+y.toFixed(1); svg.appendChild(t);
  });

  // boundary (visual aid)
  const path=document.createElementNS(NS,'path');
  let d='';
  for(let i=0;i<300;i++){
    const p = 1e-6 * Math.pow(10, i*(5/299));
    const y = Math.min(1, Math.max(0, 1/p / 100));
    const X=xTo(p), Y=yTo(y);
    d += (i===0?'M':'L')+X+','+Y;
  }
  path.setAttribute('d',d);
  path.setAttribute('stroke','#60a5fa'); path.setAttribute('fill','none'); path.setAttribute('stroke-width','2');
  svg.appendChild(path);

  return {xTo,yTo};
}
function redraw(svg, res){
  const {xTo,yTo} = setupPlot(svg);
  const p = clamp(res.sumP, 1e-6, 1e-1);
  const y = clamp(res.Savg / Math.max(1e-9, res.Ctotal), 0, 1);
  const NS='http://www.w3.org/2000/svg';
  const dot=document.createElementNS(NS,'circle');
  dot.setAttribute('r','6'); dot.setAttribute('fill', res.act ? '#22c55e' : '#ef4444');
  dot.setAttribute('cx', xTo(p)); dot.setAttribute('cy', yTo(y));
  svg.appendChild(dot);
}

// ---------- Read & Wire
function readState(){
  state.N = Math.max(1, el.N.valueAsNumber || 1);
  state.S = el.S.value===''? null : el.S.valueAsNumber;
  state.C = el.C.value===''? null : el.C.valueAsNumber;
  state.mode = el.mode.value;
  state.pVal = el.pVal.value===''? null : el.pVal.valueAsNumber;
  state.sevVar = el.tgSev.checked;
  state.costVar = el.tgCost.checked;
  state.probVar = el.tgProb.checked;
  state.Sextra = el.Sextra.value===''? null : el.Sextra.valueAsNumber;
  state.Cextra = el.Cextra.value===''? null : el.Cextra.valueAsNumber;
}
function onChange(){
  readState();
  refreshVisibility();
  const res = computeAll(state);
  if(!res.ok){
    el.verdict.className='verdict no';
    el.verdict.textContent = res.reason;
    el.cont.disabled = true;
  }else{
    redraw(el.plot, res);
    el.verdict.className='verdict ' + (res.act?'ok':'no');
    el.verdict.textContent = (res.act?'Act should be considered.':'Not worth it.') +
      `  (Σp=${fmt1(res.sumP)}, S_avg=${fmt1(res.Savg)}, C_total=${fmt1(res.Ctotal)})`;
    el.cont.disabled = false;
  }
}
['input','change'].forEach(evt=>{
  [el.N,el.S,el.C,el.mode,el.pVal,el.tgSev,el.tgCost,el.tgProb,el.Sextra,el.Cextra]
    .forEach(x=> x && x.addEventListener(evt,onChange));
});

// Groups
el.addGroup.addEventListener('click', ()=>{
  state.groups.push({count:0, mode:state.mode, val:null});
  drawGroups(); onChange();
});
el.groups.addEventListener('input',(e)=>{
  const t=e.target; const i= +t.dataset.i;
  if(Number.isFinite(i)){
    const k=t.dataset.k;
    if(k==='count') state.groups[i].count = t.value===''?0:(t.value|0);
    if(k==='mode')  state.groups[i].mode  = t.value;
    if(k==='val')   state.groups[i].val   = t.value===''?null:+t.value;
    const used = state.groups.reduce((s,g)=>s+(g.count|0),0);
    el.countMsg.textContent = used>state.N ? `Group counts exceed N (${used}/${state.N}).` : '';
    onChange();
  }
});
el.groups.addEventListener('click',(e)=>{
  const i = e.target.dataset.remove;
  if(i!=null){ state.groups.splice(+i,1); drawGroups(); onChange(); }
});

// Reset
el.reset.addEventListener('click', ()=>{
  Object.assign(state, {N:1,S:null,C:null,mode:'oneInX',pVal:null,sevVar:false,costVar:false,probVar:false,Sextra:null,Cextra:null,groups:[]});
  el.N.value=1; el.S.value=''; el.C.value=''; el.mode.value='oneInX'; el.pVal.value='';
  el.tgSev.checked=false; el.tgCost.checked=false; el.tgProb.checked=false;
  el.Sextra.value=''; el.Cextra.value=''; drawGroups(); onChange();
});

// Continue → Q7
el.cont.addEventListener('click', ()=>{
  document.getElementById('q6').classList.add('hidden');
  document.getElementById('q7').classList.remove('hidden');
  const res = computeAll(state);
  redraw(el.plotQ7, res);
  el.verdictQ7.className='verdict ' + (res.act?'ok':'no');
  el.verdictQ7.textContent = (res.act?'Act should be considered (exploration). Go back to Q6 to change values.':'Not worth it (exploration).');
});

// Tabs
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const page = t.dataset.page;
  ['q6','q7','ab2'].forEach(id=>document.getElementById(id).classList.toggle('hidden', id!==page));
}));

// Init
drawGroups(); onChange();
</script>
</body>
</html>
