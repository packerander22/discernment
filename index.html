<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Discernment: A Decision-Making Guide</title>

<link rel="preload" as="image" href="./favicon_256_transparent.png">
<link rel="manifest" href="./site.webmanifest?v=4">
<meta name="theme-color" content="#ffffff">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#0b0b0d" media="(prefers-color-scheme: dark)">
<link rel="icon" type="image/svg+xml" href="./favicon_transparent.svg">
<link rel="icon" type="image/png" sizes="16x16" href="./favicon_16_transparent.png">
<link rel="icon" type="image/png" sizes="32x32" href="./favicon_32_transparent.png">
<link rel="icon" type="image/png" sizes="48x48" href="./favicon_48_transparent.png">
<link rel="icon" type="image/png" sizes="64x64" href="./favicon_64_transparent.png">
<link rel="icon" type="image/png" sizes="192x192" href="./favicon_192_transparent.png">
<link rel="icon" type="image/png" sizes="256x256" href="./favicon_256_transparent.png">
<link rel="icon" type="image/png" sizes="384x384" href="./favicon_384_transparent.png">
<link rel="icon" type="image/png" sizes="512x512" href="./favicon_512_transparent.png">
<link rel="shortcut icon" href="./favicon_transparent.ico">
<link rel="apple-touch-icon" sizes="180x180" href="./favicon_180_transparent.png">

<style>
  :root { color-scheme: light dark; }
  :root {
    --bg:#f7f7f7; --card:#ffffff; --text:#111; --subtle:#333; --border:#ddd; --shadow:0 2px 6px rgba(0,0,0,.1);
    --btn-yes:#4CAF50; --btn-no:#F44336; --btn-next:#2196F3; --btn-muted:#9E9E9E; --btn-text:#fff;
    --axis:#222; --axis-sub:#555;
    --shade-in:#2e7d3222; --shade-out:#c7c7c733;
    --curve:#1f4cff;
    --verdict-green:#2e7d32;
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --bg:#0f1115; --card:#171a21; --text:#e9edf1; --subtle:#c7cbd2; --border:#2a2f3a; --shadow:0 2px 6px rgba(0,0,0,.35);
      --btn-yes:#4CAF50; --btn-no:#EF5350; --btn-next:#42A5F5; --btn-muted:#6c6f76; --btn-text:#fff;
      --axis:#e9edf1; --axis-sub:#c7cbd2;
      --shade-in:#5bd36a22; --shade-out:#3a3f4a55;
      --curve:#6aa2ff;
      --verdict-green:#5bd36a;
    }
  }

  body { background:var(--bg); color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; }
  .container{max-width:720px;margin:auto;padding:20px;}
  .card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);min-height:280px;display:flex;flex-direction:column;}
  .segment-heading{display:flex;align-items:center;justify-content:space-between;font-size:1.6em;font-weight:700;margin:0;padding:14px;border-bottom:2px solid var(--border);}
  .segment-title{display:flex;align-items:center;gap:8px}
  .text{font-size:1.1em;margin:14px 16px 8px 16px;white-space:pre-wrap}
  .controls-row{display:flex;gap:10px;margin:6px 16px 12px}
  .left-controls,.right-controls{flex:1;display:flex;gap:10px}
  .panel{display:none;border:1px solid var(--border);border-radius:8px;background:color-mix(in oklab, var(--card), var(--bg) 8%);padding:12px;margin:0 16px 14px}
  .buttons{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-start;padding:0 16px 16px}
  button{border:0;border-radius:8px;padding:10px 12px;cursor:pointer;color:var(--btn-text);background:var(--btn-muted)}
  .yes{background:var(--btn-yes)} .no{background:var(--btn-no)} .next{background:var(--btn-next)}
  .field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 16px}
  .field{display:flex;flex-direction:column;gap:6px}
  input[type="number"], select{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text)}
  input[disabled], select[disabled]{opacity:.6;cursor:not-allowed}
  .rulebox{margin:8px 16px 2px;font-weight:600}
  .verdict{margin:6px 16px 16px}
  .verdict.good{color:var(--verdict-green)}
  .spacer{height:8px}

  /* Graph */
  .viz-wrap{margin:8px 16px 12px}
  svg{width:100%;height:auto;display:block;touch-action:none}
  .axis text{font-size:15px;font-weight:700;fill:var(--axis)}
  .axis .sub{fill:var(--axis-sub);font-weight:600}
  .grid line{stroke:var(--axis-sub);stroke-opacity:.25;shape-rendering:crispEdges;stroke-width:1}
  .curve{fill:none;stroke:var(--curve);stroke-width:2.5}
  .shade-in{fill:var(--shade-in)}
  .shade-out{fill:var(--shade-out)}
  .handle{fill:#ff3b3b;stroke:#fff;stroke-width:2;cursor:pointer;touch-action:none}
  .ptlabel{font-size:16px;font-weight:800;pointer-events:none;fill:var(--text)}
  .ptlabel-bg{fill:var(--card);fill-opacity:.98;stroke:var(--border)}

  .input-hint::placeholder{opacity:.6}
</style>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-VJSYRKHSRM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-VJSYRKHSRM');
</script>
</head>
<body>
<div class="container">
  <div class="top-bar" style="display:flex;justify-content:space-between;margin-bottom:10px;">
    <button class="next" id="backBtn" type="button">Back</button>
    <button class="next" id="restartTop" type="button">Restart</button>
  </div>

  <div class="card">
    <div id="segmentHeading" class="segment-heading">
      <span id="segmentTitle" class="segment-title">
        <img src="./favicon_256_transparent.png" alt="" style="height:1.2em;width:auto"> Discernment: A Decision-Making Guide
      </span>
      <button id="skipBtn" class="next" style="display:none;" type="button">Skip ⏭</button>
    </div>

    <div id="text" class="text"></div>
    <div class="controls-row">
      <div id="leftControlsWrapper" class="left-controls"></div>
      <div id="rightControlsWrapper" class="right-controls"></div>
    </div>
    <div id="sharedPanel" class="panel" aria-hidden="true"></div>

    <!-- Q6/Q7 dynamic zone -->
    <div id="q6q7Mount"></div>

    <div id="buttons" class="buttons"></div>
  </div>
</div>

<script>
/* ----------------- Flow ----------------- */
const flowchart = [
  { id:"Q0", type:"info", text:"Welcome! This guide helps you determine both IF and WHEN you should act on an issue. Answer simple Yes/No questions (and a slider later).", next:"Q1" },

  /* IF chain */
  { id:"Q1", type:"question", text:"Are there any other more important things to do or think about right now?", yes:"R1", no:"Q2" },
  { id:"Q2", type:"question", text:"Is there a current real problem or desired functional QoL improvement?", yes:"Q10", no:"Q3" },
  { id:"Q3", type:"question", text:"Is there cause for a potential real problem?", yes:"Q5", no:"Q4" },
  { id:"Q4", type:"question", text:"Is there cause for a POTENTIAL cause for a POTENTIAL real problem?", yes:"Q5", no:"R2" },
  { id:"Q5", type:"question", text:"Is the potential problem inevitable if left unaddressed?", yes:"Q10", no:"Q6" },

  /* NEW mini slide 1 -> Q6 */
  { id:"Q6", type:"question", text:"Mini Slide 1 — Preventative Action Cutoff", yes:"Q10", no:"Q7" },

  /* NEW mini slide 2 -> Q7 (visual-only) */
  { id:"Q7", type:"question", text:"Mini Slide 2 — What would flip the verdict?", yes:"Q10", no:"Q20" },

  /* Keep the rest identical numbers so chronology has no cosmetic gaps */
  { id:"Q8", type:"question", text:"(kept to preserve numbering; internal route)", yes:"Q10", no:"Q20" },
  { id:"Q9", type:"question", text:"(kept to preserve numbering; internal route)", yes:"Q10", no:"Q20" },

  { id:"Q10", type:"question", text:"Is there a solution (or at least partial solution) even if it’s currently unavailable?", yes:"Q11", no:"R4" },
  { id:"Q11", type:"question", text:"Can this solution be guaranteed to be fully brought about as a result of your influence?", yes:"Q14", no:"Q12" },
  { id:"Q12", type:"question", text:"Do everything in your power first. Is there anything further you can do?", yes:"Q14", no:"Q13" },
  { id:"Q13", type:"question", text:"Is there an alternative solution that solves the problem in a better overall way?", yes:"R5", no:"R2" },

  /* WHEN */
  { id:"Q14", type:"question", text:"Does this involve gaining information valuable in the future?", yes:"Q15", no:"Q16" },
  { id:"Q15", type:"question", text:"Would the information alone outweigh the downsides to get it?", yes:"Q31", no:"Q16" },

  { id:"Q16", type:"question", text:"Would benefits outweigh upfront costs?", yes:"Q17", no:"Q20" },
  { id:"Q17", type:"question", text:"Would benefits outweigh resulting downsides?", yes:"Q18", no:"Q20" },
  { id:"Q18", type:"question", text:"Would overall benefits outweigh total costs + downsides?", yes:"Q22", no:"Q20", same:"Q19" },
  { id:"Q19", type:"question", text:"All things considered, would you rather address it?", yes:"Q22", no:"Q20" },
  { id:"Q20", type:"question", text:"Is there a time further down the road the previous answer could be yes?", yes:"R3", no:"Q21" },
  { id:"Q21", type:"question", text:"Is there an alternative solution that’s worth it or better overall?", yes:"R5", no:"R2" },

  { id:"Q22", type:"question", text:"Does addressing this involve diminishing returns?", yes:"Q23", no:"Q24" },
  { id:"Q23", type:"info",     text:"Find the point of diminishing returns and stop there.", next:"Q24" },
  { id:"Q24", type:"question", text:"Does it involve an inverted‑U curve with a sweet spot?", yes:"Q25", no:"Q26" },
  { id:"Q25", type:"info",     text:"Wait until no higher priorities, then, if worth it, find the sweet spot.", next:"Q31" },

  { id:"Q26", type:"question", text:"Would a functional difference be noticed in practice?", yes:"Q27", no:"R2" },
  { id:"Q27", type:"question", text:"Would solving it help in the long term?", yes:"Q31", no:"Q28" },
  { id:"Q28", type:"question", text:"Would it help in the short term?", yes:"Q29", no:"R2" },
  { id:"Q29", type:"question", text:"Is it logically worth addressing every time (or at least this time)?", yes:"Q31", no:"Q30" },
  { id:"Q30", type:"question", text:"Is there an alternative solution (long term or better overall)?", yes:"R5", no:"R2" },

  { id:"Q31", type:"question", text:"Does this address a potential future problem?", yes:"Q32", no:"Q35" },
  { id:"Q32", type:"question", text:"Does it involve preventative maintenance?", yes:"Q33", no:"Q35" },
  { id:"Q33", type:"info",     text:"Set the estimated catastrophic severity if you waited too long to act. (1–10)", next:"Q34" },
  { id:"Q34", type:"question", text:"Would there be guaranteed telltale signs with a big enough window to act?", yes:"Q46", no:"Q47" },

  { id:"Q35", type:"question", text:"Is this the most effective solution you know of?", yes:"Q39", no:"Q36" },
  { id:"Q36", type:"question", text:"Have you considered all better solutions you know of?", yes:"Q39", no:"R5" },

  { id:"Q37", type:"question", text:"(kept for full parity)", yes:"Q33", no:"Q38" },
  { id:"Q38", type:"question", text:"(kept for full parity)", yes:"Q33", no:"R5" },
  { id:"Q39", type:"question", text:"Is this solution currently available?", yes:"Q40", no:"Q41" },
  { id:"Q40", type:"question", text:"Is there a better time down the road to maximize value?", yes:"Q41", no:"R7" },
  { id:"Q41", type:"question", text:"If you waited, would overall benefits outweigh downsides of waiting?", yes:"Q44", no:"Q43", same:"Q42" },
  { id:"Q42", type:"question", text:"All things considered, would you rather use this solution?", yes:"Q44", no:"Q43" },
  { id:"Q43", type:"question", text:"Is there a next best solution you know of?", yes:"R5", no:"R4" },
  { id:"Q44", type:"question", text:"Is there a better time further down the road to maximize value?", yes:"R8", no:"R6" },
  { id:"Q45", type:"question", text:"(kept for parity)", yes:"R8", no:"R6" },
  { id:"Q46", type:"question", text:"Normally act when telltale signs indicate failure approaching and chance nears your threshold.", yes:"R8", no:"R9" },
  { id:"Q47", type:"question", text:"Normally act when the estimated chance of failure nears your threshold.", yes:"R8", no:"R9" },

  { id:"R1", type:"result", text:"Worry about this once more important things are addressed." },
  { id:"R2", type:"result", text:"Don’t worry about it :)" },
  { id:"R3", type:"result", text:"If that time comes, re‑evaluate. Until then, consider other worthwhile solutions." },
  { id:"R4", type:"result", text:"Wait until there aren’t higher priorities, then find a solution if it’s worth it." },
  { id:"R5", type:"result", text:"Consider other solutions from best to worst and run them through the chart." },
  { id:"R6", type:"result", text:"Wait until available, then act when there aren’t higher priorities." },
  { id:"R7", type:"result", text:"Address it sooner than later, once there aren’t higher priorities." },
  { id:"R8", type:"result", text:"Wait for that better time, then act once there aren’t higher priorities." },
  { id:"R9", type:"result", text:"Act as soon as the criteria from the previous slide are met (when there aren’t higher priorities)." }
];

let historyStack = [];
let currentNode = flowchart[0];

/* ----------------- Q6/Q7 State ----------------- */
const state = {
  S: 5, C: 1, mode: 'oneInX', probVal: 1000000, // primary (Q6) values
  // Derived:
  get X_user() {
    if (this.mode==='oneInX') return this.probVal>1? this.probVal : null;
    if (this.mode==='percent') return (this.probVal>0 && this.probVal<100)? 100/this.probVal : null;
    if (this.mode==='micromort') return (this.probVal>0 && this.probVal<1e6)? 1e6/this.probVal : null;
    return null;
  }
};
// Separate ephemeral viz state for Q7 (does NOT mutate primary until user goes back)
const viz2 = { S:null, C:null, mode:null, X:null };

/* ----------------- Core math ----------------- */
const EPS = 1e-9;
const MAX_SC = 10;
const ALPHA = Math.log(0.5) / Math.log((Math.sqrt(10) - 1) / 9);
function clamp(v, lo, hi){ return Math.min(hi, Math.max(lo, v)); }
function ceilPlaces(x,p=2){ const f=10**p; return Math.ceil(x*f)/f; }

function Xcutoff_from_ratio(r) {
  const tRaw = (r - 1) / 9;
  const t = Math.max(0, Math.min(1, tRaw));
  const exponent = 6 * Math.pow(t, ALPHA);
  return Math.pow(10, exponent);
}
function computeSCutoffForX(X){
  return 1 + 9 * Math.pow((Math.log10(X)/6), 1/ALPHA);
}
function cutoffInUnit(Xc, mode){
  if (mode==='percent') return 100/Xc;
  if (mode==='micromort') return 1e6/Xc;
  return Xc;
}
function probRuleName(mode){
  if (mode==='percent') return '%';
  if (mode==='micromort') return 'µm';
  return 'X';
}

/* ----------------- Render helpers ----------------- */
const $ = (id)=>document.getElementById(id);

function renderNode(node){
  currentNode = node;
  $('text').textContent = node.text || '';

  $('leftControlsWrapper').innerHTML='';
  $('rightControlsWrapper').innerHTML='';
  $('sharedPanel').style.display='none';
  $('sharedPanel').dataset.mode='';
  $('sharedPanel').innerHTML='';

  $('buttons').innerHTML='';

  // Back + Restart
  $('backBtn').onclick = ()=>{
    const prevId = historyStack.pop();
    const prev = flowchart.find(n=>n.id===prevId);
    if (prev) renderNode(prev);
  };
  $('restartTop').onclick = ()=>{ historyStack=[]; renderNode(flowchart[0]); };

  if (node.type==='result'){
    const btn = document.createElement('button');
    btn.textContent = 'Restart'; btn.className='next';
    btn.onclick = ()=>{ historyStack=[]; renderNode(flowchart[0]); };
    $('buttons').appendChild(btn);
    $('q6q7Mount').innerHTML='';
    return;
  }

  // --- Special rendering for Q6 / Q7 ---
  if (node.id==='Q6' || node.id==='Q7'){
    renderMini(node.id);
  } else {
    $('q6q7Mount').innerHTML='';
    // normal question/info buttons
    if (node.type==='question'){
      const y = document.createElement('button'); y.className='yes'; y.textContent='Yes';
      const n = document.createElement('button'); n.className='no';  n.textContent='No';
      y.onclick = ()=>{ historyStack.push(node.id); renderNode(flowchart.find(n2=>n2.id===node.yes)); };
      n.onclick = ()=>{ historyStack.push(node.id); renderNode(flowchart.find(n2=>n2.id===node.no)); };
      $('buttons').appendChild(y); $('buttons').appendChild(n);
      if (node.same){
        const s = document.createElement('button'); s.className='next'; s.textContent='Roughly the Same';
        s.onclick = ()=>{ historyStack.push(node.id); renderNode(flowchart.find(n2=>n2.id===node.same)); };
        $('buttons').appendChild(s);
      }
    } else if (node.type==='info'){
      const nx = document.createElement('button'); nx.className='next'; nx.textContent='Next';
      nx.onclick = ()=>{ historyStack.push(node.id); renderNode(flowchart.find(n2=>n2.id===node.next)); };
      $('buttons').appendChild(nx);
      const about = document.createElement('button'); about.className='next'; about.textContent='About';
      about.onclick = ()=>{ alert('About is omitted here to focus on integration.'); };
      if (node.id==='Q0') $('buttons').appendChild(about);
    }
  }
}

/* ----------------- Mini (Q6/Q7) ----------------- */
function renderMini(which){
  const mount = $('q6q7Mount');
  mount.innerHTML='';

  // Inputs
  const fields = document.createElement('div'); fields.className='field-row';
  const f1 = document.createElement('div'); f1.className='field';
  const f2 = document.createElement('div'); f2.className='field';
  const f3 = document.createElement('div'); f3.className='field';

  const sev = document.createElement('input');
  sev.type='number'; sev.max='10'; sev.step='0.01'; sev.className='input-hint';
  sev.placeholder='e.g. 5'; // requested e.g.
  const cost = document.createElement('input');
  cost.type='number'; cost.max='10'; cost.step='0.01'; cost.className='input-hint';
  cost.placeholder='e.g. 1'; // requested e.g.

  const pmode = document.createElement('select');
  pmode.innerHTML = '<option value="oneInX">1 in X</option><option value="percent">Percentage (%)</option><option value="micromort">Micromorts</option>';
  const pval = document.createElement('input');
  pval.type='number'; pval.className='input-hint';
  pval.placeholder='e.g. 1,000,000'; // requested e.g.

  const lbl1 = document.createElement('label'); lbl1.textContent='Severity (S) — up to 10';
  const lbl2 = document.createElement('label'); lbl2.textContent='Cost (C) — up to 10';
  const lbl3a = document.createElement('label'); lbl3a.textContent='Probability input mode';
  const lbl3b = document.createElement('label'); lbl3b.id='probHint';

  f1.appendChild(lbl1); f1.appendChild(sev);
  f2.appendChild(lbl2); f2.appendChild(cost);
  const inner = document.createElement('div'); inner.className='field-row';
  const f3a=document.createElement('div'); f3a.className='field'; f3a.appendChild(lbl3a); f3a.appendChild(pmode);
  const f3b=document.createElement('div'); f3b.className='field'; f3b.appendChild(lbl3b); f3b.appendChild(pval);
  mount.appendChild(fields);
  fields.appendChild(f1); fields.appendChild(f2);
  mount.appendChild(inner); inner.appendChild(f3a); inner.appendChild(f3b);

  // Grey rules for Q7
  const disabled = (which==='Q7');
  sev.disabled = disabled; cost.disabled = disabled; pmode.disabled = disabled; pval.disabled = disabled;

  // Seed values
  if (which==='Q6'){
    sev.value = String(state.S); cost.value=String(state.C);
    pmode.value = state.mode;
    pval.value = (state.mode==='oneInX')? state.probVal : (state.mode==='percent'? state.probVal : state.probVal);
  } else {
    // Q7 mirrors but does not own truth
    if (viz2.S==null){ viz2.S=state.S; viz2.C=state.C; viz2.mode=state.mode; viz2.X=state.X_user??2; }
    sev.value = String(viz2.S); cost.value=String(viz2.C); pmode.value = viz2.mode;
    if (viz2.mode==='oneInX'){ pval.value = Math.round(viz2.X); }
    else if (viz2.mode==='percent'){ pval.value = 100/viz2.X; }
    else { pval.value = 1e6/viz2.X; }
  }

  function refreshProbConstraints(mode){
    if (mode==='oneInX'){ lbl3b.textContent='Enter X (for “1 in X”)'; pval.min='2'; pval.max=''; pval.step='1'; pval.placeholder='e.g. 1,000,000'; }
    else if (mode==='percent'){ lbl3b.textContent='Enter percentage (%)'; pval.min='0.0000001'; pval.max='99.9999999'; pval.step='0.0001'; pval.placeholder='e.g. 0.02'; }
    else { lbl3b.textContent='Enter micromorts (µm)'; pval.min='0.0001'; pval.max='999999.99'; pval.step='0.01'; pval.placeholder='e.g. 5'; }
  }
  refreshProbConstraints(pmode.value);

  // Graph zone
  const vizWrap = document.createElement('div'); vizWrap.className='viz-wrap'; mount.appendChild(vizWrap);
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','0 0 950 620'); svg.style.touchAction='none';
  vizWrap.appendChild(svg);

  const gGrid = document.createElementNS('http://www.w3.org/2000/svg','g'); gGrid.setAttribute('class','grid'); svg.appendChild(gGrid);
  const gAxes = document.createElementNS('http://www.w3.org/2000/svg','g'); gAxes.setAttribute('class','axis'); svg.appendChild(gAxes);
  const shadeIn = document.createElementNS('http://www.w3.org/2000/svg','path'); shadeIn.setAttribute('class','shade-in'); svg.appendChild(shadeIn);
  const shadeOut= document.createElementNS('http://www.w3.org/2000/svg','path'); shadeOut.setAttribute('class','shade-out'); svg.appendChild(shadeOut);
  const curve = document.createElementNS('http://www.w3.org/2000/svg','path'); curve.setAttribute('class','curve'); svg.appendChild(curve);
  const handle = document.createElementNS('http://www.w3.org/2000/svg','circle'); handle.setAttribute('class','handle'); handle.setAttribute('r','11'); svg.appendChild(handle);
  const labelG = document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(labelG);
  const labelBg = document.createElementNS('http://www.w3.org/2000/svg','rect'); labelBg.setAttribute('class','ptlabel-bg'); labelBg.setAttribute('rx','10'); labelBg.setAttribute('ry','10'); labelG.appendChild(labelBg);
  const labelTx = document.createElementNS('http://www.w3.org/2000/svg','text'); labelTx.setAttribute('class','ptlabel'); labelG.appendChild(labelTx);

  const pad = { left:110, right:26, top:36, bottom:98 }; // more outer space
  const W=950, H=620, plotW=W-pad.left-pad.right, plotH=H-pad.top-pad.bottom;
  const rMin=1, rMax=10;
  const rToPx = (r)=> pad.left + (r-rMin)/(rMax-rMin)*plotW;
  const pxToR = (px)=> (rMin + (px-pad.left)/plotW*(rMax-rMin));
  function yToPx(y,yMin,yMax){ return pad.top + plotH * (1 - (Math.log10(y)-Math.log10(yMin))/(Math.log10(yMax)-Math.log10(yMin))); }
  function XtoYUnit(X,mode){ return (mode==='percent') ? (100/X) : (mode==='micromort' ? (1e6/X) : X); }

  function getYRange(mode){
    if (mode==='percent') return { yMin: 0.0001, yMax: 100, ticks:[100,10,1,0.1,0.01,0.001,0.0001], ylab:"Cutoff Probability (%) (log scale)" };
    if (mode==='micromort') return { yMin: 1, yMax: 1e6, ticks:[1e6,1e5,1e4,1e3,100,10,1], ylab:"Cutoff Probability (µm) (log scale)" };
    return { yMin: 1, yMax: 1e6, ticks:[1,10,100,1e3,1e4,1e5,1e6], ylab:"Cutoff Probability as '1 in X' (log scale)" };
  }

  function drawAxes(mode){
    gAxes.innerHTML=''; gGrid.innerHTML='';
    const { yMin, yMax, ticks, ylab } = getYRange(mode);

    // vertical grid + x ticks
    for (let r=1;r<=10;r++){
      const x=rToPx(r);
      // grid
      const vl = document.createElementNS('http://www.w3.org/2000/svg','line');
      vl.setAttribute('x1',x); vl.setAttribute('x2',x);
      vl.setAttribute('y1',pad.top); vl.setAttribute('y2',pad.top+plotH);
      gGrid.appendChild(vl);
      // labels
      const tx=document.createElementNS('http://www.w3.org/2000/svg','text');
      tx.setAttribute('x',x); tx.setAttribute('y',H-pad.bottom+36); // pushed down
      tx.setAttribute('text-anchor','middle'); tx.setAttribute('class','sub');
      tx.textContent=r; gAxes.appendChild(tx);
    }
    // horizontal grid + y tick labels
    ticks.forEach(y=>{
      const py = yToPx(y,yMin,yMax);
      const hl = document.createElementNS('http://www.w3.org/2000/svg','line');
      hl.setAttribute('x1',pad.left); hl.setAttribute('x2',pad.left+plotW);
      hl.setAttribute('y1',py); hl.setAttribute('y2',py);
      gGrid.appendChild(hl);

      const ty=document.createElementNS('http://www.w3.org/2000/svg','text');
      ty.setAttribute('x',pad.left-14); ty.setAttribute('y',py+5);
      ty.setAttribute('text-anchor','end'); ty.setAttribute('class','sub');
      ty.textContent = (mode==='percent' ? (y>=1?y.toString():y.toExponential(1)) : y.toLocaleString());
      gAxes.appendChild(ty);
    });
    // axis titles (farther outside, larger)
    const xlab=document.createElementNS('http://www.w3.org/2000/svg','text');
    xlab.setAttribute('x', pad.left+plotW/2); xlab.setAttribute('y', H-36);
    xlab.setAttribute('text-anchor','middle'); xlab.textContent = "Severity / Cost Ratio (S / C)";
    gAxes.appendChild(xlab);
    const ylabTx=document.createElementNS('http://www.w3.org/2000/svg','text');
    ylabTx.setAttribute('transform',`translate(${28}, ${pad.top+plotH/2}) rotate(-90)`);
    ylabTx.setAttribute('text-anchor','middle'); ylabTx.textContent = ylab;
    gAxes.appendChild(ylabTx);

    // bump font size/weight
    [xlab, ylabTx].forEach(t=>{ t.setAttribute('style','font-size:18px;font-weight:800'); t.setAttribute('class','axis'); });
  }

  function buildCurve(mode){
    const {yMin,yMax} = getYRange(mode);
    const N=600, pts=[];
    for(let i=0;i<=N;i++){
      const r = 1 + 9*(i/N);
      const X = Xcutoff_from_ratio(r);
      const Y = XtoYUnit(X, mode);
      pts.push([rToPx(r), yToPx(Y, yMin, yMax)]);
    }
    const d = pts.map(([x,y],i)=> (i?`L ${x},${y}`:`M ${x},${y}`)).join(' ');
    curve.setAttribute('d', d);
    const pb = `L ${rToPx(10)},${yToPx(yMin,yMin,yMax)} L ${rToPx(1)},${yToPx(yMin,yMin,yMax)} Z`;
    const pt = `L ${rToPx(10)},${yToPx(yMax,yMin,yMax)} L ${rToPx(1)},${yToPx(yMax,yMin,yMax)} Z`;
    shadeIn.setAttribute('d', d + ' ' + pb);
    shadeOut.setAttribute('d', d + ' ' + pt);
  }

  // initial locals
  let eMode = (which==='Q6' ? state.mode : viz2.mode);
  let eS    = (which==='Q6' ? state.S    : viz2.S);
  let eC    = (which==='Q6' ? state.C    : viz2.C);
  let eX    = (which==='Q6' ? (state.X_user ?? 2) : viz2.X);

  function updateFromInputs(){
    let S = parseFloat(sev.value); if (!isFinite(S)) S = eS;
    let C = parseFloat(cost.value); if (!isFinite(C)) C = eC;
    if (S<=0) S=EPS; if (C<=0) C=EPS;
    S=Math.min(S, MAX_SC); C=Math.min(C, MAX_SC);
    eS=S; eC=C;

    eMode = pmode.value;
    let pv = parseFloat(pval.value);
    if (!isFinite(pv)) pv = (eMode==='oneInX'? 1000000 : (eMode==='percent'? 0.01 : 1));
    if (eMode==='oneInX' && pv<2) pv=2;
    if (eMode==='percent'){ if (pv<=0) pv=0.0000001; if (pv>=100) pv=99.9999999; }
    if (eMode==='micromort'){ if (pv<=0) pv=0.0001; if (pv>=1e6) pv=999999.99; }
    if (eMode==='oneInX') eX = pv;
    else if (eMode==='percent') eX = 100/pv;
    else eX = 1e6/pv;

    drawAll();
    if (which==='Q6'){
      // commit to primary
      state.S=eS; state.C=eC; state.mode=eMode;
      state.probVal = (eMode==='oneInX')? pv : (eMode==='percent'? pv : pv);
    }
  }

  function verdictAct(){
    const r = eS/eC;
    const Xc = Xcutoff_from_ratio(r);
    const act = eX <= Xc + 1e-15;
    return act;
  }

  function drawAll(){
    refreshProbConstraints(eMode);
    drawAxes(eMode);
    buildCurve(eMode);

    const {yMin,yMax} = getYRange(eMode);
    const r = eS/eC;
    const Xc = Xcutoff_from_ratio(r);
    const Yc = XtoYUnit(Xc, eMode);
    const cx = rToPx(clamp(r,1,10)); const cy = yToPx(Yc, yMin, yMax);
    handle.setAttribute('cx', cx); handle.setAttribute('cy', cy);

    const label = `S=${ceilPlaces(eS,2)} · C=${ceilPlaces(eC,2)} · S/C=${ceilPlaces(r,3)} · X=${(eMode==='oneInX'? Math.round(Xc).toLocaleString() : eMode==='percent'? ceilPlaces(100/Xc,6)+'%' : ceilPlaces(1e6/Xc,2)+' µm')}`;
    labelTx.textContent=label; labelTx.setAttribute('text-anchor','middle');
    const offsetY=34; let ly = cy - offsetY; const minTop=pad.top + 18; if (ly<minTop) ly=minTop;
    labelTx.setAttribute('x', cx); labelTx.setAttribute('y', ly);
    const bb = labelTx.getBBox(); const padBox=10;
    labelBg.setAttribute('x', bb.x-padBox); labelBg.setAttribute('y', bb.y-padBox);
    labelBg.setAttribute('width', bb.width+2*padBox); labelBg.setAttribute('height', bb.height+2*padBox);

    // rule + verdict
    const ruleEl = $('ruleLine_' + which);
    const verdictEl = $('verdict_' + which);
    const prn = probRuleName(eMode);
    ruleEl.innerHTML = `Rule: Only if <b>${prn}</b> ≥ <b>Probability Cutoff</b> and <b>S/C</b> ≥ <b>S/C Cutoff</b> can action be considered.`;
    const act = verdictAct();
    verdictEl.textContent = 'Verdict: ' + (act ? 'Action should be considered.' : 'Action should NOT be considered.');
    verdictEl.classList.toggle('good', act);
  }

  // Drag
  let dragging=false;
  function chooseSCFromRatio(r, prevS, prevC){
    // keep both changing: we'll nudge S slightly and solve C
    let S = clamp(prevS + (r- (prevS/prevC))*0.4, EPS, MAX_SC);
    let C = clamp(S / r, EPS, MAX_SC);
    // if C clipped, recompute S from C
    if (C===EPS || C===MAX_SC){ C = clamp(prevC, EPS, MAX_SC); S = clamp(r*C, EPS, MAX_SC); }
    return {S,C};
  }
  function onPointerDown(e){ e.preventDefault(); dragging=true; try{handle.setPointerCapture(e.pointerId);}catch(_){ } onPointerMove(e); }
  function onPointerMove(e){
    if(!dragging) return; e.preventDefault();
    const pt = svg.createSVGPoint(); pt.x=e.clientX; pt.y=e.clientY;
    const sp = pt.matrixTransform(svg.getScreenCTM().inverse());
    const px = clamp(sp.x, pad.left, pad.left+plotW);
    const r = pxToR(px);
    const chosen = chooseSCFromRatio(r, eS, eC);
    eS = chosen.S; eC=chosen.C;
    if (which==='Q6'){ state.S=eS; state.C=eC; }
    else { viz2.S=eS; viz2.C=eC; }
    sev.value = ceilPlaces(eS,2); cost.value=ceilPlaces(eC,2);
    drawAll();
  }
  function onPointerUp(e){ dragging=false; try{handle.releasePointerCapture(e.pointerId);}catch(_){ } }
  handle.addEventListener('pointerdown', onPointerDown, {passive:false});
  svg.addEventListener('pointermove', onPointerMove, {passive:false});
  window.addEventListener('pointerup', onPointerUp, {passive:false});

  // Rule + verdict zone
  const rule = document.createElement('div'); rule.className='rulebox'; rule.id='ruleLine_'+which;
  const verdict = document.createElement('div'); verdict.className='verdict'; verdict.id='verdict_'+which;
  const spacer = document.createElement('div'); spacer.className='spacer';
  mount.appendChild(rule); mount.appendChild(verdict); mount.appendChild(spacer);

  // Wire events (Q6 editable, Q7 disabled already)
  pmode.addEventListener('change', ()=>{ if (which==='Q6') state.mode = pmode.value; refreshProbConstraints(pmode.value); updateFromInputs(); });
  [sev, cost, pval].forEach(el=>{
    el.addEventListener('change', updateFromInputs);
    el.addEventListener('blur', updateFromInputs);
  });

  // Initial draw
  updateFromInputs();

  // Bottom nav for Q6/Q7
  $('buttons').innerHTML='';
  if (which==='Q6'){
    const cont = document.createElement('button'); cont.className='next'; cont.textContent='Continue';
    cont.onclick = ()=>{
      // route by verdict
      const act = (function(){ const r=state.S/state.C; const Xc=Xcutoff_from_ratio(r); return (state.X_user??Infinity) <= Xc + 1e-15; })();
      historyStack.push('Q6');
      if (act){ renderNode(flowchart.find(n=>n.id==='Q10')); } else { renderNode(flowchart.find(n=>n.id==='Q7')); }
    };
    $('buttons').appendChild(cont);
  } else {
    const yes = document.createElement('button'); yes.className='yes'; yes.textContent='Yes';
    yes.onclick = ()=>{ historyStack.push('Q7'); renderNode(flowchart.find(n=>n.id==='Q10')); };
    const no = document.createElement('button'); no.className='no'; no.textContent='No';
    no.onclick = ()=>{ historyStack.push('Q7'); renderNode(flowchart.find(n=>n.id==='Q20')); };
    $('buttons').appendChild(yes); $('buttons').appendChild(no);
  }
}

/* ----------------- Kickoff ----------------- */
renderNode(currentNode);
</script>
</body>
</html>
