<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Discernment: A Decision-Making Guide</title>

<link rel="preload" as="image" href="./favicon_256_transparent.png">
<link rel="manifest" href="./site.webmanifest?v=4">
<meta name="theme-color" content="#ffffff">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#0b0b0d" media="(prefers-color-scheme: dark)">

<link rel="icon" type="image/svg+xml" href="./favicon_transparent.svg">
<link rel="icon" type="image/png" sizes="16x16" href="./favicon_16_transparent.png">
<link rel="icon" type="image/png" sizes="32x32" href="./favicon_32_transparent.png">
<link rel="icon" type="image/png" sizes="48x48" href="./favicon_48_transparent.png">
<link rel="icon" type="image/png" sizes="64x64" href="./favicon_64_transparent.png">
<link rel="icon" type="image/png" sizes="192x192" href="./favicon_192_transparent.png">
<link rel="icon" type="image/png" sizes="256x256" href="./favicon_256_transparent.png">
<link rel="icon" type="image/png" sizes="384x384" href="./favicon_384_transparent.png">
<link rel="icon" type="image/png" sizes="512x512" href="./favicon_512_transparent.png">
<link rel="shortcut icon" href="./favicon_transparent.ico">
<link rel="apple-touch-icon" sizes="180x180" href="./favicon_180_transparent.png">

<style>
  :root {
    --btn-pad-y:10px; --btn-pad-x:12px;
    --track-height: 8px;
    --thumb-size: 28px;
    --thumb-shadow: 0 1px 3px rgba(0,0,0,.25);
    --track-bg: #e0e0e0;
    --fill: #2d6cdf;
    --pct: 0%;
    --tick-color: rgba(0,0,0,.35);
    --tick-thickness: 2px;
    --tick-length: 6px;
  }

  body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:0; }
  .container { max-width: 650px; margin:auto; padding:20px; }
  .top-bar { display:flex; justify-content:space-between; margin-bottom:10px; }
  .card {
    background:#fff; padding:20px; border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1); min-height:280px;
    display:flex; flex-direction:column; justify-content:space-between;
  }

  .segment-heading {
    display:flex; align-items:center; justify-content:space-between;
    font-size:1.8em; font-weight:bold; margin-bottom:15px; padding:8px;
    border-bottom:2px solid #ddd; gap:12px; transition: color .5s ease;
  }
  .segment-title { display:inline-flex; align-items:center; gap:8px; }
  .segment-title img.logo { height:1.2em; width:auto; margin-right:6px; aspect-ratio: 1 / 1; }
  .flash-gold { color: goldenrod !important; }
  .flash-green { color: #2e7d32 !important; }
  .flash-purple { color: #9C27B0 !important; }

  button { flex:1; padding:var(--btn-pad-y) var(--btn-pad-x); font-size:1em; border:none; border-radius:5px; cursor:pointer; }
  button.yes { background:#4CAF50; color:#fff; }
  button.no { background:#F44336; color:#fff; }
  button.same { background:#1E88E5; color:#fff; }
  button.next { background:#2196F3; color:#fff; }
  button.back { background:#555; color:#fff; flex:0 0 auto; }
  button.restart { background:#9C27B0; color:#fff; flex:0 0 auto; }
  button.examples-btn, button.viz-btn, button.reasoning-btn { background:#9E9E9E; color:#fff; }
  .ctrl-btn { flex:1; }
  button.active { outline:2px solid #000; }

  .segment-heading .skip-btn {
    display:inline-flex; align-items:center; justify-content:center;
    flex:0 0 auto; padding:var(--btn-pad-y) var(--btn-pad-x);
    font-size:1rem; line-height:1; border:none; border-radius:5px; cursor:pointer;
    background:#e9e9e9; color:#333;
  }
  .segment-heading .skip-btn:hover { background:#dedede; }

  .text { font-size:1.3em; margin-bottom:12px; white-space:pre-wrap; }
  .controls-row { display:flex; gap:10px; margin:6px 0 18px 0; }
  .left-controls, .right-controls { flex:1; display:flex; gap:10px; }

  .panel { display:none; border:1px solid #eee; border-radius:6px; padding:10px; background:#fafafa; margin-bottom:18px; }
  .panel p { margin:6px 0; }
  .panel img { width:100%; height:auto; display:block; }

  .buttons { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start; }
  .buttons.center { justify-content:center; }

  .risk-inline { display:none; border:1px solid #eee; border-radius:6px; padding:12px; background:#fafafa; margin:8px 0 18px 0; }
  .sev-display { text-align:center; font-size:1.8em; font-weight:bold; margin-bottom:8px; }
  .risk-row { display:flex; align-items:center; gap:10px; margin:0; }
  .risk-row input[type="range"] { width:100%; }
  .risk-ticks { display:block; width:100%; }

  .error { color:#B00020; font-size:0.95em; }

  .slider-wrap { position: relative; width: 100%; height: calc(var(--thumb-size) + var(--tick-length) * 2 + 8px); display: flex; align-items: center; justify-content: center; touch-action: pan-x; }
  .heat-slider { -webkit-appearance: none; appearance: none; width: 100%; height: var(--thumb-size); background: transparent; position: relative; z-index: 1; }
  .heat-slider::-webkit-slider-runnable-track {
    height: var(--track-height); border-radius: calc(var(--track-height) / 2);
    background: linear-gradient(to right, var(--fill) 0%, var(--fill) var(--pct), var(--track-bg) var(--pct), var(--track-bg) 100%);
  }
  .heat-slider::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none; width: var(--thumb-size); height: var(--thumb-size); border-radius: 50%;
    background: #fff; border: 2px solid #999; box-shadow: var(--thumb-shadow); margin-top: calc((var(--thumb-size) - var(--track-height)) / -2); cursor: pointer;
  }
  .tick-row { position: absolute; left: calc(var(--thumb-size) / 2); right: calc(var(--thumb-size) / 2); height: var(--tick-length); pointer-events: none; z-index: 0; }
  .tick-row.top { top: 50%; transform: translateY(calc(-50% - var(--track-height)/2 - 2px)); }
  .tick-row.bottom { top: 50%; transform: translateY(calc(-50% + var(--track-height)/2 + 2px)); }
  .tick { position: absolute; width: var(--tick-thickness); height: 100%; background: var(--tick-color); transform: translateX(-50%); }

  :root { color-scheme: light dark; }
  :root {
    --bg: #f7f7f7; --card: #ffffff; --text: #111111; --subtle-text: #333333; --border: #dddddd; --shadow: 0 2px 6px rgba(0,0,0,0.10);
    --btn-yes: #4CAF50; --btn-no: #F44336; --btn-same: #1E88E5; --btn-next: #2196F3; --btn-back: #555555; --btn-restart: #9C27B0; --btn-muted: #9E9E9E; --btn-text: #ffffff;
    --thumb-border: #999999; --tick-color: rgba(0,0,0,.35); --track-bg: #e0e0e0;
    --if-accent: #2e7d32; --when-accent: goldenrod; --result-accent: #9C27B0;
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #0f1115; --card: #171a21; --text: #e9edf1; --subtle-text: #c7cbd2; --border: #2a2f3a; --shadow: 0 2px 6px rgba(0,0,0,0.35);
      --btn-yes: #4CAF50; --btn-no: #EF5350; --btn-same: #42A5F5; --btn-next: #42A5F5; --btn-back: #8e8e93; --btn-restart: #BA68C8; --btn-muted: #6c6f76; --btn-text: #ffffff;
      --thumb-border: #b5bcc8; --tick-color: rgba(255,255,255,.38); --track-bg: #2a2f3a;
      --if-accent: #5bd36a; --when-accent: #f1c24c; --result-accent: #c77dff;
    }
  }
  :root[data-theme="light"] { color-scheme: light; --bg:#f7f7f7; --card:#fff; --text:#111; --subtle-text:#333; --border:#ddd; --shadow:0 2px 6px rgba(0,0,0,.10);
    --btn-yes:#4CAF50; --btn-no:#F44336; --btn-same:#1E88E5; --btn-next:#2196F3; --btn-back:#555; --btn-restart:#9C27B0; --btn-muted:#9E9E9E; --btn-text:#fff;
    --thumb-border:#999; --tick-color:rgba(0,0,0,.35); --track-bg:#e0e0e0; --if-accent:#2e7d32; --when-accent:goldenrod; --result-accent:#9C27B0; }
  :root[data-theme="dark"] { color-scheme: dark; --bg:#0f1115; --card:#171a21; --text:#e9edf1; --subtle-text:#c7cbd2; --border:#2a2f3a; --shadow:0 2px 6px rgba(0,0,0,.35);
    --btn-yes:#4CAF50; --btn-no:#EF5350; --btn-same:#42A5F5; --btn-next:#42A5F5; --btn-back:#8e8e93; --btn-restart:#BA68C8; --btn-muted:#6c6f76; --btn-text:#fff;
    --thumb-border:#b5bcc8; --tick-color:rgba(255,255,255,.38); --track-bg:#2a2f3a; --if-accent:#5bd36a; --when-accent:#f1c24c; --result-accent:#c77dff; }

  body { background: var(--bg); color: var(--text); }
  .card { background: var(--card); color: var(--text); box-shadow: var(--shadow); border: 1px solid var(--border); }
  .segment-heading { border-bottom: 2px solid var(--border); }
  .flash-gold  { color: var(--when-accent) !important; }
  .flash-green { color: var(--if-accent) !important; }
  .flash-purple{ color: var(--result-accent) !important; }
  .panel { background: color-mix(in oklab, var(--card), var(--bg) 8%); border:1px solid var(--border); }
  .risk-inline { background: color-mix(in oklab, var(--card), var(--bg) 8%); border:1px solid var(--border); }
  .tick { background: var(--tick-color); }
  .heat-slider::-webkit-slider-thumb, .heat-slider::-moz-range-thumb, .heat-slider::-ms-thumb { border: 2px solid var(--thumb-border); }
  .segment-heading .skip-btn { background: color-mix(in oklab, var(--card), var(--text) 12%); color: var(--subtle-text); }
  .segment-heading .skip-btn:hover { background: color-mix(in oklab, var(--card), var(--text) 20%); }
  button { color: var(--btn-text); }
  button.yes{background:var(--btn-yes)} button.no{background:var(--btn-no)} button.same{background:var(--btn-same)} button.next{background:var(--btn-next)} button.back{background:var(--btn-back)} button.restart{background:var(--btn-restart)}
  button.examples-btn, button.viz-btn, button.reasoning-btn { background: var(--btn-muted); }

  /* Mini inline input row (Q6) */
  .mini-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:6px 0 12px}
  .mini-field{display:flex;flex-direction:column;gap:6px}
  .mini-field input, .mini-field select{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text)}
  .pill{border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:color-mix(in oklab, var(--card), var(--bg) 8%);margin-right:6px}
  .rule{font-weight:700;margin-top:6px}
  .verdict{margin-top:6px;font-weight:700}
</style>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-VJSYRKHSRM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-VJSYRKHSRM');
</script>
</head>
<body>
<div class="container">
  <div class="top-bar">
    <button class="back" id="backBtn" onclick="goBack()" type="button">Back</button>
    <button class="back" id="themeToggle" type="button" style="display:none;">Theme</button>
    <button class="restart" id="restartTop" onclick="restart()" type="button">Restart</button>
  </div>

  <div class="card">
    <div id="segmentHeading" class="segment-heading">
      <span id="segmentTitle" class="segment-title">
        <img src="./favicon_256_transparent.png" alt="Discernment Logo" class="logo" width="256" height="256" loading="eager" fetchpriority="high" decoding="sync">
        Discernment: A Decision-Making Guide
      </span>
      <button id="skipBtn" class="skip-btn" style="display:none;" title="Skip to When You Should Act" type="button">Skip ⏭</button>
    </div>

    <div>
      <div id="text" class="text"></div>

      <div class="controls-row">
        <div id="leftControlsWrapper" class="left-controls"></div>
        <div id="rightControlsWrapper" class="right-controls"></div>
      </div>

      <div id="miniInline" style="display:none;"></div>

      <div id="sharedPanel" class="panel" aria-hidden="true" role="region" aria-live="polite"></div>

      <div id="riskInline" class="risk-inline" aria-hidden="true"></div>

      <div id="errorBox" class="error" role="alert" aria-live="assertive"></div>
    </div>

    <div id="buttons" class="buttons"></div>
  </div>
</div>

<script>
/* ===== THEME ===== */
(function initTheme(){
  const root = document.documentElement;
  const themeBtn = document.getElementById('themeToggle');
  const mqDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
  let metaTheme = document.querySelector('meta[name="theme-color"]:not([media])');
  if (!metaTheme) { metaTheme = document.createElement('meta'); metaTheme.name = 'theme-color'; document.head.appendChild(metaTheme); }
  function getSetting(){ const s=localStorage.getItem('theme'); return (s==='light'||s==='dark'||s==='system')?s:'system'; }
  function effective(s){ if (s==='dark') return 'dark'; if (s==='light') return 'light'; return (mqDark&&mqDark.matches)?'dark':'light'; }
  function setThemeColor(e){ document.querySelector('meta[name="theme-color"]').setAttribute('content', e==='dark'?'#0b0b0d':'#ffffff'); }
  function label(){ if (!themeBtn) return; const s=getSetting(); const e=effective(s); themeBtn.textContent='Theme: '+s[0].toUpperCase()+s.slice(1); themeBtn.title='Effective: '+(e==='dark'?'Dark':'Light'); }
  function apply(s){ if (s==='system'){ root.removeAttribute('data-theme'); localStorage.setItem('theme','system'); } else { root.dataset.theme=s; localStorage.setItem('theme',s); } setThemeColor(effective(s)); label(); }
  apply(getSetting());
  if (themeBtn){ themeBtn.onclick=function(){ const s=getSetting(); const n=(s==='system')?'dark':(s==='dark'?'light':'system'); apply(n); }; }
  if (mqDark){ mqDark.addEventListener('change', ()=>{ if (getSetting()==='system'){ label(); setThemeColor(effective('system')); } }); }
  window.__refreshThemeButtonLabel = label;
})();

/* ===== FLOW (integrated, renumbered) ===== */
var flowchart = [
  { "id":"Q0","type":"info","text":"Welcome! This guide helps you determine both <i>IF</i> and <i>WHEN</i> you should act on an issue...","next":"Q1"},

  {"id":"Q1","type":"question","text":"Are there any other more important things to do or think about right now?","yes":"R1","no":"Q2"},
  {"id":"Q2","type":"question","text":"Is there a current <i>real problem</i> or desired functional QoL improvement...","yes":"Q8","no":"Q3"},
  {"id":"Q3","type":"question","text":"Is there cause for a potential <i>real problem</i>...","yes":"Q5","no":"Q4"},
  {"id":"Q4","type":"question","text":"Is there cause for a POTENTIAL cause for a POTENTIAL <i>real problem</i>...","yes":"Q5","no":"R2"},
  {"id":"Q5","type":"question","text":"Is the potential problem inevitable if left unaddressed?","yes":"Q8","no":"Q6"},

  /* NEW MINI SLIDES */
  {"id":"Q6","type":"mini","text":"Enter the severity, cost, and per-instance probability of the downside if you don’t act now. We’ll show when action becomes justified (conservative rule: on the line = Act)."},
  {"id":"Q7","type":"question","text":"It’s not worth acting based on the current values. Could any inputs reasonably change soon (e.g., higher probability, or severity vs. cost) that would flip the verdict?","yes":"R3","no":"Q19"},

  /* Old Q10..Q47 become Q8..Q45 */
  {"id":"Q8","type":"question","text":"Is there a solution (or at least partial solution)...","yes":"Q9","no":"R4"},
  {"id":"Q9","type":"question","text":"Can this solution or QoL improvement be <i>guaranteed</i> to be fully brought about as a result of <i>your</i> influence?","yes":"Q12","no":"Q10"},
  {"id":"Q10","type":"question","text":"Do everything in your power first... Is there anything further you can do?","yes":"Q12","no":"Q11"},
  {"id":"Q11","type":"question","text":"Is there an <i>alternative solution</i> that would solve the problem...","yes":"R5","no":"R2"},

  {"id":"Q12","type":"question","text":"Does this solution or QoL improvement involve gaining information that would be <i>valuable in the future</i>?","yes":"Q13","no":"Q14"},
  {"id":"Q13","type":"question","text":"Would the <i>information alone</i> gained from doing this outweigh the downsides...","yes":"Q29","no":"Q14"},

  {"id":"Q14","type":"question","text":"Would the expected benefits of addressing this issue outweigh the expected <i>upfront</i> costs...","yes":"Q15","no":"Q18"},
  {"id":"Q15","type":"question","text":"Would the expected benefits... outweigh any negative consequences that would likely arise <i>as a result</i>...","yes":"Q16","no":"Q18"},
  {"id":"Q16","type":"question","text":"Would the overall benefits... outweigh the <i>combined total</i>...","yes":"Q20","no":"Q18","same":"Q17"},

  {"id":"Q17","type":"question","text":"All things considered, would you <i>rather</i> address it than not?","yes":"Q20","no":"Q18"},
  {"id":"Q18","type":"question","text":"Is there a time further down the road that the answer to the <i>previous question</i> could be yes?","yes":"R3","no":"Q19"},
  {"id":"Q19","type":"question","text":"Is there an <i>alternative solution</i> that would solve the problem...","yes":"R5","no":"R2"},

  {"id":"Q20","type":"question","text":"Does addressing this issue involve a <i>diminishing returns</i> curve for effort applied?","yes":"Q21","no":"Q22"},
  {"id":"Q21","type":"info","text":"Find the <i>point of diminishing returns</i> and stop there...","next":"Q22"},
  {"id":"Q22","type":"question","text":"Does addressing this issue directly involve an <i>inverted-U curve</i>...","yes":"Q23","no":"Q24"},
  {"id":"Q23","type":"info","text":"Wait until there aren’t any other more important things to do... find that <i>sweet spot</i>...","next":"Q29"},

  {"id":"Q24","type":"question","text":"In practice and given time, would a <i>functional difference</i>... likely be noticed...","yes":"Q25","no":"R2"},
  {"id":"Q25","type":"question","text":"Would solving/addressing it help get rid of/prevent the problem... in the <i>long term</i>?","yes":"Q29","no":"Q26"},
  {"id":"Q26","type":"question","text":"Would solving/addressing it help get rid of/prevent the problem... in the <i>short term</i>?","yes":"Q27","no":"R2"},
  {"id":"Q27","type":"question","text":"Is it logically worth solving/addressing <i>EVERY time this situation arises</i>?","yes":"Q29","no":"Q28"},
  {"id":"Q28","type":"question","text":"Is there an <i>alternative solution</i> that would solve the problem...","yes":"R5","no":"R2"},

  /* WHEN */
  {"id":"Q29","type":"question","text":"Does this address a potential <i>future</i> problem?","yes":"Q30","no":"Q33"},
  {"id":"Q30","type":"question","text":"Does addressing this issue involve <i>preventative maintenance</i>?","yes":"Q35","no":"Q33"},

  {"id":"Q31","type":"info","text":"Set the estimated catastrophic severity if you waited too long to act. (1-10)","next":"Q32"},
  {"id":"Q32","type":"question","text":"Would there be <i>guaranteed clear telltale signs</i>...","yes":"Q44","no":"Q45"},

  {"id":"Q33","type":"question","text":"Is this the <i>most effective solution</i> you know of (that meets the previous criteria), assuming you could do it whenever you wanted?","yes":"Q37","no":"Q34"},
  {"id":"Q34","type":"question","text":"Have you considered <i>all better solutions</i> you know of?","yes":"Q37","no":"R5"},

  {"id":"Q35","type":"question","text":"Is this the <i>most effective solution</i> you know of (that meets the previous criteria)?","yes":"Q31","no":"Q36"},
  {"id":"Q36","type":"question","text":"Have you considered <i>all better solutions</i> you know of?","yes":"Q31","no":"R5"},

  {"id":"Q37","type":"question","text":"Is this solution <i>currently</i> available?","yes":"Q38","no":"Q39"},
  {"id":"Q38","type":"question","text":"Is there a <i>better time</i> down the road to solve/address this to <i>maximize value</i>?","yes":"Q39","no":"R7"},

  {"id":"Q39","type":"question","text":"Assuming you waited until it was available, would the expected <i>overall benefits</i>... outweigh the expected <i>overall downsides</i> of having to wait?","yes":"Q42","no":"Q41","same":"Q40"},
  {"id":"Q40","type":"question","text":"All things considered, would you <i>rather</i> use this solution?","yes":"Q42","no":"Q41"},

  {"id":"Q41","type":"question","text":"Is there a <i>next best</i> solution you know of?","yes":"R5","no":"R4"},
  {"id":"Q42","type":"question","text":"Is there a <i>better time</i> further down the road than when this solution is available...","yes":"R8","no":"R6"},
  {"id":"Q43","type":"question","text":"Is there a <i>better time</i> further down the road than at that time...","yes":"R8","no":"R6"},

  {"id":"Q44","type":"question","text":"Normally you should solve/address it as soon as both of the following are true: <ul><li><i>Those telltale signs</i> indicate that failure is approaching.</li><li>The <i>estimated chance of failure</i> is nearing or greater than 50%.</li></ul> However, is there a <i>better time</i> before or after that time to solve/address this to <i>maximize value</i>?","yes":"R8","no":"R9"},
  {"id":"Q45","type":"question","text":"Normally you should solve/address it as soon as the <i>estimated chance of failure</i> is nearing or greater than 50%. However, is there a <i>better time</i> before or after that time to solve/address this to <i>maximize value</i>?","yes":"R8","no":"R9"},

  {"id":"R1","type":"result","text":"Worry about this <i>once those things are addressed</i> and the time is right."},
  {"id":"R2","type":"result","text":"<i>Don’t worry about it:)</i>"},
  {"id":"R3","type":"result","text":"If that time ever does come, re-evaluate the issue..."},
  {"id":"R4","type":"result","text":"Wait until there aren’t any other more important things to do... <i>find a solution or solutions</i>."},
  {"id":"R5","type":"result","text":"Consider any other solutions... Run them through the chart."},
  {"id":"R6","type":"result","text":"Wait until this solution is available, then solve it once there aren’t any other more important things to do..."},
  {"id":"R7","type":"result","text":"Address it <i>sooner than later</i>, once there aren’t any other more important things to do."},
  {"id":"R8","type":"result","text":"Wait until that better time, then solve/address it once there aren't any other more important things to do..."},
  {"id":"R9","type":"result","text":"Solve/address it as soon as the criteria from the <i>previous slide</i> are met..."},

  {"id":"AB0","type":"aboutMenu","heading":"About","text":"Choose a section to learn more..." },
  {"id":"AB1","type":"about","heading":"About Me","text":"Hi! My name is Packer..."},
  {"id":"AB2","type":"about","heading":"Guide Concepts Explained","text":"<p>This guide is built to prevent wasted effort...</p>"}
];

/* ===== Examples (trimmed to key nodes for brevity) ===== */
window.examples = {
  "Q1":["Finish homework due tonight...","Call the dentist first if you’re in pain..."],
  "Q6":["Enter realistic S (up to 10), C (up to 10), and probability.","Use percentage, micromorts, or 1-in-X depending on context."],
  "Q7":["If a sale ends soon, probability of downside rising may flip verdict.","A recalled part increases risk soon—recheck values."],
  "Q20":["Editing a video: each extra pass improves less and less.","Polishing a resume: beyond a few rounds, gains are tiny."],
  "Q22":["Strength training has a sweet spot.","Caffeine has an optimal dose."],
  "Q44":["Replace chain when indicators show.","Service A/C on approaching failure signs."],
  "Q45":["Replace batteries when chance nears threshold.","Swap UPS battery when capacity dips near limit."]
};

/* ===== STATE ===== */
var currentThresholdPct = 90;
var hasFlashedIf = false;
var hasFlashedWhen = false;
var lastWasResult = false;
var originalTitleHTML = null;
var historyStack = [];
var currentNode = flowchart.find(n=>n.id==="Q0");
var currentSegment = "If You Should Act";

/* Mini state */
const EPS = 1e-9, MAX_SC = 10;
const ALPHA = Math.log(0.5) / Math.log((Math.sqrt(10) - 1) / 9);
const mini = { S:5, C:1, mode:'oneInX', pVal:1000000, X_user:1000000, act:null };
let skipBenefitTrio = false; // if verdict=act on Q6, skip Q14–Q16 later

function Xcutoff_from_ratio(r){ const tRaw=(r-1)/9; const t=Math.max(0,Math.min(1,tRaw)); const exponent=6*Math.pow(t,ALPHA); return Math.pow(10,exponent); }
function computeSCutoffForX(X){ return 1 + 9 * Math.pow((Math.log10(X)/6), 1/ALPHA); }
function normalizeToX(mode,val){
  if (mode==='oneInX'){ if (!(val>1)) return null; return val; }
  if (mode==='percent'){ if (!(val>0 && val<100)) return null; return 100/val; }
  if (mode==='micromort'){ if (!(val>0 && val<1e6)) return null; return 1e6/val; }
  return null;
}
function cutoffLabelForMode(mode){ return mode==='percent'?'Cutoff (%)':(mode==='micromort'?'Cutoff (µm)':'Cutoff (X)'); }
function probRuleName(mode){ return mode==='percent'?'%':(mode==='micromort'?'µm':'X'); }
function cutoffInUnit(Xc, mode){ return mode==='percent'?(100/Xc):(mode==='micromort'?(1e6/Xc):Xc); }
function ceilPlaces(x,p=2){ const f=10**p; return Math.ceil(x*f)/f; }

/* Segments */
function getSegmentForNodeId(id){ if (!id || id.charAt(0)!=='Q') return currentSegment; const m=/^Q(\d+)$/.exec(id); if(!m) return currentSegment; return (parseInt(m[1],10)>=29)?"When You Should Act":"If You Should Act"; }

function setHeadingText(node){
  var title = document.getElementById('segmentTitle');
  var skipBtn = document.getElementById('skipBtn');
  if (!node){ title.textContent=''; skipBtn.style.display='none'; return; }
  if ((node.type==='about'||node.type==='aboutMenu') && node.heading){ title.textContent=node.heading; skipBtn.style.display='none'; return; }
  if (node.id==='Q0'){ if (originalTitleHTML) title.innerHTML = originalTitleHTML; skipBtn.style.display='none'; return; }
  if (node.type==='result'){ title.textContent="👍👎 Verdict"; skipBtn.style.display='none'; return; }
  var segText = (currentSegment === "If You Should Act") ? "⚖️ If You Should Act" : "⏳ When You Should Act";
  title.textContent = segText;
  skipBtn.style.display = (currentSegment === "If You Should Act" && node.type !== 'result') ? 'inline-block' : 'none';
}

function flashHeadingColor(targetSegment, node){
  if (currentNode && currentNode.id==='Q0') return;
  var headingDiv = document.getElementById('segmentHeading');
  if (node && node.type==='result'){ headingDiv.classList.add('flash-purple'); setTimeout(()=>headingDiv.classList.remove('flash-purple'),1500); return; }
  var cls = (targetSegment==="If You Should Act")?'flash-green':'flash-gold';
  headingDiv.classList.add(cls); setTimeout(()=>headingDiv.classList.remove(cls),1500);
}

function collapseSharedPanel(){
  var panel = document.getElementById('sharedPanel');
  if (panel){ panel.style.display='none'; panel.setAttribute('aria-hidden','true'); panel.dataset.mode=''; panel.innerHTML=''; }
  var leftWrap = document.getElementById('leftControlsWrapper');
  var rightWrap= document.getElementById('rightControlsWrapper');
  if (leftWrap){ leftWrap.querySelectorAll('.examples-btn').forEach(b=>{ b.textContent='Show Examples'; b.setAttribute('aria-expanded','false'); b.classList.remove('active'); }); }
  if (rightWrap){ rightWrap.querySelectorAll('.viz-btn,.reasoning-btn').forEach(btn=>{ if (btn.classList.contains('viz-btn')) btn.textContent='Show Visualization'; if (btn.classList.contains('reasoning-btn')) btn.textContent='Show Percentage Reasoning'; btn.setAttribute('aria-expanded','false'); btn.classList.remove('active'); }); }
}

function openSharedPanel(panel, mode){
  if (!panel) return;
  panel.style.display='block'; panel.setAttribute('aria-hidden','false'); panel.dataset.mode=mode;
  var leftWrap = document.getElementById('leftControlsWrapper');
  var rightWrap= document.getElementById('rightControlsWrapper');
  var exBtn = leftWrap? leftWrap.querySelector('.examples-btn'):null;
  var vzBtn = rightWrap? rightWrap.querySelector('.viz-btn'):null;
  var rsBtn = rightWrap? rightWrap.querySelector('.reasoning-btn'):null;
  if (mode==='examples'){ if (exBtn) exBtn.textContent='Hide Examples'; if (vzBtn) vzBtn.textContent='Show Visualization'; if (rsBtn) rsBtn.textContent='Show Percentage Reasoning'; }
  else if (mode==='viz'){ if (vzBtn) vzBtn.textContent='Hide Visualization'; if (exBtn) exBtn.textContent='Show Examples'; }
  else if (mode==='reason'){ if (rsBtn) rsBtn.textContent='Hide Percentage Reasoning'; if (exBtn) exBtn.textContent='Show Examples'; }
}

function setupAuxToggles(node){
  var leftWrap = document.getElementById('leftControlsWrapper');
  var rightWrap= document.getElementById('rightControlsWrapper');
  var panel = document.getElementById('sharedPanel');
  leftWrap.innerHTML=''; rightWrap.innerHTML=''; collapseSharedPanel();

  // Show aux for questions and for Q6 (mini) and Q31 (severity)
  var allowAux = (node.type==='question') || (node.id==='Q31') || (node.id==='Q6');
  if (!allowAux) return;

  // LEFT examples
  var examplesBtn = document.createElement('button');
  examplesBtn.type='button'; examplesBtn.textContent='Show Examples';
  examplesBtn.className='examples-btn ctrl-btn'; examplesBtn.setAttribute('aria-expanded','false');
  leftWrap.appendChild(examplesBtn);
  examplesBtn.onclick = function(){
    var open = panel.style.display==='block' && panel.dataset.mode==='examples';
    if (open){ collapseSharedPanel(); }
    else { panel.innerHTML=''; renderExamples(panel, node.id); openSharedPanel(panel,'examples'); examplesBtn.setAttribute('aria-expanded','true'); examplesBtn.classList.add('active'); }
  };

  // RIGHT: Q6/Q7 get viz, Q22/Q24 etc handled as images if needed
  if (node.id==='Q6' || node.id==='Q7'){
    var vizBtn = document.createElement('button');
    vizBtn.type='button'; vizBtn.textContent='Show Visualization';
    vizBtn.className='viz-btn ctrl-btn'; vizBtn.setAttribute('aria-expanded','false');
    rightWrap.appendChild(vizBtn);
    vizBtn.onclick = function(){
      var isOpen = panel.style.display==='block' && panel.dataset.mode==='viz';
      if (isOpen){ collapseSharedPanel(); }
      else { panel.innerHTML=''; renderMiniViz(panel, node.id==='Q7'); openSharedPanel(panel,'viz'); vizBtn.setAttribute('aria-expanded','true'); vizBtn.classList.add('active'); }
    };
  }
}

function renderExamples(panel, nodeId){
  panel.innerHTML='';
  const lines = (window.examples && window.examples[nodeId]) || ["Example 1","Example 2"];
  lines.forEach(t=>{ const p=document.createElement('p'); p.textContent=t; panel.appendChild(p); });
}

/* ===== Mini inline (Q6) ===== */
function renderMiniInline(){
  const host = document.getElementById('miniInline');
  host.innerHTML = `
    <div class="mini-row">
      <div class="mini-field">
        <label for="sev">Severity (S) — up to 10</label>
        <input id="sev" type="number" max="10" step="0.01" value="${mini.S}" inputmode="decimal">
      </div>
      <div class="mini-field">
        <label for="cost">Cost (C) — up to 10</label>
        <input id="cost" type="number" max="10" step="0.01" value="${mini.C}" inputmode="decimal">
      </div>
    </div>
    <div class="mini-row">
      <div class="mini-field">
        <label for="probMode">Probability input mode</label>
        <select id="probMode">
          <option value="oneInX"${mini.mode==='oneInX'?' selected':''}>1 in X</option>
          <option value="percent"${mini.mode==='percent'?' selected':''}>Percentage (%)</option>
          <option value="micromort"${mini.mode==='micromort'?' selected':''}>Micromorts</option>
        </select>
      </div>
      <div class="mini-field">
        <label id="probLabel" for="probVal">Enter X (for “1 in X”)</label>
        <input id="probVal" type="number" min="2" step="1" value="${mini.pVal}" inputmode="decimal">
      </div>
    </div>
    <div class="pill"><span id="cutoffLabel">${cutoffLabelForMode(mini.mode)}</span>: <span id="cutoffOut">—</span></div>
    <div class="pill">S/C Cutoff: <span id="ratioCutOut">—</span></div>
    <div class="rule" id="ruleLine">Rule: Only if <span id="probRuleName">${probRuleName(mini.mode)}</span> ≥ <b>Probability Cutoff</b> and <b>S/C ≥ S/C Cutoff</b> can action be considered.</div>
    <div class="verdict" id="verdictLine">Verdict: <span id="verdictText">—</span></div>
  `;
  const sevEl = document.getElementById('sev');
  const costEl= document.getElementById('cost');
  const probModeEl=document.getElementById('probMode');
  const probValEl =document.getElementById('probVal');
  const cutoffLabelEl=document.getElementById('cutoffLabel');
  const cutoffOut=document.getElementById('cutoffOut');
  const ratioCutOut=document.getElementById('ratioCutOut');
  const probRuleNameEl=document.getElementById('probRuleName');
  const verdictText=document.getElementById('verdictText');
  function setProbConstraints(){
    const m=probModeEl.value; const lab=document.getElementById('probLabel');
    if (m==='oneInX'){ lab.textContent='Enter X (for “1 in X”)'; probValEl.min='2'; probValEl.step='1'; probValEl.placeholder='1000000'; probValEl.max=''; }
    else if (m==='percent'){ lab.textContent='Enter percentage (%)'; probValEl.min='0.000001'; probValEl.max='99.999999'; probValEl.step='0.0001'; probValEl.placeholder='0.01'; }
    else { lab.textContent='Enter micromorts (µm)'; probValEl.min='0.0001'; probValEl.max='999999.99'; probValEl.step='0.01'; probValEl.placeholder='1'; }
  }
  function commit(){
    let S=parseFloat(sevEl.value); if (!isFinite(S)) S=mini.S; if (S<=0) S=EPS; S=Math.min(S,MAX_SC);
    let C=parseFloat(costEl.value); if (!isFinite(C)) C=mini.C; if (C<=0) C=EPS; C=Math.min(C,MAX_SC);
    mini.S=S; mini.C=C;
    const m=probModeEl.value; mini.mode=m; setProbConstraints();
    let pv=parseFloat(probValEl.value); if (!isFinite(pv)) pv=mini.pVal;
    if (m==='oneInX' && pv<2) pv=2;
    if (m==='percent'){ if (pv<=0) pv=0.000001; if (pv>=100) pv=99.999999; }
    if (m==='micromort'){ if (pv<=0) pv=0.0001; if (pv>=1e6) pv=999999.99; }
    mini.pVal=pv; mini.X_user = normalizeToX(m, pv);
    // stats
    const r = mini.S/mini.C;
    const Xc = Xcutoff_from_ratio(r);
    const cutUnit = cutoffInUnit(Xc, m);
    cutoffLabelEl.textContent = cutoffLabelForMode(m);
    probRuleNameEl.textContent = probRuleName(m);
    cutoffOut.textContent = (m==='oneInX')?Math.round(cutUnit).toLocaleString():(m==='percent'?ceilPlaces(cutUnit,6):ceilPlaces(cutUnit,2));
    const rCut = computeSCutoffForX(mini.X_user ?? 2);
    ratioCutOut.textContent = rCut.toFixed(2);
    const act = (mini.X_user != null) ? (mini.X_user <= Xc + 1e-15) : null;
    mini.act = act;
    verdictText.textContent = act===null?'—':(act?'Action should be considered.':'Action should NOT be considered.');
    verdictText.style.color = act? getComputedStyle(document.documentElement).getPropertyValue('--if-accent').trim() : '';
    // refresh viz if open
    const panel=document.getElementById('sharedPanel');
    if (panel.style.display==='block' && panel.dataset.mode==='viz' && window.__updateVizShared){ window.__updateVizShared(); }
  }
  probModeEl.addEventListener('change', ()=>{ setProbConstraints(); commit(); });
  sevEl.addEventListener('change', commit); sevEl.addEventListener('blur', commit);
  costEl.addEventListener('change', commit); costEl.addEventListener('blur', commit);
  probValEl.addEventListener('change', commit); probValEl.addEventListener('blur', commit);
  setProbConstraints(); commit();
}

/* ===== Mini visualization (panel) ===== */
function renderMiniViz(panel, readonlyMirrors){
  panel.innerHTML='';
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','0 0 900 580'); svg.style.touchAction='none'; panel.appendChild(svg);

  const axesG = document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(axesG);
  const gridG = document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(gridG);
  const shadeIn = document.createElementNS('http://www.w3.org/2000/svg','path'); shadeIn.setAttribute('fill','#5bd36a22'); svg.appendChild(shadeIn);
  const curve = document.createElementNS('http://www.w3.org/2000/svg','path'); curve.setAttribute('fill','none'); curve.setAttribute('stroke','#1f4cff'); curve.setAttribute('stroke-width','2'); svg.appendChild(curve);
  const handle = document.createElementNS('http://www.w3.org/2000/svg','circle'); handle.setAttribute('r','11'); handle.setAttribute('fill','#ff3b3b'); handle.setAttribute('stroke','#fff'); handle.setAttribute('stroke-width','2'); svg.appendChild(handle);
  handle.style.touchAction='none';
  const labelG = document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(labelG);
  const labelBg = document.createElementNS('http://www.w3.org/2000/svg','rect'); labelBg.setAttribute('rx','10'); labelBg.setAttribute('ry','10'); labelBg.setAttribute('fill','#fff'); labelBg.setAttribute('fill-opacity','0.98'); labelBg.setAttribute('stroke','#ccc'); labelG.appendChild(labelBg);
  const labelTx = document.createElementNS('http://www.w3.org/2000/svg','text'); labelTx.setAttribute('font-size','15'); labelTx.setAttribute('font-weight','700'); labelG.appendChild(labelTx);

  const pad = { left:94, right:24, top:28, bottom:78 };
  const W=900, H=580, plotW=W-pad.left-pad.right, plotH=H-pad.top-pad.bottom;
  const rMin=1, rMax=10;

  function yConf(mode){
    if (mode==='percent') return { yMin:0.0001, yMax:100, ticks:[100,10,1,0.1,0.01,0.001,0.0001], label:"Cutoff Probability (%) (log scale)" };
    if (mode==='micromort') return { yMin:1, yMax:1e6, ticks:[1e6,1e5,1e4,1e3,100,10,1], label:"Cutoff Probability (µm) (log scale)" };
    return { yMin:1, yMax:1e6, ticks:[1,10,100,1e3,1e4,1e5,1e6], label:"Cutoff Probability as '1 in X' (log scale)" };
  }
  const rToPx = (r)=> pad.left + (r-rMin)/(rMax-rMin)*plotW;
  const pxToR = (px)=> (rMin + (px-pad.left)/plotW*(rMax-rMin));
  function yToPx(y,yMin,yMax){ return pad.top + plotH * (1 - (Math.log10(y)-Math.log10(yMin))/(Math.log10(yMax)-Math.log10(yMin))); }

  function drawAxes(mode){
    axesG.innerHTML=''; gridG.innerHTML='';
    const axisColor = getComputedStyle(document.documentElement).getPropertyValue('--text').trim();
    const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--tick-color').trim() || '#999';
    // vertical grid + x ticks
    for (let r=1;r<=10;r++){
      const x=rToPx(r);
      const g=document.createElementNS('http://www.w3.org/2000/svg','line'); g.setAttribute('x1',x); g.setAttribute('x2',x); g.setAttribute('y1',pad.top); g.setAttribute('y2',pad.top+plotH); g.setAttribute('stroke',gridColor); g.setAttribute('stroke-width','1'); g.setAttribute('opacity','0.35'); gridG.appendChild(g);
      const tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x',x); tx.setAttribute('y',H-30); tx.setAttribute('text-anchor','middle'); tx.setAttribute('fill',axisColor); tx.setAttribute('font-size','13'); tx.setAttribute('font-weight','600'); tx.textContent=r; axesG.appendChild(tx);
    }
    // horizontal grid + y ticks
    const {yMin,yMax,ticks,label} = yConf(mode);
    ticks.forEach(y=>{
      const yp = yToPx(y,yMin,yMax);
      const g=document.createElementNS('http://www.w3.org/2000/svg','line'); g.setAttribute('x1',pad.left); g.setAttribute('x2',pad.left+plotW); g.setAttribute('y1',yp); g.setAttribute('y2',yp); g.setAttribute('stroke',gridColor); g.setAttribute('stroke-width','1'); g.setAttribute('opacity','0.35'); gridG.appendChild(g);
      const ty=document.createElementNS('http://www.w3.org/2000/svg','text'); ty.setAttribute('x', 18); ty.setAttribute('y', yp+5); ty.setAttribute('fill',axisColor); ty.setAttribute('font-size','13'); ty.setAttribute('font-weight','600');
      ty.textContent = (mode==='percent' ? (y>=1?y.toString():y.toExponential(1)) : y.toLocaleString()); axesG.appendChild(ty);
    });
    const xlab=document.createElementNS('http://www.w3.org/2000/svg','text');
    xlab.setAttribute('x', pad.left+plotW/2); xlab.setAttribute('y', H-8); xlab.setAttribute('text-anchor','middle'); xlab.setAttribute('fill',axisColor); xlab.setAttribute('font-size','14'); xlab.setAttribute('font-weight','700'); xlab.textContent="Severity / Cost Ratio (S / C)"; axesG.appendChild(xlab);
    const ylab=document.createElementNS('http://www.w3.org/2000/svg','text');
    ylab.setAttribute('transform',`translate(12 ${pad.top+plotH/2}) rotate(-90)`); ylab.setAttribute('text-anchor','middle'); ylab.setAttribute('fill',axisColor); ylab.setAttribute('font-size','14'); ylab.setAttribute('font-weight','700'); ylab.textContent=label; axesG.appendChild(ylab);
  }

  function XtoYUnit(X,mode){ return (mode==='percent') ? (100/X) : (mode==='micromort' ? (1e6/X) : X); }

  function buildCurve(mode){
    const {yMin,yMax} = yConf(mode);
    const N=400, pts=[];
    for(let i=0;i<=N;i++){
      const r = 1 + 9*(i/N);
      const X = Xcutoff_from_ratio(r);
      const Y = XtoYUnit(X, mode);
      pts.push([rToPx(r), yToPx(Y, yMin, yMax)]);
    }
    const d = pts.map(([x,y],i)=> (i?`L ${x},${y}`:`M ${x},${y}`)).join(' ');
    curve.setAttribute('d', d);
    const yFloor = yToPx(yConf(mode).yMin, yConf(mode).yMin, yConf(mode).yMax);
    shadeIn.setAttribute('d', d + ` L ${rToPx(10)},${yFloor} L ${rToPx(1)},${yFloor} Z`);
  }

  let eMode = mini.mode, eS=mini.S, eC=mini.C, eX=mini.X_user;
  function updateVizCore(){
    drawAxes(eMode); buildCurve(eMode);
    const {yMin,yMax}=yConf(eMode);
    const r = eS/eC;
    const Xc = Xcutoff_from_ratio(r);
    const Yc = XtoYUnit(Xc, eMode);
    const cx = rToPx(Math.max(1,Math.min(10,r)));
    const cy = yToPx(Yc,yMin,yMax);
    handle.setAttribute('cx', cx); handle.setAttribute('cy', cy);
    // label
    const label = `S=${eS} , C=${eC}  ·  S/C=${(r).toFixed(3)}  ·  X≈${(eMode==='oneInX'?Math.round(Xc).toLocaleString():(eMode==='percent'?ceilPlaces(100/Xc,6):ceilPlaces(1e6/Xc,2)))}`;
    labelTx.textContent=label; labelTx.setAttribute('text-anchor','middle');
    let ly = cy - 34; if (ly < pad.top + 18) ly = pad.top + 18;
    labelTx.setAttribute('x', cx); labelTx.setAttribute('y', ly);
    const bb = labelTx.getBBox(); const padBox=10;
    labelBg.setAttribute('x', bb.x-padBox); labelBg.setAttribute('y', bb.y-padBox);
    labelBg.setAttribute('width', bb.width+2*padBox); labelBg.setAttribute('height', bb.height+2*padBox);
    // mirror inline stats
    const ratioCutOut = document.getElementById('ratioCutOut');
    if (ratioCutOut){ const rCut = computeSCutoffForX(eX ?? 2); ratioCutOut.textContent = rCut.toFixed(2); }
    const cutoffLabelEl=document.getElementById('cutoffLabel');
    const cutoffOut=document.getElementById('cutoffOut');
    const probRuleNameEl=document.getElementById('probRuleName');
    if (cutoffLabelEl && cutoffOut && probRuleNameEl){
      cutoffLabelEl.textContent = cutoffLabelForMode(eMode);
      probRuleNameEl.textContent = probRuleName(eMode);
      const cutUnit = cutoffInUnit(Xc, eMode);
      cutoffOut.textContent = (eMode==='oneInX')?Math.round(cutUnit).toLocaleString():(eMode==='percent'?ceilPlaces(cutUnit,6):ceilPlaces(cutUnit,2));
    }
  }

  function chooseSCFromRatio(r, prevS, prevC){
    let S=Math.max(prevS,EPS); S=Math.min(S,MAX_SC);
    let C=S/r;
    if (C<=EPS || C>MAX_SC){ C=Math.max(prevC,EPS); C=Math.min(C,MAX_SC); S=r*C; }
    S=Math.min(Math.max(S,EPS),MAX_SC); C=Math.min(Math.max(C,EPS),MAX_SC);
    return {S,C};
  }

  // Dragging
  let dragging=false;
  function onPointerDown(e){ e.preventDefault(); dragging=true; try{handle.setPointerCapture(e.pointerId);}catch(_){} onPointerMove(e); }
  function onPointerMove(e){
    if(!dragging) return; e.preventDefault();
    const pt=svg.createSVGPoint(); pt.x=e.clientX; pt.y=e.clientY;
    const sp=pt.matrixTransform(svg.getScreenCTM().inverse());
    const px=Math.max(pad.left, Math.min(pad.left+plotW, sp.x));
    const r=pxToR(px);
    const chosen=chooseSCFromRatio(r, mini.S, mini.C);
    eS=chosen.S; eC=chosen.C;
    // reflect into mini + inline inputs
    mini.S=eS; mini.C=eC;
    const sevEl=document.getElementById('sev'); const costEl=document.getElementById('cost');
    if (sevEl) sevEl.value=eS; if (costEl) costEl.value=eC;
    updateVizCore(); // updates labels
    // re-evaluate verdict
    const rnow = mini.S/mini.C; const Xc=Xcutoff_from_ratio(rnow);
    const act = (mini.X_user!=null) ? (mini.X_user <= Xc + 1e-15) : null;
    mini.act=act;
    const verdictText=document.getElementById('verdictText');
    if (verdictText){ verdictText.textContent = act===null?'—':(act?'Action should be considered.':'Action should NOT be considered.'); verdictText.style.color = act? getComputedStyle(document.documentElement).getPropertyValue('--if-accent').trim() : ''; }
  }
  function onPointerUp(e){ dragging=false; try{handle.releasePointerCapture(e.pointerId);}catch(_){} }

  handle.addEventListener('pointerdown', onPointerDown, {passive:false});
  svg.addEventListener('pointermove', onPointerMove, {passive:false});
  window.addEventListener('pointerup', onPointerUp, {passive:false});

  window.__updateVizShared = function(){
    eMode = mini.mode; eS = mini.S; eC = mini.C; eX = mini.X_user;
    updateVizCore();
  };
  eMode = mini.mode; eS = mini.S; eC = mini.C; eX = mini.X_user; updateVizCore();
}

/* NAV */
function makeButton(label, cls, action){ var btn=document.createElement('button'); btn.type='button'; btn.textContent=label; btn.className=cls; btn.onclick=action; return btn; }

function beforeEnterNode(nextId){
  // If we decided to act in Q6, skip the benefit trio later (Q14–Q16) straight to Q20
  if (skipBenefitTrio && (nextId==='Q14' || nextId==='Q15' || nextId==='Q16')) return 'Q20';
  return nextId;
}

function goToNode(id){
  collapseSharedPanel();
  var adjustedId = beforeEnterNode(id);
  var next = flowchart.find(n=>n.id===adjustedId);
  historyStack.push(currentNode ? currentNode.id : '');
  currentNode = next; renderNode(currentNode);
}
function goBack(){
  collapseSharedPanel();
  var prevId = historyStack.pop();
  var prev = flowchart.find(n=>n.id===prevId);
  currentNode = prev || currentNode; renderNode(currentNode);
}
function restart(){
  collapseSharedPanel();
  historyStack = [];
  currentSegment = "If You Should Act";
  currentNode = flowchart.find(n=>n.id==="Q0");
  hasFlashedIf=false; hasFlashedWhen=false; lastWasResult=false; skipBenefitTrio=false;
  mini.S=5; mini.C=1; mini.mode='oneInX'; mini.pVal=1000000; mini.X_user=1000000; mini.act=null;
  if (originalTitleHTML){ document.getElementById('segmentTitle').innerHTML = originalTitleHTML; document.getElementById('skipBtn').style.display='none'; }
  renderNode(currentNode);
}

document.getElementById('skipBtn').addEventListener('click', function(){ collapseSharedPanel(); goToNode('Q29'); });

if (!originalTitleHTML) originalTitleHTML = document.getElementById('segmentTitle').innerHTML;
renderNode(currentNode);

function renderNode(node){
  collapseSharedPanel();
  var errorBox = document.getElementById('errorBox'); errorBox.textContent='';
  if (!node){
    errorBox.textContent="Error: missing node."; document.getElementById('text').textContent=''; document.getElementById('buttons').innerHTML='';
    setHeadingText(''); document.getElementById('backBtn').style.visibility = historyStack.length>0?'visible':'hidden';
    document.getElementById('restartTop').style.display='inline-block'; return;
  }
  if (node.id==='Q0') hasFlashedIf=false;
  var previousSegment=currentSegment;
  var thisSegment=(node.type==='about'||node.type==='aboutMenu')?previousSegment:getSegmentForNodeId(node.id);
  var comingFromResult=lastWasResult && node.type!=='result';
  var shouldFlash = node.id!=='Q0' && (node.type==='result'||comingFromResult||thisSegment!==previousSegment|| (thisSegment==="If You Should Act"&&!hasFlashedIf) || (thisSegment==="When You Should Act"&&!hasFlashedWhen));
  if (shouldFlash && !(node.type==='about'||node.type==='aboutMenu')){ flashHeadingColor(thisSegment, node); if (thisSegment==="If You Should Act") hasFlashedIf=true; if (thisSegment==="When You Should Act") hasFlashedWhen=true; }
  currentSegment=thisSegment; setHeadingText(node); lastWasResult=(node.type==='result');

  var textDiv=document.getElementById('text');
  var displayHTML=node.text||'';
  if (node.id==='Q44' || node.id==='Q45'){
    displayHTML = displayHTML.replace(/50%/g, String(currentThresholdPct)+'%');
    textDiv.innerHTML = '<div class="result-text">'+displayHTML+'</div>';
  } else {
    textDiv.innerHTML = displayHTML;
  }

  // Theme toggle only on Q0
  var themeBtn=document.getElementById('themeToggle');
  if (themeBtn){ themeBtn.style.display=(node.id==='Q0')?'inline-block':'none'; if (node.id==='Q0' && window.__refreshThemeButtonLabel) window.__refreshThemeButtonLabel(); }
  document.getElementById('backBtn').style.visibility = historyStack.length>0?'visible':'hidden';

  setupAuxToggles(node);

  // Q31 severity slider display (unchanged)
  document.getElementById('riskInline').style.display = (node.id==='Q31')?'block':'none';
  if (node.id==='Q31'){ /* existing slider could be re-used if needed */ }

  // Q6 mini inputs inline
  const miniHost=document.getElementById('miniInline');
  if (node.id==='Q6'){ miniHost.style.display='block'; renderMiniInline(); }
  else { miniHost.style.display='none'; miniHost.innerHTML=''; }

  // Buttons
  var btns=document.getElementById('buttons'); btns.innerHTML='';
  const restartTop=document.getElementById('restartTop');
  if (node.type==='result'){
    restartTop.style.display='none'; btns.classList.add('center');
    const restartCentered=makeButton('Restart','restart',()=>restart()); restartCentered.style.flex='0 0 auto'; btns.appendChild(restartCentered);
  } else {
    restartTop.style.display=(node.id==='Q0')?'none':'inline-block'; btns.classList.remove('center');
    if (node.type==='about'){ return; }
    if (node.type==='aboutMenu'){ btns.appendChild(makeButton('About Me','next',()=>goToNode('AB1'))); btns.appendChild(makeButton('Guide Concepts Explained','next',()=>goToNode('AB2'))); return; }

    if (node.id==='Q6'){
      // Continue decides routing based on mini.act
      const cont = makeButton('Continue','next',()=>{
        // decide verdict
        const r=mini.S/mini.C; const Xc=Xcutoff_from_ratio(r);
        const act = (mini.X_user!=null) ? (mini.X_user <= Xc + 1e-15) : null;
        mini.act = act;
        if (act){ skipBenefitTrio = true; goToNode('Q8'); } else { goToNode('Q7'); }
      });
      btns.appendChild(cont);
    } else if (node.id==='Q7'){
      // Yes / No buttons like Q20 logic (old), yes -> R3, no -> Q19
      btns.appendChild(makeButton('Yes','yes',()=>goToNode('R3')));
      btns.appendChild(makeButton('No','no',()=>goToNode('Q19')));
    } else if (node.type==='question'){
      const yesBtn=makeButton('Yes','yes',()=>goToNode(node.yes));
      const noBtn =makeButton('No','no', ()=>goToNode(node.no));
      btns.appendChild(yesBtn); btns.appendChild(noBtn);
      if (node.same) btns.appendChild(makeButton('Roughly the Same','same',()=>goToNode(node.same)));
    } else if (node.type==='info'){
      if (node.id==='Q0'){ btns.appendChild(makeButton('Next','next',()=>goToNode(node.next))); btns.appendChild(makeButton('About','next',()=>goToNode('AB0'))); }
      else { btns.appendChild(makeButton('Next','next',()=>goToNode(node.next))); }
    }
  }
}

/* ====== END ====== */
</script>
</body>
</html>
