<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Discernment: A Decision-Making Guide</title>

<!-- 🔹 Preload the first-screen logo to avoid pop-in -->
<link rel="preload" as="image" href="./favicon_256_transparent.png">

<link rel="manifest" href="./site.webmanifest?v=4">
<meta name="theme-color" content="#ffffff">
<!-- 🔹 Address bar / browser UI color that follows system theme -->
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#0b0b0d" media="(prefers-color-scheme: dark)">

<!-- Icons -->
<link rel="icon" type="image/svg+xml" href="./favicon_transparent.svg">
<link rel="icon" type="image/png" sizes="16x16" href="./favicon_16_transparent.png">
<link rel="icon" type="image/png" sizes="32x32" href="./favicon_32_transparent.png">
<link rel="icon" type="image/png" sizes="48x48" href="./favicon_48_transparent.png">
<link rel="icon" type="image/png" sizes="64x64" href="./favicon_64_transparent.png">
<link rel="icon" type="image/png" sizes="192x192" href="./favicon_192_transparent.png">
<link rel="icon" type="image/png" sizes="256x256" href="./favicon_256_transparent.png">
<link rel="icon" type="image/png" sizes="384x384" href="./favicon_384_transparent.png">
<link rel="icon" type="image/png" sizes="512x512" href="./favicon_512_transparent.png">
<link rel="shortcut icon" href="./favicon_transparent.ico">

<!-- iOS homescreen -->
<link rel="apple-touch-icon" sizes="180x180" href="./favicon_180_transparent.png">

<style>
  :root {
    --btn-pad-y:10px; --btn-pad-x:12px;

    /* slider custom props */
    --track-height: 8px;
    --thumb-size: 28px;
    --thumb-shadow: 0 1px 3px rgba(0,0,0,.25);
    --track-bg: #e0e0e0;
    --fill: #2d6cdf;
    --pct: 0%;
    --tick-color: rgba(0,0,0,.35);
    --tick-thickness: 2px;
    --tick-length: 6px;
  }

  body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:0; }
  .container { max-width: 650px; margin:auto; padding:20px; }
  .top-bar { display:flex; justify-content:space-between; margin-bottom:10px; }
  .card {
    background:#fff; padding:20px; border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1); min-height:280px;
    display:flex; flex-direction:column; justify-content:space-between;
  }

  /* Header */
  .segment-heading {
    display:flex; align-items:center; justify-content:space-between;
    font-size:1.8em; font-weight:bold; margin-bottom:15px; padding:8px;
    border-bottom:2px solid #ddd; gap:12px; transition: color .5s ease;
  }
  .segment-title { display:inline-flex; align-items:center; gap:8px; }
  .segment-title img.logo {
    height:1.2em; width:auto; vertical-align:middle; margin-right:6px;
    aspect-ratio: 1 / 1;
  }
  .flash-gold { color: goldenrod !important; }
  .flash-green { color: #2e7d32 !important; }
  .flash-purple { color: #9C27B0 !important; }

  /* Buttons */
  button { flex:1; padding:var(--btn-pad-y) var(--btn-pad-x); font-size:1em; border:none; border-radius:5px; cursor:pointer; }
  button.yes { background:#4CAF50; color:#fff; }
  button.no { background:#F44336; color:#fff; }
  button.same { background:#1E88E5; color:#fff; }
  button.next { background:#2196F3; color:#fff; }
  button.back { background:#555; color:#fff; flex:0 0 auto; }
  button.restart { background:#9C27B0; color:#fff; flex:0 0 auto; }
  button.examples-btn, button.viz-btn, button.reasoning-btn { background:#9E9E9E; color:#fff; }
  .ctrl-btn { flex:1; }
  button.active { outline:2px solid #000; }

  .segment-heading .skip-btn {
    display:inline-flex; align-items:center; justify-content:center;
    flex:0 0 auto; padding:var(--btn-pad-y) var(--btn-pad-x);
    font-size:1rem; line-height:1; border:none; border-radius:5px; cursor:pointer;
    background:#e9e9e9; color:#333;
  }
  .segment-heading .skip-btn:hover { background:#dedede; }

  .text { font-size:1.3em; margin-bottom:12px; white-space:pre-wrap; }

  .controls-row { display:flex; gap:10px; margin:6px 0 18px 0; }
  .left-controls, .right-controls { flex:1; display:flex; gap:10px; }

  .panel {
    display:none; border:1px solid #eee; border-radius:6px; padding:10px; background:#fafafa;
    margin-bottom:18px;
  }
  .panel p { margin:6px 0; }
  .panel img { width:100%; height:auto; display:block; }

  .buttons { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start; }
  .buttons.center { justify-content:center; }

  /* Slider container */
  .risk-inline { display:none; border:1px solid #eee; border-radius:6px; padding:12px; background:#fafafa; margin:8px 0 18px 0; }
  .sev-display { text-align:center; font-size:1.8em; font-weight:bold; margin-bottom:8px; }
  .risk-row { display:flex; align-items:center; gap:10px; margin:0; }
  .risk-row input[type="range"] { width:100%; }
  .risk-ticks { display:block; width:100%; }

  .error { color:#B00020; font-size:0.95em; }

  /* === Slider visual customization === */
  .slider-wrap {
    position: relative;
    width: 100%;
    height: calc(var(--thumb-size) + var(--tick-length) * 2 + 8px);
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
    touch-action: pan-x;
  }
  .heat-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: var(--thumb-size);
    background: transparent;
    position: relative;
    z-index: 1;
  }
  .heat-slider::-webkit-slider-runnable-track {
    height: var(--track-height);
    border-radius: calc(var(--track-height) / 2);
    background:
      linear-gradient(to right,
        var(--fill) 0%,
        var(--fill) var(--pct),
        var(--track-bg) var(--pct),
        var(--track-bg) 100%);
  }
  .heat-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: var(--thumb-size);
    height: var(--thumb-size);
    border-radius: 50%;
    background: #fff;
    border: 2px solid #999;
    box-shadow: var(--thumb-shadow);
    margin-top: calc((var(--thumb-size) - var(--track-height)) / -2);
    cursor: pointer;
  }

  .tick-row {
    position: absolute;
    left: calc(var(--thumb-size) / 2);
    right: calc(var(--thumb-size) / 2);
    height: var(--tick-length);
    pointer-events: none;
    z-index: 0;
  }
  .tick-row.top { top: 50%; transform: translateY(calc(-50% - var(--track-height)/2 - 2px)); }
  .tick-row.bottom { top: 50%; transform: translateY(calc(-50% + var(--track-height)/2 + 2px)); }
  .tick { position: absolute; width: var(--tick-thickness); height: 100%; background: var(--tick-color); transform: translateX(-50%); }

  .heat-slider::-moz-range-track { height: var(--track-height); border-radius: calc(var(--track-height) / 2); background: var(--track-bg); }
  .heat-slider::-moz-range-progress { height: var(--track-height); border-radius: calc(var(--track-height) / 2); background: var(--fill); }
  .heat-slider::-moz-range-thumb { width: var(--thumb-size); height: var(--thumb-size); border-radius: 50%; background: #fff; border: 2px solid #999; box-shadow: var(--thumb-shadow); cursor: pointer; }
  .heat-slider::-ms-track { height: var(--track-height); border-color: transparent; color: transparent; background: transparent; }
  .heat-slider::-ms-fill-lower { background: var(--fill); border-radius: calc(var(--track-height)/2); }
  .heat-slider::-ms-fill-upper { background: var(--track-bg); border-radius: calc(var(--track-height)/2); }
  .heat-slider::-ms-thumb { width: var(--thumb-size); height: var(--thumb-size); border-radius: 50%; background: #fff; border:2px solid #999; box-shadow: var(--thumb-shadow); }
  
  /* ================================
     THEME TOKENS + OVERRIDES (added)
     ================================ */
  :root { color-scheme: light dark; }

  /* Light defaults */
  :root {
    --bg: #f7f7f7;
    --card: #ffffff;
    --text: #111111;
    --subtle-text: #333333;
    --border: #dddddd;
    --shadow: 0 2px 6px rgba(0,0,0,0.10);

    --btn-yes: #4CAF50;
    --btn-no: #F44336;
    --btn-same: #1E88E5;
    --btn-next: #2196F3;
    --btn-back: #555555;
    --btn-restart: #9C27B0;
    --btn-muted: #9E9E9E;
    --btn-text: #ffffff;

    --thumb-border: #999999;
    --tick-color: rgba(0,0,0,.35);
    --track-bg: #e0e0e0;

    --if-accent: #2e7d32;
    --when-accent: goldenrod;
    --result-accent: #9C27B0;
  }

  /* Dark overrides follow system */
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #0f1115;
      --card: #171a21;
      --text: #e9edf1;
      --subtle-text: #c7cbd2;
      --border: #2a2f3a;
      --shadow: 0 2px 6px rgba(0,0,0,0.35);

      --btn-yes: #4CAF50;
      --btn-no: #EF5350;
      --btn-same: #42A5F5;
      --btn-next: #42A5F5;
      --btn-back: #8e8e93;
      --btn-restart: #BA68C8;
      --btn-muted: #6c6f76;
      --btn-text: #ffffff;

      --thumb-border: #b5bcc8;
      --tick-color: rgba(255,255,255,.38);
      --track-bg: #2a2f3a;

      --if-accent: #5bd36a;
      --when-accent: #f1c24c;
      --result-accent: #c77dff;
    }
  }

  /* Manual override via data-theme (appears only if user toggles) */
  :root[data-theme="light"] { color-scheme: light; }
  :root[data-theme="dark"]  {
    color-scheme: dark;
    --bg: #0f1115; --card: #171a21; --text: #e9edf1; --subtle-text: #c7cbd2;
    --border: #2a2f3a; --shadow: 0 2px 6px rgba(0,0,0,0.35);
    --btn-yes: #4CAF50; --btn-no: #EF5350; --btn-same: #42A5F5; --btn-next: #42A5F5;
    --btn-back: #8e8e93; --btn-restart: #BA68C8; --btn-muted: #6c6f76; --btn-text: #ffffff;
    --thumb-border: #b5bcc8; --tick-color: rgba(255,255,255,.38); --track-bg: #2a2f3a;
    --if-accent: #5bd36a; --when-accent: #f1c24c; --result-accent: #c77dff;
  }

  /* Map existing components to tokens (non-destructive overrides) */
  body { background: var(--bg); color: var(--text); }
  .card {
    background: var(--card);
    color: var(--text);
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }
  .segment-heading { border-bottom: 2px solid var(--border); }
  .flash-gold  { color: var(--when-accent) !important; }
  .flash-green { color: var(--if-accent) !important; }
  .flash-purple{ color: var(--result-accent) !important; }

  .panel { background: color-mix(in oklab, var(--card), var(--bg) 8%); border:1px solid var(--border); }
  .risk-inline { background: color-mix(in oklab, var(--card), var(--bg) 8%); border:1px solid var(--border); }
  .tick { background: var(--tick-color); }
  .heat-slider::-webkit-slider-thumb { border: 2px solid var(--thumb-border); }
  .heat-slider::-moz-range-thumb { border: 2px solid var(--thumb-border); }
  .heat-slider::-ms-thumb { border: 2px solid var(--thumb-border); }

  .segment-heading .skip-btn {
    background: color-mix(in oklab, var(--card), var(--text) 12%);
    color: var(--subtle-text);
  }
  .segment-heading .skip-btn:hover {
    background: color-mix(in oklab, var(--card), var(--text) 20%);
  }

  /* Buttons pick up theme tokens */
  button { color: var(--btn-text); }
  button.yes      { background: var(--btn-yes); }
  button.no       { background: var(--btn-no); }
  button.same     { background: var(--btn-same); }
  button.next     { background: var(--btn-next); }
  button.back     { background: var(--btn-back); }
  button.restart  { background: var(--btn-restart); }
  button.examples-btn, button.viz-btn, button.reasoning-btn { background: var(--btn-muted); }
</style>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VJSYRKHSRM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-VJSYRKHSRM');
</script>
</head>
<body>
<div class="container">
  <div class="top-bar">
    <button class="back" id="backBtn" onclick="goBack()" type="button">Back</button>
    <!-- 🔹 Theme toggle (added). Only shown on Q0 via JS -->
    <button class="back" id="themeToggle" type="button" style="display:none;">Theme</button>
    <button class="restart" id="restartTop" onclick="restart()" type="button">Restart</button>
  </div>

  <div class="card">
    <div id="segmentHeading" class="segment-heading">
      <!-- 🔹 Render the logo in the initial HTML so it appears on first paint -->
      <span id="segmentTitle" class="segment-title">
        <img
          src="./favicon_256_transparent.png"
          alt="Discernment Logo"
          class="logo"
          width="256"
          height="256"
          loading="eager"
          fetchpriority="high"
          decoding="sync"
        >
        Discernment: A Decision-Making Guide
      </span>
      <button id="skipBtn" class="skip-btn" style="display:none;" title="Skip to When You Should Act" type="button">Skip ⏭</button>
    </div>

    <div>
      <div id="text" class="text"></div>

      <div class="controls-row">
        <div id="leftControlsWrapper" class="left-controls"></div>
        <div id="rightControlsWrapper" class="right-controls"></div>
      </div>

      <!-- Single shared panel for everything -->
      <div id="sharedPanel" class="panel" aria-hidden="true" role="region" aria-live="polite"></div>

      <!-- Slider area -->
      <div id="riskInline" class="risk-inline" aria-hidden="true"></div>

      <div id="errorBox" class="error" role="alert" aria-live="assertive"></div>
    </div>

    <div id="buttons" class="buttons"></div>
  </div>
</div>

<script>
/* ======= THEME INIT + TOGGLE (System → Dark → Light) ======= */
(function initTheme(){
  const root = document.documentElement;
  const themeBtn = document.getElementById('themeToggle');
  const mqDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');

  // Returns the saved setting, not the computed appearance.
  // 'system' means "follow OS" (no data-theme on :root).
  function getSetting() {
    const saved = localStorage.getItem('theme'); // 'light' | 'dark' | 'system' | null
    return (saved === 'light' || saved === 'dark' || saved === 'system') ? saved : 'system';
  }

  // Effective appearance (useful for choosing next label, etc.)
  function getEffectiveTheme(setting) {
    if (setting === 'dark') return 'dark';
    if (setting === 'light') return 'light';
    // system
    return (mqDark && mqDark.matches) ? 'dark' : 'light';
  }

  function applySetting(setting) {
    if (setting === 'system') {
      root.removeAttribute('data-theme');
      localStorage.setItem('theme', 'system');
    } else {
      root.dataset.theme = setting; // 'light' or 'dark'
      localStorage.setItem('theme', setting);
    }
    setButtonLabel(); // keep button text in sync
  }

  function setButtonLabel() {
    if (!themeBtn) return;
    const setting = getSetting();         // system | dark | light
    const effective = getEffectiveTheme(setting); // dark | light
    // Show the *setting* (System/Dark/Light), not just effective appearance
    const label = setting.charAt(0).toUpperCase() + setting.slice(1);
    themeBtn.textContent = 'Theme: ' + label;
    // Optional: tooltip shows current effective (useful when System follows OS)
    themeBtn.title = 'Effective: ' + (effective === 'dark' ? 'Dark' : 'Light');
  }

  // Initialize from saved (default to system)
  applySetting(getSetting());

  // Cycle order: System → Dark → Light → System
  if (themeBtn) {
    themeBtn.onclick = function(){
      const setting = getSetting();
      const next = (setting === 'system') ? 'dark' :
                   (setting === 'dark')   ? 'light' : 'system';
      applySetting(next);
    };
  }

  // If following system, update label on OS theme changes
  if (mqDark) {
    mqDark.addEventListener('change', () => {
      if (getSetting() === 'system') setButtonLabel();
    });
  }

  // Expose label refresh for when the button becomes visible on Q0
  window.__refreshThemeButtonLabel = setButtonLabel;
})();

/* ======= FLOW (Q0–Q47 + About) ======= */
var flowchart = [
  { "id": "Q0",  "type": "info", "text": "Welcome! This guide helps you determine both <i>IF</i> and <i>WHEN</i> you should act on an issue. This will help to avoid wasting resources and time, and getting stuck in <i>analysis paralysis</i>.\nYou’ll answer simple Yes/No questions (and a slider later). Answer everything to the best of your knowledge, and if you don't know something, do what you can to find out (once there aren't any other more important things to do).", "next": "Q1" },

  /* ===== IF YOU SHOULD ACT ===== */
  { "id": "Q1",  "type": "question", "text": "Are there any other more important things to do or think about right now?", "yes": "R1",  "no": "Q2" },
  { "id": "Q2",  "type": "question", "text": "Is there a current <i>real problem</i> or desired functional QoL (quality of life) improvement, rather than just a <i>“problem”</i> or preference that doesn’t affect performance or outcomes?", "yes": "Q10",  "no": "Q3" },
  { "id": "Q3",  "type": "question", "text": "Is there cause for a potential <i>real problem</i>, rather than just a <i>“problem”</i> that doesn’t affect performance or outcomes?", "yes": "Q5",  "no": "Q4" },
  { "id": "Q4",  "type": "question", "text": "Is there cause for a POTENTIAL cause for a POTENTIAL <i>real problem</i>, rather than just a <i>“problem”</i> that doesn’t affect performance or outcomes?", "yes": "Q5",  "no": "R2" },

  { "id": "Q5",  "type": "question", "text": "Is the potential problem inevitable if left unaddressed?", "yes": "Q10",  "no": "Q6" },

  /* ==== Q6 split into trio (cost-before, cost-after, total) ==== */
  { "id": "Q6",  "type": "question", "text": "Would the expected downsides of NOT addressing this issue outweigh the expected <i>upfront</i> costs/efforts OF addressing it (for just this instance)?", "yes": "Q7", "no": "Q20" },
  { "id": "Q7",  "type": "question", "text": "Would the expected downsides of NOT addressing this issue outweigh any negative consequences that would likely arise <i>as a result</i> OF addressing it (for just this instance)?", "yes": "Q8", "no": "Q20" },
  { "id": "Q8",  "type": "question", "text": "Would the overall downsides of NOT addressing this issue outweigh the <i>combined total</i> of both the upfront costs and any resulting downsides (for just this instance)?", "yes": "Q10", "no": "Q20", "same": "Q9" },

  /* (old Q7) */
  { "id": "Q9",  "type": "question", "text": "Is the problem more likely to occur than not if left unaddressed?", "yes": "Q10",  "no": "Q20" },

  /* continue with renumbered chain */
  { "id": "Q10", "type": "question", "text": "Is there a solution (or at least partial solution) to the problem/potential problem even if it’s currently unavailable (or a means of bringing about the QoL improvement)?", "yes": "Q11",  "no": "R4" },
  { "id": "Q11", "type": "question", "text": "Can this solution or QoL improvement be <i>guaranteed</i> to be fully brought about as a result of <i>your</i> influence?", "yes": "Q14", "no": "Q12" },
  { "id": "Q12", "type": "question", "text": "Do everything in your power first to achieve the desired result, but know that past that it’s out of your hands, and <i>worrying and obsessing won’t change anything and is unhealthy</i>. Is there anything further you can do?", "yes": "Q14", "no": "Q13" },
  { "id": "Q13", "type": "question", "text": "Is there an <i>alternative solution</i> that would solve the problem (or improve QoL) in a way that’s within your control or perhaps even in a <i>better overall way</i>?", "yes": "R5",  "no": "R2" },

  { "id": "Q14", "type": "question", "text": "Does this solution or QoL improvement involve gaining information that would be <i>valuable in the future</i>?", "yes": "Q15", "no": "Q16" },
  { "id": "Q15", "type": "question", "text": "Would the <i>information alone</i> gained from doing this outweigh the downsides it would likely cause to make this happen?", "yes": "Q31", "no": "Q16" },

  /* ==== Q14 split into trio (cost-before, cost-after, total) ==== */
  { "id": "Q16", "type": "question", "text": "Would the expected benefits of addressing this issue outweigh the expected <i>upfront</i> costs/efforts of addressing it (for just this instance)?", "yes": "Q17", "no": "Q20" },
  { "id": "Q17", "type": "question", "text": "Would the expected benefits of addressing this issue outweigh any negative consequences that would likely arise <i>as a result</i> of addressing it (for just this instance)?", "yes": "Q18", "no": "Q20" },
  { "id": "Q18", "type": "question", "text": "Would the overall benefits of addressing this issue outweigh the <i>combined total</i> of both the upfront costs and any resulting downsides (for just this instance)?", "yes": "Q22", "no": "Q20", "same": "Q19" },

  { "id": "Q19", "type": "question", "text": "All things considered, would you <i>rather</i> address it than not?", "yes": "Q22", "no": "Q20" },
  { "id": "Q20", "type": "question", "text": "Is there a time further down the road that the answer to the <i>previous question</i> could be yes?", "yes": "R3", "no": "Q21" },
  { "id": "Q21", "type": "question", "text": "Is there an <i>alternative solution</i> that would solve the problem (or improve QoL) in a way that’s worth it or perhaps even in a <i>better overall way</i>?", "yes": "R5",  "no": "R2" },

  { "id": "Q22", "type": "question", "text": "Does addressing this issue involve a <i>diminishing returns</i> curve for effort applied?", "yes": "Q23", "no": "Q24" },
  { "id": "Q23", "type": "info",     "text": "Find the <i>point of diminishing returns</i> and stop there. If you tend to get absorbed in an activity, find an alternative approach that solves the problem or improves QoL <i>without the addictive pull</i> and possibly even in a <i>better overall way</i>. Treat this approach as a \"better\", more effective overall solution, and <i>ALWAYS</i> use this approach over the original if it's available; if not, you may use the original approach if needed—but <i>only</i> with a pre-set time limit and timer, after which you must stop and re-evaluate.", "next": "Q24" },
  { "id": "Q24", "type": "question", "text": "Does addressing this issue directly involve an <i>inverted-U curve</i> for specific effort applied with an <i>objective sweet spot</i> where clear information is available to you?", "yes": "Q25", "no": "Q26" },
  { "id": "Q25", "type": "info",     "text": "Wait until there aren’t any other more important things to do, then if it’s worth it to you, find that <i>sweet spot</i>. If not, put in as much effort as you deem worth it.", "next": "Q31" },

  { "id": "Q26", "type": "question", "text": "In practice and given time, would a <i>functional difference</i>—like in a blind test compared side by side—likely be noticed if the issue was solved/addressed (assuming any potential future problems would occur)?", "yes": "Q27", "no": "R2" },
  { "id": "Q27", "type": "question", "text": "Would solving/addressing it help get rid of/prevent the problem (or improve QoL) in the <i>long term</i>?", "yes": "Q31", "no": "Q28" },
  { "id": "Q28", "type": "question", "text": "Would solving/addressing it help get rid of/prevent the problem (or improve QoL) in the <i>short term</i>?", "yes": "Q29", "no": "R2" },
  { "id": "Q29", "type": "question", "text": "Is it logically worth solving/addressing <i>EVERY time this situation arises</i>? (Or at least this time knowing it’s <i>temporary</i>?)", "yes": "Q31", "no": "Q30" },
  { "id": "Q30", "type": "question", "text": "Is there an <i>alternative solution</i> that would solve the problem (or improve QoL), in the long term or perhaps even in a <i>better overall way</i>?", "yes": "R5",  "no": "R2" },

  /* ===== WHEN YOU SHOULD ACT ===== */
  { "id": "Q31", "type": "question", "text": "Does this address a potential <i>future</i> problem?", "yes": "Q32", "no": "Q35" },
  { "id": "Q32", "type": "question", "text": "Does addressing this issue involve <i>preventative maintenance</i>?", "yes": "Q37", "no": "Q35" },

  /* Severity selection */
  { "id": "Q33", "type": "info",     "text": "Set the estimated catastrophic severity if you waited too long to act. (1-10)", "next": "Q34" },
  { "id": "Q34", "type": "question", "text": "Would there be <i>guaranteed clear telltale signs</i> of future functional failure before it actually happened, with a big enough window of time to address it properly in advance?", "yes": "Q46", "no": "Q47" },

  /* Availability / timing */
  { "id": "Q35", "type": "question", "text": "Is this the <i>most effective solution</i> you know of (that meets the previous criteria), assuming you could do it whenever you wanted?", "yes": "Q39", "no": "Q36" },
  { "id": "Q36", "type": "question", "text": "Have you considered <i>all better solutions</i> you know of?", "yes": "Q39", "no": "R5" },

  { "id": "Q37", "type": "question", "text": "Is this the <i>most effective solution</i> you know of (that meets the previous criteria)?", "yes": "Q33", "no": "Q38" },
  { "id": "Q38", "type": "question", "text": "Have you considered <i>all better solutions</i> you know of?", "yes": "Q33", "no": "R5" },

  { "id": "Q39", "type": "question", "text": "Is this solution <i>currently</i> available?", "yes": "Q40", "no": "Q41" },
  { "id": "Q40", "type": "question", "text": "Is there a <i>better time</i> down the road to solve/address this to <i>maximize value</i>?", "yes": "Q41", "no": "R7" },

  { "id": "Q41", "type": "question", "text": "Assuming you waited until it was available, would the expected <i>overall benefits</i> of using this solution outweigh the expected <i>overall downsides</i> of having to wait?", "yes": "Q44", "no": "Q43", "same": "Q42" },
  { "id": "Q42", "type": "question", "text": "All things considered, would you <i>rather</i> use this solution?", "yes": "Q44", "no": "Q43" },

  { "id": "Q43", "type": "question", "text": "Is there a <i>next best</i> solution you know of?", "yes": "R5",  "no": "R4" },
  { "id": "Q44", "type": "question", "text": "Is there a <i>better time</i> further down the road than when this solution is available to solve/address this to <i>maximize value</i>?", "yes": "R8",  "no": "R6" },
  { "id": "Q45", "type": "question", "text": "Is there a <i>better time</i> further down the road than at that time to solve/address this to <i>maximize value</i>?", "yes": "R8",  "no": "R6" },

  /* WHEN thresholds */
  { "id": "Q46", "type": "question", "text": "Normally you should solve/address it as soon as both of the following are true: <ul><li><i>Those telltale signs</i> indicate that failure is approaching.</li><li>The <i>estimated chance of failure</i> is nearing or greater than 50%.</li></ul>\nHowever, is there a <i>better time</i> before or after that time to solve/address this to <i>maximize value</i>?", "yes": "R8", "no": "R9" },
  { "id": "Q47", "type": "question", "text": "Normally you should solve/address it as soon as the <i>estimated chance of failure</i> is nearing or greater than 50%.\nHowever, is there a <i>better time</i> before or after that time to solve/address this to <i>maximize value</i>?", "yes": "R8", "no": "R9" },

  /* RESULTS */
  { "id": "R1",  "type": "result",   "text": "Worry about this <i>once those things are addressed</i> and the time is right." },
  { "id": "R2",  "type": "result",   "text": "<i>Don’t worry about it:)</i>" },
  { "id": "R3",  "type": "result",   "text": "If that time ever does come, re-evaluate the issue. Until then, (once there aren't any other more important things to do), consider any other solutions that could work and be worth it, or perhaps even be <i>better overall<i/>." },
  { "id": "R4",  "type": "result",   "text": "Wait until there aren’t any other more important things to do, then if it’s worth it to you, <i>find a solution or solutions</i>. If not, put in as much effort as you deem worth it." },
  { "id": "R5",  "type": "result",   "text": "Consider any other solutions, from best to worst, if you haven’t already. Run them through the chart." },
  { "id": "R6",  "type": "result",   "text": "Wait until this solution is available, then solve it once there aren’t any other more important things to do. Until then, (once there aren't any other more important things to do, and if you'd like), consider any other solutions that could also work and be worth it." },
  { "id": "R7",  "type": "result",   "text": "Address it <i>sooner than later</i>, once there aren’t any other more important things to do." },
  { "id": "R8",  "type": "result",   "text": "Wait until that better time, then solve/address it once there aren't any other more important things to do. Until then, (once there aren't any other more important things to do, and if  you'd like), consider any other solutions that could either also work and be worth it, or—in the case of preventative maintenance—mitigate consequences if failure did occur." },
  { "id": "R9",  "type": "result",   "text": "Solve/address it as soon as the criteria from the <i>previous slide</i> (before the question) are met, once there aren’t any other more important things to do. Until then, (once there aren't any other more important things to do, and if you'd like), consider any solutions that would mitigate consequences if failure did occur." },

  /* ===== ABOUT MENU + PAGES ===== */
  { "id": "AB0", "type": "aboutMenu", "heading": "About", "text": "Choose a section to learn more about the guide and its background." },
  { "id": "AB1", "type": "about", "heading": "About Me", "text": "Hi! My name is Packer, I’m the creator of this guide. I've had OCD for as long as I can remember, and one of the hardest things for me is knowing whether or not I should worry about or address something, which led me to create this guide over the course of a year and a half—molded from many, <i>many</i> mistakes in my actions. It's not about being content with imperfection, or striving to make everything perfect, but rather about <i>discerning</i> what to do (or not do), and when to do it. This guide aims to help others make decisions, regardless of if they suffer from OCD, anxiety, or not, as the logic it uses can be applied to all areas of life.\n\nTo contact or support me, I'm reachable at:\npackerander22@gmail.com" },
  { "id": "AB2", "type": "about", "heading": "Guide Concepts Explained", "text": "<p>This guide is built to prevent wasted effort, “analysis paralysis,” and unhealthy worry, by walking through the two essential questions of decision-making: <b>Should I act?</b> (IF) and <b>When should I act?</b> (WHEN). Along the way, it uses concepts from psychology, economics, and systems thinking. Below is a deep dive into each principle.</p><h3>1. Real Problems vs. Cosmetic Problems</h3><p>Not every “problem” is a <i>real</i> problem.</p><ul><li><b>Real problems</b> affect functionality, outcomes, or safety.</li><li><b>Cosmetic or preference problems</b> only affect comfort, appearance, or personal taste.</li></ul><p><b>Why it matters:</b> By distinguishing real issues from cosmetic ones, you avoid spending time and energy on things that don’t change results in a meaningful way.</p><h3>2. Potential vs. Inevitable Problems</h3><p>A potential problem may or may not happen. An inevitable problem <i>will</i> happen if ignored.</p><ul><li>Example: a frayed charging cable is <i>inevitably</i> going to fail.</li><li>Example: a squeaky door hinge <i>might</i> get worse, but may never actually break.</li></ul><p><b>Why it matters:</b> If something is inevitable, addressing it early usually prevents bigger costs later.</p><h3>3. Costs vs. Benefits</h3><p>Every action carries a trade-off:</p><ul><li><b>Upfront costs/efforts:</b> time, money, energy you invest to act.</li><li><b>Resulting downsides:</b> new risks or hassles created by the fix itself.</li><li><b>Combined total:</b> both categories together, measured against what happens if you do nothing.</li></ul><p><b>Why it matters:</b> You should only act if the combined downsides of doing nothing outweigh the costs and downsides of acting.</p><h3>4. Alternative Solutions</h3><p>Sometimes the first idea isn’t the best. If one option is blocked, unavailable, or costly, there may be:</p><ul><li>A simpler fix</li><li>A substitute method</li><li>A better long-term solution</li></ul><p><b>Why it matters:</b> Alternatives may solve the problem with fewer downsides or even provide extra benefits you hadn’t considered.</p><h3>5. Information Value</h3><p>Not all outcomes are measured in fixes — sometimes <i>knowledge itself</i> is the payoff.</p><ul><li>Example: Testing two study methods teaches you which is better, even if the test costs a little time.</li></ul><p><b>Why it matters:</b> Information can make future decisions faster, cheaper, and more effective.</p><h3>6. Diminishing Returns</h3><p>Effort doesn’t always scale with results. Beyond a certain point, each extra unit of effort produces smaller and smaller improvements.</p><ul><li>Example: polishing an essay draft — the first edits remove major errors, but the 12th pass adds almost no improvement.</li></ul><p><b>Why it matters:</b> Once you hit the point of diminishing returns, it’s better to stop and move on. Over-investing wastes time and energy.</p><h3>7. Inverted-U Curve (Sweet Spot)</h3><p>Sometimes both <i>too little</i> and <i>too much</i> effort reduce results.</p><ul><li>Example: exercise intensity — too low does nothing, too high risks injury, but a middle zone maximizes fitness.</li></ul><p><b>Why it matters:</b> Finding the “sweet spot” of effort gives you the best balance of results without wasted energy or harm, and unlike diminishing returns, you're not chasing a realisticly unreachable perfection. Spending as much time, effort, or resources as you see fit in finding this sweet spot will only get you closer to it, and can therefore be justified.</p><h3>8. Functional Difference (Blind Test)</h3><p>A functional difference is one you could actually notice in a side-by-side comparison that matters for the intended purpose.</p><ul><li>Example: Upgrading headphones where sound clarity is <i>actually audible</i>, vs. buying ones that only look different.</li></ul><p><b>Why it matters:</b> This filters out irrelevant changes and focuses only on meaningful, functional improvements.</p><h3>9. Long-Term vs. Short-Term Benefits</h3><p>Some actions provide temporary relief; others solve problems for good.</p><ul><li><b>Short-term:</b> taking a painkiller.</li><li><b>Long-term:</b> fixing posture to prevent the pain.</li></ul><p><b>Why it matters:</b> Short-term fixes may be fine for temporary situations, but lasting solutions often justify greater investment.</p><h3>10. Always vs. Sometimes Worth It</h3><p>Some actions are universally worth it every time.</p><ul><li>Example: wearing a seatbelt.</li></ul><p>Other actions are conditional, depending on context.</p><p><b>Why it matters:</b> Universal actions can become habits (low effort, high safety), while conditional actions need thoughtful evaluation each time.</p><h3>11. Preventative Maintenance</h3><p>This is solving a problem <i>before it happens</i>.</p><ul><li>Example: changing oil to prevent engine damage.</li><li>Example: backing up files before a drive fails.</li></ul><p><b>Why it matters:</b> Preventative actions often cost less and are less disruptive than emergency fixes after failure.</p><h3>12. Severity and Thresholds</h3><p>Severity measures the <i>worst-case outcome</i> if failure happens. Thresholds define the acceptable risk level.</p><ul><li>If severity is high (life-threatening, catastrophic), you act sooner.</li><li>If severity is low (inconvenient but minor), you can wait longer.</li></ul><p><b>Why it matters:</b> Severity calibrates urgency. It prevents overreaction to small issues and underreaction to critical ones.</p><h3>13. Telltale Signs</h3><p>Many problems give warnings before failure:</p><ul><li>Example: brake squeal before pads wear out.</li><li>Example: storage full warning before data loss.</li></ul><p><b>Why it matters:</b> Recognizing telltale signs gives you a safe buffer to act, rather than rushing at the last second or acting too early.</p><h3>14. Timing and Availability</h3><p>Even if a solution exists, timing matters:</p><ul><li>Sometimes it’s best to wait for resources, discounts, or better conditions.</li><li>Other times, delay makes things worse.</li></ul><p><b>Why it matters:</b> Correct timing ensures maximum value from your investment of time and resources.</p><h3>15. Better Alternatives Down the Road</h3><p>Sometimes waiting enables a <i>next best</i> or superior solution.</p><ul><li>Example: holding off on buying a phone because a newer, significantly better model releases next month.</li></ul><p><b>Why it matters:</b> Strategic patience can yield better outcomes than rushing.</p><h3>16. Putting It All Together</h3><p>The guide’s structure reflects real-world decision logic:</p><ol><li>Is this a real or inevitable problem?</li><li>Do benefits outweigh costs?</li><li>Are alternatives better?</li><li>Is the solution functional and noticeable?</li><li>Where’s the sweet spot for effort?</li><li>What’s the severity and threshold?</li><li>Are there warning signs or better timing?</li></ol><p><b>Why it matters:</b> By layering these concepts, the guide prevents wasted energy and helps you make decisions that are both rational and sustainable.</p>" }
];

/* ===== EXAMPLES (two per question; no info or results) ===== */
window.examples = {
  "Q1":  ["Finish homework due tonight before reorganizing the closet.", "Call the dentist first if you’re in pain instead of tweaking your workout plan."],
  "Q2":  ["Laptop battery dies quickly during class; you need reliable runtime.", "Your shoe tread is worn and you slip when running on wet pavement."],
  "Q3":  ["Small coolant drip under the car might lead to overheating later.", "Recurring mild chest tightness during runs that’s trending worse."],
  "Q4":  ["A faint clicking in a hard drive on boot once this month.", "Occasional wobble in a chair leg that’s starting to loosen."],
  "Q5":  ["Unsealed wood deck will inevitably weather and crack without treatment.", "Frayed charging cable will eventually fail if kept in use."],
  "Q6":  ["Skipping a tetanus booster could mean a serious infection later vs. quick clinic visit now.", "Ignoring a leaky faucet risks mold and higher bills vs. a simple repair."],
  "Q7":  ["Upgrading firmware may mean brief downtime, but stops data corruption.", "Aligning car wheels takes time, but avoids uneven tire wear after."],
  "Q8":  ["Replacing a dangerously cracked phone screen beats cost + setup + short learning curve.", "Booking a medical evaluation now outweighs copay + scheduling hassle."],
  "Q9":  ["Unpatched server is more likely than not to get compromised over months.", "Bald tire is more likely than not to blow out on a highway trip."],
  "Q10": ["There’s a software update that fixes the crash you’re seeing.", "A waterproof spray exists to protect your suede shoes."],
  "Q11": ["You can directly set the thermostat schedule yourself.", "You can swap the noisy fan on your PC today."],
  "Q12": ["You can follow up with support once more before waiting.", "You can gather better measurements before concluding it’s out of your hands."],
  "Q13": ["Use a lint roller daily instead of buying a new couch cover.", "Switch to a simpler training plan that still builds endurance."],
  "Q14": ["Running a small pilot teaches you if the workflow scales.", "Testing two camera angles tells you what boosts watch time."],
  "Q15": ["Doing a small A/B test is worth it just for the learning.", "Exploring a new note system is useful knowledge even if you keep the old one."],
  "Q16": ["Replacing air filter improves HVAC and is cheap/quick.", "Organizing your tool drawer speeds every repair you do."],
  "Q17": ["Changing to ergonomic keyboard helps wrists despite brief adjustment.", "Moving files to a sane folder system beats the re-indexing hassle."],
  "Q18": ["Buying earplugs for sleep beats cost + carrying them + brief adaptation.", "Installing a password manager beats subscription + setup time."],
  "Q19": ["You’d rather meal-prep Sundays than eat randomly all week.", "You’d rather patch the jacket now than buy a new one later."],
  "Q20": ["Wait to buy winter tires until temperatures reliably drop.", "Postpone the camera upgrade until your next paid shoot."],
  "Q21": ["Borrow a neighbor’s specialty tool instead of buying one.", "Use public transit route that’s nearly as fast and much cheaper."],
  "Q22": ["Editing a video: each extra pass improves less and less.", "Polishing a resume: beyond a few rounds, gains are tiny."],
  "Q24": ["Strength training: too light or too heavy both underperform; there’s a sweet spot.", "Caffeine: too little or too much is worse than a moderate dose."],
  "Q26": ["Switching to noise-isolating tips yields clearly clearer audio in a blind test.", "Adding under-desk lighting makes reading small labels noticeably easier."],
  "Q27": ["Sealing the driveway prevents cracks for years.", "Setting up automatic cloud backups prevents permanent data loss."],
  "Q28": ["Ice ankle now to reduce swelling even if full recovery takes longer.", "Use a temporary phone battery case for this weekend event."],
  "Q29": ["Wiping counters after each meal is always worth it.", "Running antivirus when a new USB is used is always worth it."],
  "Q30": ["Use pre-cut veggies service instead of spending hours chopping.", "Switch to a simpler CMS that meets needs with fewer headaches."],
  "Q31": ["Replace the washing machine hose before it bursts.", "Get a dental night guard to prevent grinding damage."],
  "Q32": ["Oil changes at the recommended interval.", "Descaling the espresso machine on schedule."],
  "Q33": ["If a brake failure would be catastrophic, set a higher severity; if a sticky cabinet hinge would be minor, set a low severity.", "For data loss on your main work laptop, pick higher severity; for a dead light bulb in a spare room, pick lower severity."],
  "Q34": ["Brake pad sensor squeal gives plenty of warning before rotor damage.", "Battery health app alerts you before the phone shuts off randomly."],
  "Q35": ["This sanding method gives the best finish among what you know.", "This study technique retains more than your alternatives."],
  "Q36": ["You compared spaced-repetition vs. rereading.", "You evaluated vinegar soak vs. descaling solution."],
  "Q37": ["Of all fixes, replacing the gasket stops the leak best.", "Of all methods, this interval plan builds speed most reliably."],
  "Q38": ["You checked if a pro service does it better for less net cost.", "You considered switching brands with better reliability."],
  "Q39": ["The repair kit is in stock today.", "Your mentor is free for a coaching session now."],
  "Q40": ["Booking during off-season lowers cost and stress.", "Doing it after your finals yields better focus."],
  "Q41": ["Waiting 2 weeks for the sale saves enough to justify the delay.", "Holding off until the skilled friend can help beats rushing today."],
  "Q42": ["You’d rather take the evening class even if self-study is possible now.", "You’d rather buy once-cry-once than patch a stopgap twice."],
  "Q43": ["Use the library’s 3D printer while you wait for parts.", "Try a nearby clinic that can see you tomorrow morning."],
  "Q44": ["Do yard work in spring for best results instead of winter now.", "Schedule the upgrade after the current project ships."],
  "Q45": ["Push the long trip until after the car service appointment.", "Delay filming until the new lights arrive next week."],
  "Q46": ["Replace the bike chain when stretch indicator hits the mark and creaks start.", "Service the A/C when airflow drops and pressure readings trend bad."],
  "Q47": ["Replace smoke alarm batteries when failure probability approaches your set threshold.", "Swap the UPS battery when charge-holding dips near your limit."]
};

/* ===== Special threshold-based examples for Q46/Q47 at extremes ===== */
window.examplesThreshold = {
  "Q46": {
    "0": [
      "Replace safety-critical parts at the first reliable warning—don’t wait for higher odds.",
      "Schedule service immediately if early signs appear and you treat any chance of failure as unacceptable."
    ],
    "90": [
      "Hold until clear warning signs stack up to near-certain failure, then act promptly.",
      "Plan replacement when indicators are overwhelmingly pointing to imminent failure."
    ]
  },
  "Q47": {
    "0": [
      "Change smoke-alarm batteries now if you’d lose sleep over even a tiny failure risk.",
      "Replace a worn climbing sling immediately if any fraying makes you uneasy."
    ],
    "90": [
      "Wait until the battery barely holds charge, then replace before it dies unpredictably.",
      "Run shoes until cushioning is clearly shot, then swap just before the next big run."
    ]
  }
};

/* ======= STATE ======= */
var currentThresholdPct = 90;
var q6TrioTotalYes = false; /* track if Q8 (third of Q6 trio) was YES */
var q9WasYes = false;       /* track if Q9 (inevitability) was YES */
var hasFlashedIf = false;
var hasFlashedWhen = false;
var lastWasResult = false;
var originalTitleHTML = null;

/* ======= APP LOGIC ======= */
var historyStack = [];
var currentNode = flowchart.find(function(n){ return n.id === "Q0"; });
var currentSegment = "If You Should Act";

function getSegmentForNodeId(id) {
  if (!id || id.charAt(0) !== 'Q') return currentSegment;
  var m = /^Q(\d+)$/.exec(id);
  if (!m) return currentSegment;
  var num = parseInt(m[1], 10);
  return num >= 31 ? "When You Should Act" : "If You Should Act";
}

/* Verdict/custom heading */
function setHeadingText(node) {
  var title = document.getElementById('segmentTitle');
  var skipBtn = document.getElementById('skipBtn');

  if (!node) { title.textContent = ''; skipBtn.style.display='none'; return; }

  // Custom headings for About pages
  if ((node.type === 'about' || node.type === 'aboutMenu') && node.heading) {
    title.textContent = node.heading;
    skipBtn.style.display = 'none';
    return;
  }

  if (node.id === 'Q0') {
    if (originalTitleHTML) title.innerHTML = originalTitleHTML;
    skipBtn.style.display = 'none';
    return;
  }

  if (node.type === 'result') {
    title.textContent = "👍👎 Verdict";
    skipBtn.style.display = 'none';
    return;
  }

  var segText = (currentSegment === "If You Should Act")
    ? "⚖️ If You Should Act"
    : "⏳ When You Should Act";

  title.textContent = segText;
  skipBtn.style.display = (currentSegment === "If You Should Act" && node.type !== 'result')
    ? 'inline-block'
    : 'none';
}

/* Flash */
function flashHeadingColor(targetSegment, node) {
  if (currentNode && currentNode.id === 'Q0') return;
  var headingDiv = document.getElementById('segmentHeading');

  if (node && node.type === 'result') {
    headingDiv.classList.add('flash-purple');
    setTimeout(function(){ headingDiv.classList.remove('flash-purple'); }, 1500);
    return;
  }
  var cls = (targetSegment === "If You Should Act") ? 'flash-green' : 'flash-gold';
  headingDiv.classList.add(cls);
  setTimeout(function(){ headingDiv.classList.remove(cls); }, 1500);
}

/* Close panel when changing screens */
function closeAllPanels() {
  collapseSharedPanel();
  var risk = document.getElementById('riskInline');
  if (risk) {
    risk.style.display = 'none';
    risk.setAttribute('aria-hidden','true');
  }
}

/* Auto-skip logic */
function beforeEnterNode(nextId) {
  if (nextId === 'Q16' && (q6TrioTotalYes || q9WasYes)) {
    /* Skip entire Q16–Q18 trio straight to Q22 */
    return 'Q22';
  }
  return nextId;
}

/* Threshold transformers for Q46/Q47 */
function transformQ46(html) {
  if (currentThresholdPct <= 0) {
    var listBlockRe = /:\s*<ul>[\s\S]*?<\/ul>/i;
    return html.replace(listBlockRe, ' there is even a <i>SMALL</i> chance of failure.');
  }
  return html.replace(/(?:nearing\s+or\s+greater\s*than\s*)?50%/gi, 'nearing or greater than ' + String(currentThresholdPct) + '%');
}
function transformQ47(html) {
  if (currentThresholdPct <= 0) {
    var probClauseRe = /the\s*<i>estimated\s+chance\s+of\s+failure<\/i>\s+is\s+nearing\s+or\s+greater\s+than\s*50%/i;
    return html.replace(probClauseRe, 'there is even a <i>SMALL</i> chance of failure');
  }
  return html.replace(/(?:nearing\s+or\s+greater\s*than\s*)?50%/gi, 'nearing or greater than ' + String(currentThresholdPct) + '%');
}

/* Slider color helpers */
function heatColorForSeverity(sev) {
  var ratio = Math.pow((sev - 1) / 9, 0.4);
  var hue = 220 * (1 - ratio);
  return 'hsl(' + Math.round(hue) + ', 100%, 50%)';
}
function updateSliderFill(slider, sev) {
  var pct = ((sev - 1) / 9) * 100;
  slider.style.setProperty('--pct', pct + '%');
  slider.style.setProperty('--fill', heatColorForSeverity(sev));
}

/* Shared panel */
function collapseSharedPanel() {
  var panel = document.getElementById('sharedPanel');
  if (panel) {
    panel.style.display = 'none';
    panel.setAttribute('aria-hidden','true');
    panel.dataset.mode = '';
    panel.innerHTML = '';
  }
  var leftWrap  = document.getElementById('leftControlsWrapper');
  var rightWrap = document.getElementById('rightControlsWrapper');

  if (leftWrap) {
    var exBtns = leftWrap.querySelectorAll('.examples-btn');
    for (var i=0;i<exBtns.length;i++) {
      exBtns[i].textContent = 'Show Examples';
      exBtns[i].setAttribute('aria-expanded','false');
      exBtns[i].classList.remove('active');
    }
  }
  if (rightWrap) {
    var rBtns = rightWrap.querySelectorAll('.viz-btn, .reasoning-btn');
    for (var j=0;j<rBtns.length;j++) {
      var btn = rBtns[j];
      if (btn.classList.contains('viz-btn')) btn.textContent = 'Show Visualization';
      if (btn.classList.contains('reasoning-btn')) btn.textContent = 'Show Percentage Reasoning';
      btn.setAttribute('aria-expanded','false');
      btn.classList.remove('active');
    }
  }
}

function openSharedPanel(panel, mode) {
  if (!panel) return;
  panel.style.display = 'block';
  panel.setAttribute('aria-hidden','false');
  panel.dataset.mode = mode;

  var leftWrap  = document.getElementById('leftControlsWrapper');
  var rightWrap = document.getElementById('rightControlsWrapper');
  var exBtn = leftWrap ? leftWrap.querySelector('.examples-btn') : null;
  var vzBtn = rightWrap ? rightWrap.querySelector('.viz-btn') : null;
  var rsBtn = rightWrap ? rightWrap.querySelector('.reasoning-btn') : null;

  if (mode === 'examples') {
    if (exBtn) exBtn.textContent = 'Hide Examples';
    if (vzBtn) vzBtn.textContent = 'Show Visualization';
    if (rsBtn) rsBtn.textContent = 'Show Percentage Reasoning';
  } else if (mode === 'viz') {
    if (vzBtn) vzBtn.textContent = 'Hide Visualization';
    if (exBtn) exBtn.textContent = 'Show Examples';
  } else if (mode === 'reason') {
    if (rsBtn) rsBtn.textContent = 'Hide Percentage Reasoning';
    if (exBtn) exBtn.textContent = 'Show Examples';
  }
}

/* ---------- Controls under the text ---------- */
function setupAuxToggles(node) {
  var leftWrap = document.getElementById('leftControlsWrapper');
  var rightWrap = document.getElementById('rightControlsWrapper');
  var panel = document.getElementById('sharedPanel');

  leftWrap.innerHTML = '';
  rightWrap.innerHTML = '';
  collapseSharedPanel();

  // ✅ Show aux controls for questions, and ALSO for Q33 specifically
  var allowAux = (node.type === 'question') || (node.id === 'Q33');
  if (!allowAux) return;

  // LEFT: Examples (always for allowed nodes)
  var examplesBtn = document.createElement('button');
  examplesBtn.type = 'button';
  examplesBtn.textContent = 'Show Examples';
  examplesBtn.className = 'examples-btn ctrl-btn';
  examplesBtn.setAttribute('aria-expanded', 'false');
  leftWrap.appendChild(examplesBtn);

  examplesBtn.onclick = function() {
    var isOpenExamples = panel.style.display === 'block' && panel.dataset.mode === 'examples';
    if (isOpenExamples) {
      collapseSharedPanel();
    } else {
      panel.innerHTML = '';
      renderExamples(panel, node.id);
      openSharedPanel(panel, 'examples');
      examplesBtn.setAttribute('aria-expanded','true');
      examplesBtn.classList.add('active');
    }
  };

  // RIGHT: Only one graph/logic button per applicable slide
  if (node.id === 'Q22' || node.id === 'Q24') {
    var vizBtn = document.createElement('button');
    vizBtn.type = 'button';
    vizBtn.textContent = 'Show Visualization';
    vizBtn.className = 'viz-btn ctrl-btn';
    vizBtn.setAttribute('aria-expanded', 'false');
    rightWrap.appendChild(vizBtn);

    vizBtn.onclick = function() {
      var isOpenViz = panel.style.display === 'block' && panel.dataset.mode === 'viz';
      var src = node.id === 'Q22' ? './diminishing_returns_curve.png' : './inverted_u_curve.png';
      var alt = node.id === 'Q22'
        ? 'Diminishing Returns Curve: Effort/Resources vs Functional Results'
        : 'Inverted-U Curve: Effort/Resources vs Functional Results';
      if (isOpenViz) {
        collapseSharedPanel();
      } else {
        panel.innerHTML = '';
        renderViz(panel, src, alt);
        openSharedPanel(panel, 'viz');
        vizBtn.setAttribute('aria-expanded','true');
        vizBtn.classList.add('active');
      }
    };
  } else if (node.id === 'Q46' || node.id === 'Q47') {
    var reasonBtn = document.createElement('button');
    reasonBtn.type = 'button';
    reasonBtn.textContent = 'Show Percentage Reasoning';
    reasonBtn.className = 'reasoning-btn ctrl-btn';
    reasonBtn.setAttribute('aria-expanded','false');
    rightWrap.appendChild(reasonBtn);

    reasonBtn.onclick = function() {
      var isOpenReason = panel.style.display === 'block' && panel.dataset.mode === 'reason';
      if (isOpenReason) {
        collapseSharedPanel();
      } else {
        panel.innerHTML = '';
        var p = document.createElement('p');
        p.textContent = 'Your current threshold is ' + currentThresholdPct + '%.';
        panel.appendChild(p);
        var img = document.createElement('img');
        img.src = './linear_threshold_chart.png';
        img.alt = 'Linear Severity to Action Threshold: Threshold = 100% − (Severity × 10%)';
        panel.appendChild(img);

        openSharedPanel(panel, 'reason');
        reasonBtn.setAttribute('aria-expanded','true');
        reasonBtn.classList.add('active');
      }
    };
  }
}

function renderExamples(panel, nodeId) {
  panel.innerHTML = '';
  let lines = null;

  // ✅ Only override examples for Q46 and Q47 at extremes, based on CURRENT threshold when opened
  if ((nodeId === "Q46" || nodeId === "Q47") && window.examplesThreshold && window.examplesThreshold[nodeId]) {
    if (currentThresholdPct <= 0 && window.examplesThreshold[nodeId]["0"]) {
      lines = window.examplesThreshold[nodeId]["0"];
    } else if (currentThresholdPct >= 90 && window.examplesThreshold[nodeId]["90"]) {
      lines = window.examplesThreshold[nodeId]["90"];
    }
  }

  // Fallback to the normal examples (includes Q33’s pair)
  if (!lines) {
    lines = (window.examples && window.examples[nodeId]) || ["Example 1: [edit me]", "Example 2: [edit me]"];
  }

  for (var i=0;i<lines.length;i++) {
    var p = document.createElement('p');
    p.textContent = lines[i];
    panel.appendChild(p);
  }
}

function renderViz(panel, src, alt) {
  panel.innerHTML = '';
  var img = document.createElement('img'); img.src = src; img.alt = alt;
  panel.appendChild(img);
}

/* ---------- Q33 slider with haptics, heat fill, and OUTSIDE ticks ---------- */
var lastVibeTs = 0;
function hapticBump() {
  if (!('vibrate' in navigator)) return;
  var mq = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)');
  if (mq && mq.matches) return;

  var now = Date.now();
  if (now - lastVibeTs < 80) return;
  navigator.vibrate(10);
  lastVibeTs = now;
}

function createTickRow(className, parent) {
  var row = document.createElement('div');
  row.className = 'tick-row ' + className;
  for (var i=1;i<=10;i++){
    var tick = document.createElement('div');
    tick.className = 'tick';
    var pct = ((i - 1) / 9) * 100;
    tick.style.left = pct + '%';
    row.appendChild(tick);
  }
  parent.appendChild(row);
  return row;
}

function showOrHideRiskInline(node) {
  var container = document.getElementById('riskInline');
  container.innerHTML = '';
  if (!node || node.id !== 'Q33') {
    container.style.display = 'none';
    container.setAttribute('aria-hidden','true');
    return;
  }
  container.style.display = 'block';
  container.setAttribute('aria-hidden','false');

  var sevDisplay = document.createElement('div');
  sevDisplay.className = 'sev-display';
  sevDisplay.id = 'sevDisplay';
  sevDisplay.textContent = '1';
  container.appendChild(sevDisplay);

  var row = document.createElement('div'); row.className = 'risk-row';

  var wrap = document.createElement('div');
  wrap.className = 'slider-wrap';

  var slider = document.createElement('input');
  slider.type = 'range'; slider.min = '1'; slider.max = '10'; slider.step = '1';
  slider.className = 'heat-slider';
  slider.setAttribute('list','riskTicks');
  slider.value = '1';

  createTickRow('top', wrap);
  wrap.appendChild(slider);
  createTickRow('bottom', wrap);

  row.appendChild(wrap);
  container.appendChild(row);

  var ticks = document.createElement('datalist');
  ticks.id = 'riskTicks';
  for (var i=1;i<=10;i++){ var opt=document.createElement('option'); opt.value=String(i); ticks.appendChild(opt); }
  container.appendChild(ticks);

  function applyFromSeverity(sev) {
    var thr = 100 - sev * 10;
    currentThresholdPct = thr;
    sevDisplay.textContent = String(sev);
    updateSliderFill(slider, sev);

    if (currentNode && (currentNode.id === 'Q46' || currentNode.id === 'Q47')) {
      var textDiv = document.getElementById('text');
      var html = currentNode.text || '';
      html = currentNode.id === 'Q46' ? transformQ46(html) : transformQ47(html);
      textDiv.innerHTML = '<div class="result-text">' + html + '</div>';
    }
  }

  applyFromSeverity(1);

  slider.oninput = function() {
    var sev = parseInt(slider.value, 10);
    applyFromSeverity(sev);
    hapticBump();
  };
}

/* ---------- Nav ---------- */
function makeButton(label, cls, action) {
  var btn = document.createElement('button');
  btn.type = 'button';
  btn.textContent = label; btn.className = cls; btn.onclick = action; return btn;
}
function goToNode(id) {
  closeAllPanels();

  /* track Q8 (third of Q6 trio) YES */
  if (currentNode && currentNode.id === 'Q8' && id === currentNode.yes) {
    q6TrioTotalYes = true;
  }
  /* track Q9 YES (old Q7 inevitability) */
  if (currentNode && currentNode.id === 'Q9' && id === currentNode.yes) {
    q9WasYes = true;
  }

  var adjustedId = beforeEnterNode(id);
  var next = flowchart.find(function(n){ return n.id === adjustedId; });
  historyStack.push(currentNode ? currentNode.id : '');
  currentNode = next; renderNode(currentNode);
}
function goBack() {
  closeAllPanels();
  var prevId = historyStack.pop();
  var prev = flowchart.find(function(n){ return n.id === prevId; });
  currentNode = prev || currentNode; renderNode(currentNode);
}
function restart() {
  closeAllPanels();
  historyStack = [];
  currentSegment = "If You Should Act";
  currentNode = flowchart.find(function(n){ return n.id === "Q0"; });
  q6TrioTotalYes = false;
  q9WasYes = false;
  hasFlashedIf = false;
  hasFlashedWhen = false;
  lastWasResult = false;

  // Restore header before render
  if (originalTitleHTML) {
    document.getElementById('segmentTitle').innerHTML = originalTitleHTML;
    document.getElementById('skipBtn').style.display = 'none';
  }

  renderNode(currentNode);
}

/* Skip to first WHEN screen (Q31) */
document.getElementById('skipBtn').addEventListener('click', function() {
  closeAllPanels();
  goToNode('Q31');
});

/* ---------- Render ---------- */
/* Initial capture of original header HTML */
if (!originalTitleHTML) {
  originalTitleHTML = document.getElementById('segmentTitle').innerHTML;
}
renderNode(currentNode);

function renderNode(node) {
  closeAllPanels();

  var errorBox = document.getElementById('errorBox');
  errorBox.textContent = '';

  if (!node) {
    errorBox.textContent = "Error: Could not render this step (missing node). Check JSON IDs and links.";
    document.getElementById('text').textContent = '';
    document.getElementById('buttons').innerHTML = '';
    setHeadingText('');
    document.getElementById('backBtn').style.visibility = historyStack.length > 0 ? 'visible' : 'hidden';
    document.getElementById('restartTop').style.display = 'inline-block';
    return;
  }

  if (node.id === 'Q0') {
    hasFlashedIf = false;
  }

  var previousSegment = currentSegment;
  var thisSegment = (node.type === 'about' || node.type === 'aboutMenu')
    ? previousSegment
    : getSegmentForNodeId(node.id);

  /* Force a re-flash of IF/WHEN after any result screen */
  var comingFromResult = lastWasResult && node.type !== 'result';

  var shouldFlash =
    node.id !== 'Q0' && (
      node.type === 'result' ||
      comingFromResult ||
      thisSegment !== previousSegment ||
      (thisSegment === "If You Should Act" && !hasFlashedIf) ||
      (thisSegment === "When You Should Act" && !hasFlashedWhen)
    );

  if (shouldFlash && !(node.type === 'about' || node.type === 'aboutMenu')) {
    flashHeadingColor(thisSegment, node);
    if (thisSegment === "If You Should Act") hasFlashedIf = true;
    if (thisSegment === "When You Should Act") hasFlashedWhen = true;
  }

  currentSegment = thisSegment;
  setHeadingText(node);

  /* Track whether this node is a result to drive next flash behavior */
  lastWasResult = (node.type === 'result');

  var textDiv = document.getElementById('text');
  var displayHTML = node.text || '';
  if (node.id === 'Q46') {
    displayHTML = transformQ46(displayHTML);
    textDiv.innerHTML = '<div class="result-text">' + displayHTML + '</div>';
  } else if (node.id === 'Q47') {
    displayHTML = transformQ47(displayHTML);
    textDiv.innerHTML = '<div class="result-text">' + displayHTML + '</div>';
  } else {
    textDiv.innerHTML = displayHTML;
  }

  // 🔹 Show the Theme toggle only on Q0 and refresh its label to the current effective theme
  var themeBtn = document.getElementById('themeToggle');
  if (themeBtn) {
    themeBtn.style.display = (node.id === 'Q0') ? 'inline-block' : 'none';
    if (node.id === 'Q0' && typeof window.__refreshThemeButtonLabel === 'function') {
      window.__refreshThemeButtonLabel();
    }
  }

  document.getElementById('backBtn').style.visibility = historyStack.length > 0 ? 'visible' : 'hidden';

  setupAuxToggles(node);
  showOrHideRiskInline(node);

  var btns = document.getElementById('buttons');
  btns.innerHTML = '';

  const restartTop = document.getElementById('restartTop');

  if (node.type === 'result') {
    restartTop.style.display = 'none';
    btns.classList.add('center');
    const restartCentered = makeButton('Restart', 'restart', () => restart());
    restartCentered.style.flex = '0 0 auto';
    btns.appendChild(restartCentered);
  } else {
    restartTop.style.display = (node.id === 'Q0') ? 'none' : 'inline-block';
    btns.classList.remove('center');

    /* ABOUT pages: no bottom buttons (just header + text) */
    if (node.type === 'about') {
      return;
    }

    /* ABOUT menu: show two nav buttons */
    if (node.type === 'aboutMenu') {
      btns.appendChild(makeButton('About Me', 'next', () => goToNode('AB1')));
      btns.appendChild(makeButton('Guide Concepts Explained', 'next', () => goToNode('AB2')));
      return;
    }

    if (node.type === 'question') {
      const yesBtn = makeButton('Yes', 'yes', () => goToNode(node.yes));
      const noBtn  = makeButton('No',  'no',  () => goToNode(node.no));
      btns.appendChild(yesBtn);
      btns.appendChild(noBtn);
      if (node.same) btns.appendChild(makeButton('Roughly the Same', 'same', () => goToNode(node.same)));
    } else if (node.type === 'info') {
      // First screen gets Next + About
      if (node.id === 'Q0') {
        btns.appendChild(makeButton('Next', 'next', () => goToNode(node.next)));
        btns.appendChild(makeButton('About', 'next', () => goToNode('AB0')));
      } else {
        btns.appendChild(makeButton('Next', 'next', () => goToNode(node.next)));
      }
    }
  }
}

/* Initial render */
renderNode(currentNode);
</script>
</body>
</html>